<html>
<head> <title>Spiderutils.py</title></head>
<body bgcolor="#ffffff">
<pre><font face="Lucida,Courier New"><font color="#FF0000"># Spider Python Library
</font><font color="#FF0000"># Copyright (C) 2006  Health Research Inc.
</font><font color="#FF0000">#
</font><font color="#FF0000"># HEALTH RESEARCH INCORPORATED (HRI),
</font><font color="#FF0000"># ONE UNIVERSITY PLACE, RENSSELAER, NY 12144-3455
</font><font color="#FF0000">#
</font><font color="#FF0000"># Email:  spider@wadsworth.org
</font><font color="#FF0000">#
</font><font color="#FF0000"># This program is free software; you can redistribute it and/or
</font><font color="#FF0000"># modify it under the terms of the GNU General Public License as
</font><font color="#FF0000"># published by the Free Software Foundation; either version 2 of the
</font><font color="#FF0000"># License, or (at your option) any later version.
</font><font color="#FF0000">#
</font><font color="#FF0000"># This program is distributed in the hope that it will be useful,
</font><font color="#FF0000"># but WITHOUT ANY WARRANTY; without even the implied warranty of
</font><font color="#FF0000"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
</font><font color="#FF0000"># General Public License for more details.
</font>
<font color="#EB5E00">import</font> <font color="#000000">os</font><font color="#000000">,</font> <font color="#000000">re</font><font color="#000000">,</font> <font color="#000000">time</font>
<font color="#EB5E00">import</font> <font color="#000000">struct</font><font color="#000000">,</font> <font color="#000000">sys</font>
<font color="#EB5E00">from</font> <font color="#000000">commands</font> <font color="#EB5E00">import</font> <font color="#000000">getoutput</font>
<font color="#EB5E00">from</font> <font color="#000000">types</font> <font color="#EB5E00">import</font> <font color="#000000">*</font>

<font color="#000000">WRITE_SPIREOUT</font> <font color="#000000">=</font> <font color="#008800">"WRITE_SPIREOUT"</font>   <font color="#FF0000"># environmental variable for Spire</font>

<font color="#EB5E00">def</font> <font color="#0000FF">fileReadLines</font><font color="#000000">(</font><font color="#000000">filename</font><font color="#000000">)</font><font color="#000000">:</font>
    <font color="#008800">"read a text file, return a list of lines"</font>
    <font color="#EB5E00">try</font><font color="#000000">:</font>
        <font color="#000000">fp</font> <font color="#000000">=</font> <font color="#000000">open</font><font color="#000000">(</font><font color="#000000">filename</font><font color="#000000">,</font><font color="#008800">'r'</font><font color="#000000">)</font>
        <font color="#000000">B</font> <font color="#000000">=</font> <font color="#000000">fp</font><font color="#000000">.</font><font color="#000000">readlines</font><font color="#000000">(</font><font color="#000000">)</font>
        <font color="#000000">fp</font><font color="#000000">.</font><font color="#000000">close</font><font color="#000000">(</font><font color="#000000">)</font>
        <font color="#EB5E00">return</font> <font color="#000000">B</font>
    <font color="#EB5E00">except</font> <font color="#000000">IOError</font><font color="#000000">,</font> <font color="#000000">e</font><font color="#000000">:</font>
        <font color="#EB5E00">print</font> <font color="#008800">'Unable to open file \n'</font> <font color="#000000">+</font> <font color="#000000">filename</font><font color="#000000">,</font> <font color="#000000">e</font>
        <font color="#EB5E00">return</font> <font color="#000000">None</font>

<font color="#EB5E00">def</font> <font color="#0000FF">fileWriteLines</font><font color="#000000">(</font><font color="#000000">filename</font><font color="#000000">,</font> <font color="#000000">lines</font><font color="#000000">,</font> <font color="#000000">append</font><font color="#000000">=</font><font color="#000000">0</font><font color="#000000">,</font> <font color="#000000">mode</font><font color="#000000">=</font><font color="#008800">'w'</font><font color="#000000">)</font><font color="#000000">:</font>
    <font color="#008800">"write a list of lines to a text file"</font>
    <font color="#000000">mode</font> <font color="#000000">=</font> <font color="#008800">'w'</font>
    <font color="#EB5E00">if</font> <font color="#000000">append</font> <font color="#000000">!=</font> <font color="#000000">0</font> <font color="#EB5E00">or</font> <font color="#000000">mode</font> <font color="#000000">!=</font> <font color="#008800">'w'</font><font color="#000000">:</font>
        <font color="#000000">mode</font> <font color="#000000">=</font> <font color="#008800">'a'</font>
    <font color="#000000">fp</font> <font color="#000000">=</font> <font color="#000000">open</font><font color="#000000">(</font><font color="#000000">filename</font><font color="#000000">,</font> <font color="#000000">mode</font><font color="#000000">)</font>
    <font color="#EB5E00">if</font> <font color="#000000">type</font><font color="#000000">(</font><font color="#000000">lines</font><font color="#000000">)</font> <font color="#000000">==</font> <font color="#000000">type</font><font color="#000000">(</font><font color="#008800">"string"</font><font color="#000000">)</font><font color="#000000">:</font>
        <font color="#000000">fp</font><font color="#000000">.</font><font color="#000000">write</font><font color="#000000">(</font><font color="#000000">lines</font><font color="#000000">)</font>
    <font color="#EB5E00">elif</font> <font color="#000000">type</font><font color="#000000">(</font><font color="#000000">lines</font><font color="#000000">)</font> <font color="#000000">==</font> <font color="#000000">type</font><font color="#000000">(</font><font color="#000000">[</font><font color="#008800">"list"</font><font color="#000000">]</font><font color="#000000">)</font><font color="#000000">:</font>
        <font color="#000000">fp</font><font color="#000000">.</font><font color="#000000">writelines</font><font color="#000000">(</font><font color="#000000">lines</font><font color="#000000">)</font>
    <font color="#000000">fp</font><font color="#000000">.</font><font color="#000000">close</font><font color="#000000">(</font><font color="#000000">)</font>

<font color="#FF0000">###################################################################
</font><font color="#FF0000">#
</font><font color="#FF0000"># Reading and writing SPIDER document files
</font><font color="#FF0000">#
</font><font color="#FF0000">#     readdoc 
</font><font color="#FF0000">#     writedoc
</font><font color="#FF0000">#     nowisthetime, makeDocfileHeader, fixHeaders : functiones used by writedoc
</font>
<font color="#FF0000"># Usage: readdoc(file, column=2) or readdoc(file, columns=[2,3])
</font><font color="#FF0000">#
</font><font color="#FF0000"># Of they following 3 keywords (column, columns, lines), only one may be
</font><font color="#FF0000"># used in a call to readdoc. If none are used, then the default is "column=1"
</font><font color="#FF0000">#
</font><font color="#FF0000"># If column=int, returns that column as a list.
</font><font color="#FF0000"># If columns=[i,j,k], returns a tuple of lists.
</font><font color="#FF0000"># If lines=[i,j,k], returns a dictionary, each entry is a list of line values.
</font><font color="#FF0000">#
</font><font color="#FF0000"># Version 1.2 'keys' keyword is deprecated, use lines='all' instead
</font><font color="#FF0000"># If keys=0, returns a list of column values
</font><font color="#FF0000">#           (column 1 = 1st Spider doc file data column).
</font><font color="#FF0000"># If keys=1, returns a dictionary indexed by keys, uses column keyword.
</font><font color="#FF0000"># If keys='all', returns dictionary of all values, ignores column keyword.
</font><font color="#FF0000"># Only works for Spider Version 11.0 format, with spaces between columns.
</font><font color="#EB5E00">def</font> <font color="#0000FF">readdoc</font><font color="#000000">(</font><font color="#000000">filename</font><font color="#000000">,</font> <font color="#000000">column</font><font color="#000000">=</font><font color="#000000">1</font><font color="#000000">,</font> <font color="#000000">columns</font><font color="#000000">=</font><font color="#000000">None</font><font color="#000000">,</font> <font color="#000000">line</font><font color="#000000">=</font><font color="#000000">None</font><font color="#000000">,</font> <font color="#000000">lines</font><font color="#000000">=</font><font color="#000000">None</font><font color="#000000">,</font> <font color="#000000">keys</font><font color="#000000">=</font><font color="#000000">0</font><font color="#000000">)</font><font color="#000000">:</font>
    <font color="#008800">"Read a SPIDER document file; return a list or a dictionary"</font>
    <font color="#FF0000"># first, figure out the which keyword (columns, line, lines) is used
</font>    <font color="#000000">columnlist</font> <font color="#000000">=</font> <font color="#000000">None</font>
    <font color="#000000">linelist</font> <font color="#000000">=</font> <font color="#000000">None</font>
    <font color="#EB5E00">if</font> <font color="#000000">lines</font> <font color="#000000">!=</font> <font color="#000000">None</font><font color="#000000">:</font>
        <font color="#EB5E00">if</font> <font color="#000000">isListorTuple</font><font color="#000000">(</font><font color="#000000">lines</font><font color="#000000">)</font><font color="#000000">:</font>
            <font color="#000000">linelist</font> <font color="#000000">=</font> <font color="#000000">lines</font>
        <font color="#EB5E00">elif</font> <font color="#000000">lines</font> <font color="#000000">==</font> <font color="#008800">'all'</font><font color="#000000">:</font>
            <font color="#000000">linelist</font> <font color="#000000">=</font> <font color="#008800">'all'</font>
        <font color="#EB5E00">else</font><font color="#000000">:</font>
            <font color="#000000">ci</font> <font color="#000000">=</font> <font color="#000000">checkInteger</font><font color="#000000">(</font><font color="#000000">lines</font><font color="#000000">)</font>
            <font color="#EB5E00">if</font> <font color="#000000">ci</font> <font color="#000000">!=</font> <font color="#000000">None</font><font color="#000000">:</font>
                <font color="#000000">linelist</font> <font color="#000000">=</font> <font color="#000000">[</font><font color="#000000">ci</font><font color="#000000">]</font>
            <font color="#EB5E00">else</font><font color="#000000">:</font>
                <font color="#EB5E00">print</font> <font color="#008800">"%s is not a valid value for 'lines' keyword"</font> <font color="#000000">%</font> <font color="#000000">str</font><font color="#000000">(</font><font color="#000000">lines</font><font color="#000000">)</font>
                <font color="#EB5E00">return</font> <font color="#000000">None</font>   <font color="#FF0000"># lines != None but can't parse it</font>
    <font color="#EB5E00">elif</font> <font color="#000000">line</font> <font color="#000000">!=</font> <font color="#000000">None</font><font color="#000000">:</font>
        <font color="#FF0000"># try the 'line' keyword
</font>        <font color="#000000">ci</font> <font color="#000000">=</font> <font color="#000000">checkInteger</font><font color="#000000">(</font><font color="#000000">line</font><font color="#000000">)</font>
        <font color="#EB5E00">if</font> <font color="#000000">ci</font> <font color="#000000">!=</font> <font color="#000000">None</font><font color="#000000">:</font>
            <font color="#000000">linelist</font> <font color="#000000">=</font> <font color="#000000">[</font><font color="#000000">ci</font><font color="#000000">]</font>
        <font color="#EB5E00">elif</font> <font color="#000000">isListorTuple</font><font color="#000000">(</font><font color="#000000">line</font><font color="#000000">)</font><font color="#000000">:</font>
            <font color="#000000">linelist</font> <font color="#000000">=</font> <font color="#000000">line</font>
        <font color="#EB5E00">else</font><font color="#000000">:</font>
            <font color="#EB5E00">print</font> <font color="#008800">"%s is not a valid value for 'line' keyword"</font> <font color="#000000">%</font> <font color="#000000">str</font><font color="#000000">(</font><font color="#000000">line</font><font color="#000000">)</font>
            <font color="#EB5E00">return</font> <font color="#000000">None</font>
    <font color="#EB5E00">elif</font> <font color="#000000">columns</font> <font color="#000000">!=</font> <font color="#000000">None</font><font color="#000000">:</font>
        <font color="#EB5E00">if</font> <font color="#000000">isListorTuple</font><font color="#000000">(</font><font color="#000000">columns</font><font color="#000000">)</font><font color="#000000">:</font>
            <font color="#000000">columnlist</font> <font color="#000000">=</font> <font color="#000000">columns</font>
        <font color="#EB5E00">else</font><font color="#000000">:</font>
            <font color="#000000">ci</font> <font color="#000000">=</font> <font color="#000000">checkInteger</font><font color="#000000">(</font><font color="#000000">columns</font><font color="#000000">)</font>
            <font color="#EB5E00">if</font> <font color="#000000">ci</font> <font color="#000000">!=</font> <font color="#000000">None</font><font color="#000000">:</font>
                <font color="#000000">columnlist</font> <font color="#000000">=</font> <font color="#000000">[</font><font color="#000000">ci</font><font color="#000000">]</font>
            <font color="#EB5E00">else</font><font color="#000000">:</font>
                <font color="#EB5E00">return</font> <font color="#000000">None</font>   <font color="#FF0000"># columns != None but can't parse it</font>
    <font color="#EB5E00">else</font><font color="#000000">:</font>
        <font color="#FF0000"># try the column keyword
</font>        <font color="#000000">ci</font> <font color="#000000">=</font> <font color="#000000">checkInteger</font><font color="#000000">(</font><font color="#000000">column</font><font color="#000000">)</font>
        <font color="#EB5E00">if</font> <font color="#000000">ci</font> <font color="#000000">!=</font> <font color="#000000">None</font><font color="#000000">:</font>
            <font color="#000000">columnlist</font> <font color="#000000">=</font> <font color="#000000">[</font><font color="#000000">ci</font><font color="#000000">]</font>
        <font color="#EB5E00">elif</font> <font color="#000000">isListorTuple</font><font color="#000000">(</font><font color="#000000">column</font><font color="#000000">)</font><font color="#000000">:</font>
            <font color="#000000">columnlist</font> <font color="#000000">=</font> <font color="#000000">column</font>
        <font color="#EB5E00">else</font><font color="#000000">:</font>
            <font color="#EB5E00">return</font> <font color="#000000">None</font>

    <font color="#FF0000"># read the file data
</font>    <font color="#000000">B</font> <font color="#000000">=</font> <font color="#000000">fileReadLines</font><font color="#000000">(</font><font color="#000000">filename</font><font color="#000000">)</font>
    <font color="#EB5E00">if</font> <font color="#000000">B</font> <font color="#000000">==</font> <font color="#000000">None</font><font color="#000000">:</font>
        <font color="#EB5E00">return</font> <font color="#000000">None</font>

    <font color="#FF0000"># if keys=0, return a list of column values (or tuple of lists)
</font>    <font color="#EB5E00">if</font> <font color="#000000">keys</font> <font color="#000000">==</font> <font color="#000000">0</font> <font color="#EB5E00">and</font> <font color="#000000">columnlist</font> <font color="#000000">!=</font> <font color="#000000">None</font><font color="#000000">:</font>
        <font color="#EB5E00">if</font> <font color="#000000">len</font><font color="#000000">(</font><font color="#000000">columnlist</font><font color="#000000">)</font> <font color="#000000">==</font> <font color="#000000">1</font><font color="#000000">:</font>
            <font color="#FF0000"># only asking for 1 column
</font>            <font color="#EB5E00">if</font> <font color="#000000">columnlist</font><font color="#000000">[</font><font color="#000000">0</font><font color="#000000">]</font> <font color="#000000">!=</font> <font color="#000000">0</font><font color="#000000">:</font> <font color="#000000">col</font> <font color="#000000">=</font> <font color="#000000">columnlist</font><font color="#000000">[</font><font color="#000000">0</font><font color="#000000">]</font> <font color="#000000">+</font> <font color="#000000">1</font>      <font color="#FF0000"># first Spider data column</font>
            <font color="#EB5E00">else</font><font color="#000000">:</font> <font color="#000000">col</font> <font color="#000000">=</font> <font color="#000000">0</font>      <font color="#FF0000"># key column</font>
            <font color="#000000">C</font> <font color="#000000">=</font> <font color="#000000">[</font><font color="#000000">]</font>
            <font color="#EB5E00">for</font> <font color="#000000">line</font> <font color="#EB5E00">in</font> <font color="#000000">B</font><font color="#000000">:</font>
                <font color="#000000">d</font> <font color="#000000">=</font> <font color="#000000">line</font><font color="#000000">.</font><font color="#000000">split</font><font color="#000000">(</font><font color="#000000">)</font>
                <font color="#EB5E00">try</font><font color="#000000">:</font> <font color="#000000">int</font><font color="#000000">(</font><font color="#000000">d</font><font color="#000000">[</font><font color="#000000">0</font><font color="#000000">]</font><font color="#000000">)</font>
                <font color="#EB5E00">except</font><font color="#000000">:</font> <font color="#EB5E00">continue</font>

                <font color="#EB5E00">try</font><font color="#000000">:</font>
                    <font color="#000000">C</font><font color="#000000">.</font><font color="#000000">append</font><font color="#000000">(</font><font color="#000000">d</font><font color="#000000">[</font><font color="#000000">col</font><font color="#000000">]</font><font color="#000000">)</font>
                <font color="#EB5E00">except</font><font color="#000000">:</font>
                    <font color="#000000">ncols</font> <font color="#000000">=</font> <font color="#000000">int</font><font color="#000000">(</font><font color="#000000">d</font><font color="#000000">[</font><font color="#000000">1</font><font color="#000000">]</font><font color="#000000">)</font>
                    <font color="#EB5E00">if</font> <font color="#000000">col</font> <font color="#000000">&gt;</font> <font color="#000000">ncols</font><font color="#000000">:</font>
                        <font color="#EB5E00">if</font> <font color="#000000">len</font><font color="#000000">(</font><font color="#000000">C</font><font color="#000000">)</font> <font color="#000000">&gt;</font> <font color="#000000">0</font><font color="#000000">:</font>
                            <font color="#EB5E00">print</font> <font color="#008800">"readdoc: column %d has no data at line %s"</font> <font color="#000000">%</font> <font color="#000000">(</font><font color="#000000">column</font><font color="#000000">,</font><font color="#000000">d</font><font color="#000000">[</font><font color="#000000">0</font><font color="#000000">]</font><font color="#000000">)</font>
                            <font color="#EB5E00">del</font><font color="#000000">(</font><font color="#000000">B</font><font color="#000000">)</font>
                            <font color="#EB5E00">return</font> <font color="#000000">map</font><font color="#000000">(</font><font color="#000000">float</font><font color="#000000">,</font><font color="#000000">C</font><font color="#000000">)</font>
                        <font color="#EB5E00">else</font><font color="#000000">:</font>
                            <font color="#EB5E00">print</font> <font color="#008800">"column=%d, %s has only %d columns"</font> <font color="#000000">%</font> <font color="#000000">(</font><font color="#000000">column</font><font color="#000000">,</font> <font color="#000000">filename</font><font color="#000000">,</font> <font color="#000000">ncols</font><font color="#000000">)</font>
                            <font color="#EB5E00">del</font><font color="#000000">(</font><font color="#000000">B</font><font color="#000000">)</font>
                            <font color="#EB5E00">return</font> <font color="#000000">None</font>
            <font color="#EB5E00">del</font><font color="#000000">(</font><font color="#000000">B</font><font color="#000000">)</font>
            <font color="#EB5E00">return</font> <font color="#000000">map</font><font color="#000000">(</font><font color="#000000">float</font><font color="#000000">,</font><font color="#000000">C</font><font color="#000000">)</font>
        <font color="#EB5E00">else</font><font color="#000000">:</font>
            <font color="#FF0000"># need to get multiple columns
</font>            <font color="#000000">ncols</font> <font color="#000000">=</font> <font color="#000000">len</font><font color="#000000">(</font><font color="#000000">columnlist</font><font color="#000000">)</font>
            <font color="#000000">listlist</font> <font color="#000000">=</font> <font color="#000000">[</font><font color="#000000">]</font>
            <font color="#EB5E00">for</font> <font color="#000000">c</font> <font color="#EB5E00">in</font> <font color="#000000">columnlist</font><font color="#000000">:</font>
                <font color="#000000">listlist</font><font color="#000000">.</font><font color="#000000">append</font><font color="#000000">(</font><font color="#000000">[</font><font color="#000000">]</font><font color="#000000">)</font>  <font color="#FF0000"># a list of empty lists</font>
            <font color="#EB5E00">for</font> <font color="#000000">line</font> <font color="#EB5E00">in</font> <font color="#000000">B</font><font color="#000000">:</font>
                <font color="#000000">d</font> <font color="#000000">=</font> <font color="#000000">line</font><font color="#000000">.</font><font color="#000000">split</font><font color="#000000">(</font><font color="#000000">)</font>
                <font color="#EB5E00">try</font><font color="#000000">:</font>  <font color="#000000">int</font><font color="#000000">(</font><font color="#000000">d</font><font color="#000000">[</font><font color="#000000">0</font><font color="#000000">]</font><font color="#000000">)</font>
                <font color="#EB5E00">except</font><font color="#000000">:</font> <font color="#EB5E00">continue</font>

                <font color="#EB5E00">for</font> <font color="#000000">i</font> <font color="#EB5E00">in</font> <font color="#000000">range</font><font color="#000000">(</font><font color="#000000">ncols</font><font color="#000000">)</font><font color="#000000">:</font>
                    <font color="#000000">col</font> <font color="#000000">=</font> <font color="#000000">columnlist</font><font color="#000000">[</font><font color="#000000">i</font><font color="#000000">]</font>
                    <font color="#EB5E00">if</font> <font color="#000000">col</font> <font color="#000000">!=</font> <font color="#000000">0</font><font color="#000000">:</font> <font color="#000000">col</font> <font color="#000000">=</font> <font color="#000000">col</font> <font color="#000000">+</font> <font color="#000000">1</font>  <font color="#FF0000"># get past SPIDER's second column</font>
                    <font color="#EB5E00">try</font><font color="#000000">:</font>
                        <font color="#000000">f</font> <font color="#000000">=</font> <font color="#000000">float</font><font color="#000000">(</font><font color="#000000">d</font><font color="#000000">[</font><font color="#000000">col</font><font color="#000000">]</font><font color="#000000">)</font>
                        <font color="#000000">listlist</font><font color="#000000">[</font><font color="#000000">i</font><font color="#000000">]</font><font color="#000000">.</font><font color="#000000">append</font><font color="#000000">(</font><font color="#000000">f</font><font color="#000000">)</font>
                    <font color="#EB5E00">except</font><font color="#000000">:</font>
                        <font color="#EB5E00">pass</font>
            <font color="#EB5E00">del</font><font color="#000000">(</font><font color="#000000">B</font><font color="#000000">)</font>
            <font color="#EB5E00">return</font> <font color="#000000">tuple</font><font color="#000000">(</font><font color="#000000">listlist</font><font color="#000000">)</font>  <font color="#FF0000"># convert it to a tuple</font>

    <font color="#FF0000"># return a dictionary of line values
</font>    <font color="#EB5E00">elif</font> <font color="#000000">keys</font> <font color="#000000">==</font> <font color="#000000">0</font> <font color="#EB5E00">and</font> <font color="#000000">linelist</font> <font color="#000000">!=</font> <font color="#000000">None</font><font color="#000000">:</font>
        <font color="#000000">D</font> <font color="#000000">=</font> <font color="#000000">{</font><font color="#000000">}</font>
        <font color="#EB5E00">if</font> <font color="#000000">linelist</font> <font color="#000000">==</font> <font color="#008800">'all'</font><font color="#000000">:</font>
            <font color="#000000">linedata</font> <font color="#000000">=</font> <font color="#000000">[</font><font color="#000000">]</font>
            <font color="#EB5E00">for</font> <font color="#000000">bline</font> <font color="#EB5E00">in</font> <font color="#000000">B</font><font color="#000000">:</font>
                <font color="#000000">s</font> <font color="#000000">=</font> <font color="#000000">bline</font><font color="#000000">.</font><font color="#000000">split</font><font color="#000000">(</font><font color="#000000">)</font>
                <font color="#EB5E00">try</font><font color="#000000">:</font> <font color="#000000">bkey</font> <font color="#000000">=</font> <font color="#000000">int</font><font color="#000000">(</font><font color="#000000">s</font><font color="#000000">[</font><font color="#000000">0</font><font color="#000000">]</font><font color="#000000">)</font>
                <font color="#EB5E00">except</font><font color="#000000">:</font> <font color="#EB5E00">continue</font>
                <font color="#000000">linedata</font> <font color="#000000">=</font>  <font color="#000000">map</font><font color="#000000">(</font><font color="#000000">float</font><font color="#000000">,</font> <font color="#000000">s</font><font color="#000000">[</font><font color="#000000">2</font><font color="#000000">:</font><font color="#000000">]</font><font color="#000000">)</font>
                <font color="#000000">D</font><font color="#000000">[</font><font color="#000000">bkey</font><font color="#000000">]</font> <font color="#000000">=</font> <font color="#000000">linedata</font>
            <font color="#EB5E00">return</font> <font color="#000000">D</font>

        <font color="#EB5E00">else</font><font color="#000000">:</font> <font color="#FF0000"># a subset of lines</font>
            <font color="#EB5E00">for</font> <font color="#000000">bline</font> <font color="#EB5E00">in</font> <font color="#000000">B</font><font color="#000000">:</font>
                <font color="#000000">s</font> <font color="#000000">=</font> <font color="#000000">bline</font><font color="#000000">.</font><font color="#000000">split</font><font color="#000000">(</font><font color="#000000">)</font>
                <font color="#EB5E00">try</font><font color="#000000">:</font> <font color="#000000">bkey</font> <font color="#000000">=</font> <font color="#000000">int</font><font color="#000000">(</font><font color="#000000">s</font><font color="#000000">[</font><font color="#000000">0</font><font color="#000000">]</font><font color="#000000">)</font>
                <font color="#EB5E00">except</font><font color="#000000">:</font> <font color="#EB5E00">continue</font>
                <font color="#EB5E00">if</font> <font color="#000000">bkey</font> <font color="#EB5E00">in</font> <font color="#000000">linelist</font><font color="#000000">:</font>
                    <font color="#000000">linedata</font> <font color="#000000">=</font>  <font color="#000000">map</font><font color="#000000">(</font><font color="#000000">float</font><font color="#000000">,</font> <font color="#000000">s</font><font color="#000000">[</font><font color="#000000">2</font><font color="#000000">:</font><font color="#000000">]</font><font color="#000000">)</font>
                    <font color="#000000">D</font><font color="#000000">[</font><font color="#000000">bkey</font><font color="#000000">]</font> <font color="#000000">=</font> <font color="#000000">linedata</font>

                    <font color="#000000">idx</font> <font color="#000000">=</font> <font color="#000000">linelist</font><font color="#000000">.</font><font color="#000000">index</font><font color="#000000">(</font><font color="#000000">bkey</font><font color="#000000">)</font> <font color="#FF0000"># remove key from linelist</font>
                    <font color="#EB5E00">del</font><font color="#000000">(</font><font color="#000000">linelist</font><font color="#000000">[</font><font color="#000000">idx</font><font color="#000000">]</font><font color="#000000">)</font>
                    <font color="#EB5E00">if</font> <font color="#000000">len</font><font color="#000000">(</font><font color="#000000">linelist</font><font color="#000000">)</font> <font color="#000000">==</font> <font color="#000000">0</font><font color="#000000">:</font>
                        <font color="#EB5E00">return</font> <font color="#000000">D</font>

    <font color="#FF0000"># if keys != 0, return a dictionary
</font>    <font color="#EB5E00">else</font><font color="#000000">:</font>
        <font color="#000000">D</font> <font color="#000000">=</font> <font color="#000000">{</font><font color="#000000">}</font>
        <font color="#EB5E00">if</font> <font color="#000000">keys</font> <font color="#000000">==</font> <font color="#008800">'all'</font><font color="#000000">:</font>
            <font color="#FF0000"># each dictionary key points to list of all values in that line
</font>            <font color="#EB5E00">for</font> <font color="#000000">line</font> <font color="#EB5E00">in</font> <font color="#000000">B</font><font color="#000000">:</font>
                <font color="#000000">d</font> <font color="#000000">=</font> <font color="#000000">line</font><font color="#000000">.</font><font color="#000000">split</font><font color="#000000">(</font><font color="#000000">)</font>
                <font color="#EB5E00">try</font><font color="#000000">:</font>  <font color="#000000">int</font><font color="#000000">(</font><font color="#000000">d</font><font color="#000000">[</font><font color="#000000">0</font><font color="#000000">]</font><font color="#000000">)</font>
                <font color="#EB5E00">except</font><font color="#000000">:</font> <font color="#EB5E00">continue</font>
                <font color="#000000">key</font> <font color="#000000">=</font> <font color="#000000">int</font><font color="#000000">(</font><font color="#000000">d</font><font color="#000000">[</font><font color="#000000">0</font><font color="#000000">]</font><font color="#000000">)</font>
                <font color="#000000">ncols</font> <font color="#000000">=</font> <font color="#000000">int</font><font color="#000000">(</font><font color="#000000">d</font><font color="#000000">[</font><font color="#000000">1</font><font color="#000000">]</font><font color="#000000">)</font> <font color="#000000">+</font> <font color="#000000">1</font>
                <font color="#000000">data</font> <font color="#000000">=</font> <font color="#000000">map</font><font color="#000000">(</font><font color="#000000">float</font><font color="#000000">,</font><font color="#000000">d</font><font color="#000000">[</font><font color="#000000">2</font><font color="#000000">:</font><font color="#000000">ncols</font><font color="#000000">+</font><font color="#000000">1</font><font color="#000000">]</font><font color="#000000">)</font>
                <font color="#000000">D</font><font color="#000000">[</font><font color="#000000">key</font><font color="#000000">]</font> <font color="#000000">=</font> <font color="#000000">data</font>
        <font color="#EB5E00">else</font><font color="#000000">:</font>
            <font color="#FF0000"># dictionary contains a list of requested columns
</font>            <font color="#000000">clist</font> <font color="#000000">=</font> <font color="#000000">[</font><font color="#000000">]</font>
            <font color="#EB5E00">for</font> <font color="#000000">col</font> <font color="#EB5E00">in</font> <font color="#000000">columnlist</font><font color="#000000">:</font>
                <font color="#EB5E00">if</font> <font color="#000000">col</font> <font color="#000000">==</font> <font color="#000000">0</font><font color="#000000">:</font> <font color="#000000">clist</font><font color="#000000">.</font><font color="#000000">append</font><font color="#000000">(</font><font color="#000000">col</font><font color="#000000">)</font>
                <font color="#EB5E00">else</font><font color="#000000">:</font> <font color="#000000">clist</font><font color="#000000">.</font><font color="#000000">append</font><font color="#000000">(</font><font color="#000000">col</font><font color="#000000">+</font><font color="#000000">1</font><font color="#000000">)</font>
            <font color="#000000">ncols</font> <font color="#000000">=</font> <font color="#000000">len</font><font color="#000000">(</font><font color="#000000">clist</font><font color="#000000">)</font>
            <font color="#EB5E00">for</font> <font color="#000000">line</font> <font color="#EB5E00">in</font> <font color="#000000">B</font><font color="#000000">:</font>
                <font color="#000000">d</font> <font color="#000000">=</font> <font color="#000000">line</font><font color="#000000">.</font><font color="#000000">split</font><font color="#000000">(</font><font color="#000000">)</font>
                <font color="#EB5E00">try</font><font color="#000000">:</font>  <font color="#000000">int</font><font color="#000000">(</font><font color="#000000">d</font><font color="#000000">[</font><font color="#000000">0</font><font color="#000000">]</font><font color="#000000">)</font>
                <font color="#EB5E00">except</font><font color="#000000">:</font> <font color="#EB5E00">continue</font>
                <font color="#000000">key</font> <font color="#000000">=</font> <font color="#000000">int</font><font color="#000000">(</font><font color="#000000">d</font><font color="#000000">[</font><font color="#000000">0</font><font color="#000000">]</font><font color="#000000">)</font>
                <font color="#000000">data</font> <font color="#000000">=</font> <font color="#000000">[</font><font color="#000000">]</font>
                <font color="#EB5E00">for</font> <font color="#000000">col</font> <font color="#EB5E00">in</font> <font color="#000000">clist</font><font color="#000000">:</font>
                    <font color="#000000">data</font><font color="#000000">.</font><font color="#000000">append</font><font color="#000000">(</font><font color="#000000">float</font><font color="#000000">(</font><font color="#000000">d</font><font color="#000000">[</font><font color="#000000">col</font><font color="#000000">]</font><font color="#000000">)</font><font color="#000000">)</font>
                <font color="#000000">D</font><font color="#000000">[</font><font color="#000000">key</font><font color="#000000">]</font> <font color="#000000">=</font> <font color="#000000">data</font>
        <font color="#EB5E00">del</font><font color="#000000">(</font><font color="#000000">B</font><font color="#000000">)</font>
        <font color="#EB5E00">return</font> <font color="#000000">D</font>
<font color="#FF0000"># end readdoc -------------------------------------------------
</font>
<font color="#FF0000"># included for compatibility            
</font><font color="#EB5E00">def</font> <font color="#0000FF">readSpiderDocFile</font><font color="#000000">(</font><font color="#000000">filename</font><font color="#000000">,</font> <font color="#000000">col_list</font><font color="#000000">=</font><font color="#000000">None</font><font color="#000000">)</font><font color="#000000">:</font>
    <font color="#008800">"Read a SPIDER document file; return a dictionary"</font>
    <font color="#EB5E00">return</font> <font color="#000000">readdoc</font><font color="#000000">(</font><font color="#000000">filename</font><font color="#000000">,</font> <font color="#000000">keys</font><font color="#000000">=</font><font color="#008800">'all'</font><font color="#000000">)</font>

<font color="#EB5E00">def</font> <font color="#0000FF">numberOfColumns</font><font color="#000000">(</font><font color="#000000">docfile</font><font color="#000000">)</font><font color="#000000">:</font>
    <font color="#008800">" find the number of columns in a doc file"</font>
    <font color="#000000">B</font> <font color="#000000">=</font> <font color="#000000">fileReadLines</font><font color="#000000">(</font><font color="#000000">docfile</font><font color="#000000">)</font>
    <font color="#EB5E00">for</font> <font color="#000000">line</font> <font color="#EB5E00">in</font> <font color="#000000">B</font><font color="#000000">:</font>
     <font color="#000000">line</font> <font color="#000000">=</font> <font color="#000000">line</font><font color="#000000">.</font><font color="#000000">strip</font><font color="#000000">(</font><font color="#000000">)</font>
     <font color="#EB5E00">if</font> <font color="#000000">line</font> <font color="#000000">==</font> <font color="#008800">""</font> <font color="#EB5E00">or</font> <font color="#000000">line</font><font color="#000000">[</font><font color="#000000">0</font><font color="#000000">]</font> <font color="#000000">==</font> <font color="#008800">";"</font><font color="#000000">:</font> <font color="#EB5E00">continue</font>

     <font color="#000000">d</font> <font color="#000000">=</font> <font color="#000000">line</font><font color="#000000">.</font><font color="#000000">split</font><font color="#000000">(</font><font color="#000000">)</font>
     <font color="#EB5E00">if</font> <font color="#000000">len</font><font color="#000000">(</font><font color="#000000">d</font><font color="#000000">)</font> <font color="#000000">&gt;</font> <font color="#000000">1</font><font color="#000000">:</font>
         <font color="#EB5E00">try</font><font color="#000000">:</font>
             <font color="#000000">ncol</font> <font color="#000000">=</font> <font color="#000000">int</font><font color="#000000">(</font><font color="#000000">d</font><font color="#000000">[</font><font color="#000000">1</font><font color="#000000">]</font><font color="#000000">)</font>
             <font color="#EB5E00">return</font> <font color="#000000">ncol</font>
         <font color="#EB5E00">except</font><font color="#000000">:</font>
             <font color="#EB5E00">pass</font>
    <font color="#EB5E00">return</font> <font color="#000000">0</font>

<font color="#000000">onespace</font> <font color="#000000">=</font> <font color="#000000">re</font><font color="#000000">.</font><font color="#000000">compile</font><font color="#000000">(</font><font color="#008800">"\S+ \S+"</font><font color="#000000">)</font>

<font color="#EB5E00">def</font> <font color="#0000FF">combineHeaderSpaces</font><font color="#000000">(</font><font color="#000000">g</font><font color="#000000">,</font><font color="#000000">s</font><font color="#000000">,</font><font color="#000000">ncolumns</font><font color="#000000">)</font><font color="#000000">:</font>
    <font color="#008800">" g is list, s is string. Convert ['HAS', 'SPACE'] -&gt; ['HAS SPACE']"</font>
    <font color="#000000">m</font> <font color="#000000">=</font> <font color="#000000">onespace</font><font color="#000000">.</font><font color="#000000">search</font><font color="#000000">(</font><font color="#000000">s</font><font color="#000000">)</font>
    <font color="#FF0000"># if an item with a space is found AND there are more headers than columns..
</font>    <font color="#EB5E00">if</font> <font color="#000000">m</font> <font color="#EB5E00">and</font> <font color="#000000">len</font><font color="#000000">(</font><font color="#000000">g</font><font color="#000000">)</font> <font color="#000000">&gt;</font> <font color="#000000">ncolumns</font><font color="#000000">:</font>
        <font color="#000000">start</font><font color="#000000">,</font><font color="#000000">end</font> <font color="#000000">=</font> <font color="#000000">m</font><font color="#000000">.</font><font color="#000000">span</font><font color="#000000">(</font><font color="#000000">)</font>
        <font color="#000000">substring</font> <font color="#000000">=</font> <font color="#000000">s</font><font color="#000000">[</font><font color="#000000">start</font><font color="#000000">:</font><font color="#000000">end</font><font color="#000000">]</font>
        <font color="#000000">pp</font> <font color="#000000">=</font> <font color="#000000">substring</font><font color="#000000">.</font><font color="#000000">split</font><font color="#000000">(</font><font color="#000000">)</font>
        <font color="#000000">s1</font> <font color="#000000">=</font> <font color="#000000">pp</font><font color="#000000">[</font><font color="#000000">0</font><font color="#000000">]</font>
        <font color="#000000">s2</font> <font color="#000000">=</font> <font color="#000000">pp</font><font color="#000000">[</font><font color="#000000">1</font><font color="#000000">]</font>
        <font color="#000000">n</font> <font color="#000000">=</font> <font color="#000000">len</font><font color="#000000">(</font><font color="#000000">g</font><font color="#000000">)</font>
        <font color="#000000">idx</font> <font color="#000000">=</font> <font color="#000000">-</font><font color="#000000">1</font>
        <font color="#EB5E00">for</font> <font color="#000000">i</font> <font color="#EB5E00">in</font> <font color="#000000">range</font><font color="#000000">(</font><font color="#000000">n</font><font color="#000000">-</font><font color="#000000">1</font><font color="#000000">)</font><font color="#000000">:</font>
            <font color="#EB5E00">if</font> <font color="#000000">g</font><font color="#000000">[</font><font color="#000000">i</font><font color="#000000">]</font> <font color="#000000">==</font> <font color="#000000">s1</font> <font color="#EB5E00">and</font> <font color="#000000">g</font><font color="#000000">[</font><font color="#000000">i</font><font color="#000000">+</font><font color="#000000">1</font><font color="#000000">]</font> <font color="#000000">==</font> <font color="#000000">s2</font><font color="#000000">:</font>
                <font color="#000000">idx</font> <font color="#000000">=</font> <font color="#000000">i</font>
                <font color="#EB5E00">break</font>
        <font color="#EB5E00">if</font> <font color="#000000">idx</font> <font color="#000000">&gt;</font> <font color="#000000">-</font><font color="#000000">1</font><font color="#000000">:</font>
            <font color="#FF0000"># collapse list items i,i+1 to one item with a space
</font>            <font color="#000000">h</font> <font color="#000000">=</font> <font color="#000000">g</font><font color="#000000">[</font><font color="#000000">:</font><font color="#000000">idx</font><font color="#000000">]</font> <font color="#000000">+</font> <font color="#000000">[</font><font color="#000000">g</font><font color="#000000">[</font><font color="#000000">idx</font><font color="#000000">]</font> <font color="#000000">+</font> <font color="#008800">' '</font> <font color="#000000">+</font> <font color="#000000">g</font><font color="#000000">[</font><font color="#000000">idx</font><font color="#000000">+</font><font color="#000000">1</font><font color="#000000">]</font><font color="#000000">]</font>
            <font color="#EB5E00">if</font> <font color="#000000">n</font> <font color="#000000">&gt;</font> <font color="#000000">idx</font><font color="#000000">+</font><font color="#000000">1</font><font color="#000000">:</font>
                <font color="#000000">h</font> <font color="#000000">=</font> <font color="#000000">h</font> <font color="#000000">+</font> <font color="#000000">g</font><font color="#000000">[</font><font color="#000000">idx</font><font color="#000000">+</font><font color="#000000">2</font><font color="#000000">:</font><font color="#000000">]</font>

            <font color="#000000">g</font> <font color="#000000">=</font> <font color="#000000">combineHeaderSpaces</font><font color="#000000">(</font><font color="#000000">h</font><font color="#000000">,</font><font color="#000000">s</font><font color="#000000">[</font><font color="#000000">end</font><font color="#000000">:</font><font color="#000000">]</font><font color="#000000">,</font><font color="#000000">ncolumns</font><font color="#000000">)</font>
            <font color="#EB5E00">return</font> <font color="#000000">g</font>
        <font color="#EB5E00">else</font><font color="#000000">:</font>
            <font color="#EB5E00">return</font> <font color="#000000">g</font>
    <font color="#EB5E00">else</font><font color="#000000">:</font>
        <font color="#EB5E00">return</font> <font color="#000000">g</font>

<font color="#EB5E00">def</font> <font color="#0000FF">getDocfileHeaders</font><font color="#000000">(</font><font color="#000000">filename</font><font color="#000000">,</font> <font color="#000000">output</font><font color="#000000">=</font><font color="#008800">'list'</font><font color="#000000">)</font><font color="#000000">:</font>
    <font color="#008800">" tries to get the column headers from a doc file"</font>
    <font color="#EB5E00">try</font><font color="#000000">:</font>
        <font color="#000000">fp</font> <font color="#000000">=</font> <font color="#000000">open</font><font color="#000000">(</font><font color="#000000">filename</font><font color="#000000">,</font><font color="#008800">'r'</font><font color="#000000">)</font>
    <font color="#EB5E00">except</font><font color="#000000">:</font>
        <font color="#EB5E00">print</font> <font color="#008800">'unable to open %s'</font> <font color="#000000">%</font> <font color="#000000">(</font><font color="#000000">filename</font><font color="#000000">)</font>
        <font color="#EB5E00">return</font> <font color="#008800">""</font>
    <font color="#000000">headers</font> <font color="#000000">=</font> <font color="#000000">[</font><font color="#000000">]</font>
    <font color="#EB5E00">if</font> <font color="#000000">output</font> <font color="#000000">==</font> <font color="#008800">"string"</font><font color="#000000">:</font>
        <font color="#000000">headers</font> <font color="#000000">=</font> <font color="#008800">""</font>

    <font color="#000000">max</font> <font color="#000000">=</font> <font color="#000000">5</font>
    <font color="#000000">i</font> <font color="#000000">=</font> <font color="#000000">1</font>
    <font color="#EB5E00">while</font> <font color="#000000">1</font><font color="#000000">:</font>
        <font color="#000000">s</font> <font color="#000000">=</font> <font color="#000000">fp</font><font color="#000000">.</font><font color="#000000">readline</font><font color="#000000">(</font><font color="#000000">)</font>
        <font color="#EB5E00">if</font> <font color="#EB5E00">not</font> <font color="#000000">s</font><font color="#000000">:</font>
            <font color="#EB5E00">break</font>
        <font color="#EB5E00">if</font> <font color="#000000">len</font><font color="#000000">(</font><font color="#000000">s</font><font color="#000000">)</font> <font color="#000000">&gt;</font> <font color="#000000">0</font> <font color="#EB5E00">and</font> <font color="#000000">s</font><font color="#000000">[</font><font color="#000000">1</font><font color="#000000">]</font> <font color="#000000">==</font> <font color="#008800">';'</font><font color="#000000">:</font>
            <font color="#000000">x</font> <font color="#000000">=</font> <font color="#000000">s</font><font color="#000000">.</font><font color="#000000">split</font><font color="#000000">(</font><font color="#000000">)</font>
            <font color="#EB5E00">if</font> <font color="#000000">len</font><font color="#000000">(</font><font color="#000000">x</font><font color="#000000">)</font> <font color="#000000">==</font> <font color="#000000">5</font> <font color="#EB5E00">and</font> <font color="#000000">len</font><font color="#000000">(</font><font color="#000000">x</font><font color="#000000">[</font><font color="#000000">0</font><font color="#000000">]</font><font color="#000000">)</font> <font color="#000000">==</font> <font color="#000000">8</font> <font color="#EB5E00">and</font> <font color="#000000">x</font><font color="#000000">[</font><font color="#000000">0</font><font color="#000000">]</font><font color="#000000">[</font><font color="#000000">4</font><font color="#000000">]</font> <font color="#000000">==</font> <font color="#008800">'/'</font> <font color="#EB5E00">and</font> <font color="#000000">x</font><font color="#000000">[</font><font color="#000000">2</font><font color="#000000">]</font> <font color="#000000">==</font> <font color="#008800">'AT'</font><font color="#000000">:</font>
                <font color="#FF0000"># it's ;spi/dat   22-AUG-2008 AT 15:17:59   file.dat
</font>                <font color="#EB5E00">continue</font>
            <font color="#EB5E00">if</font> <font color="#000000">len</font><font color="#000000">(</font><font color="#000000">x</font><font color="#000000">)</font> <font color="#000000">&gt;</font> <font color="#000000">1</font><font color="#000000">:</font>
                <font color="#EB5E00">if</font> <font color="#000000">output</font> <font color="#000000">==</font> <font color="#008800">"string"</font><font color="#000000">:</font>
                    <font color="#EB5E00">return</font> <font color="#000000">s</font><font color="#000000">[</font><font color="#000000">2</font><font color="#000000">:</font><font color="#000000">]</font><font color="#000000">.</font><font color="#000000">rstrip</font><font color="#000000">(</font><font color="#000000">)</font>

                <font color="#000000">g</font> <font color="#000000">=</font> <font color="#000000">x</font><font color="#000000">[</font><font color="#000000">1</font><font color="#000000">:</font><font color="#000000">]</font>   <font color="#FF0000"># g is list, s is string</font>

                <font color="#FF0000"># some headers have a space, so 2 items need to be combined
</font>                <font color="#000000">ncol</font> <font color="#000000">=</font> <font color="#000000">numberOfColumns</font><font color="#000000">(</font><font color="#000000">filename</font><font color="#000000">)</font>
                <font color="#000000">headers</font> <font color="#000000">=</font> <font color="#000000">combineHeaderSpaces</font><font color="#000000">(</font><font color="#000000">g</font><font color="#000000">,</font><font color="#000000">s</font><font color="#000000">.</font><font color="#000000">rstrip</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">,</font> <font color="#000000">ncol</font><font color="#000000">)</font>
                <font color="#EB5E00">break</font>
        <font color="#000000">i</font> <font color="#000000">+=</font> <font color="#000000">1</font>
        <font color="#EB5E00">if</font> <font color="#000000">i</font> <font color="#000000">&gt;</font> <font color="#000000">max</font><font color="#000000">:</font>
            <font color="#EB5E00">break</font>

    <font color="#000000">fp</font><font color="#000000">.</font><font color="#000000">close</font><font color="#000000">(</font><font color="#000000">)</font>
    <font color="#EB5E00">return</font> <font color="#000000">headers</font>


<font color="#FF0000">#########################################################################
</font><font color="#FF0000"># functions for writedoc
</font>
<font color="#FF0000"># returns e.g., ('16-OCT-03', '13:08:16', '031016130816')
</font><font color="#EB5E00">def</font> <font color="#0000FF">nowisthetime</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">:</font>
    <font color="#008800">"return current time as tuple of 3 strings: (date, time, ID)"</font>
    <font color="#000000">tt</font> <font color="#000000">=</font> <font color="#000000">time</font><font color="#000000">.</font><font color="#000000">localtime</font><font color="#000000">(</font><font color="#000000">time</font><font color="#000000">.</font><font color="#000000">time</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">)</font>
    <font color="#FF0000"># localtime return format: (2003, 10, 16, 12, 48, 30, 3, 289, 1)
</font>    <font color="#FF0000">#t = string.split(time.asctime(tt))
</font>    <font color="#000000">t</font> <font color="#000000">=</font> <font color="#000000">time</font><font color="#000000">.</font><font color="#000000">asctime</font><font color="#000000">(</font><font color="#000000">tt</font><font color="#000000">)</font><font color="#000000">.</font><font color="#000000">split</font><font color="#000000">(</font><font color="#000000">)</font>
    <font color="#FF0000"># asctime return format: 'Thu Oct 16 12:50:17 2003'
</font>    <font color="#000000">mo</font> <font color="#000000">=</font> <font color="#000000">t</font><font color="#000000">[</font><font color="#000000">1</font><font color="#000000">]</font><font color="#000000">.</font><font color="#000000">upper</font><font color="#000000">(</font><font color="#000000">)</font>
    <font color="#000000">day</font> <font color="#000000">=</font> <font color="#000000">t</font><font color="#000000">[</font><font color="#000000">2</font><font color="#000000">]</font>
    <font color="#EB5E00">if</font> <font color="#000000">len</font><font color="#000000">(</font><font color="#000000">day</font><font color="#000000">)</font> <font color="#000000">&lt;</font> <font color="#000000">2</font><font color="#000000">:</font> <font color="#000000">day</font> <font color="#000000">=</font> <font color="#008800">'0'</font> <font color="#000000">+</font> <font color="#000000">day</font>
    <font color="#000000">timestr</font> <font color="#000000">=</font> <font color="#000000">t</font><font color="#000000">[</font><font color="#000000">3</font><font color="#000000">]</font>
    <font color="#000000">yr</font> <font color="#000000">=</font> <font color="#000000">t</font><font color="#000000">[</font><font color="#000000">4</font><font color="#000000">]</font>
    <font color="#000000">datestr</font> <font color="#000000">=</font> <font color="#008800">"%s-%s-%s"</font> <font color="#000000">%</font> <font color="#000000">(</font><font color="#000000">day</font><font color="#000000">,</font> <font color="#000000">mo</font><font color="#000000">,</font> <font color="#000000">yr</font><font color="#000000">)</font>

    <font color="#000000">yr</font> <font color="#000000">=</font> <font color="#000000">yr</font><font color="#000000">[</font><font color="#000000">-</font><font color="#000000">2</font><font color="#000000">:</font><font color="#000000">]</font>
    <font color="#FF0000"># this is just to get the month as a number
</font>    <font color="#000000">d</font> <font color="#000000">=</font> <font color="#000000">map</font><font color="#000000">(</font><font color="#000000">str</font><font color="#000000">,</font><font color="#000000">tt</font><font color="#000000">)</font>   <font color="#FF0000"># stringify all numbers in the tuple</font>
    <font color="#000000">mon</font> <font color="#000000">=</font> <font color="#000000">d</font><font color="#000000">[</font><font color="#000000">1</font><font color="#000000">]</font>
    <font color="#EB5E00">if</font> <font color="#000000">len</font><font color="#000000">(</font><font color="#000000">mon</font><font color="#000000">)</font> <font color="#000000">&lt;</font> <font color="#000000">2</font><font color="#000000">:</font> <font color="#000000">mon</font> <font color="#000000">=</font> <font color="#008800">'0'</font> <font color="#000000">+</font> <font color="#000000">mon</font>
    <font color="#FF0000">#(h,m,s) = string.split(timestr,':')
</font>    <font color="#000000">(</font><font color="#000000">h</font><font color="#000000">,</font><font color="#000000">m</font><font color="#000000">,</font><font color="#000000">s</font><font color="#000000">)</font> <font color="#000000">=</font> <font color="#000000">timestr</font><font color="#000000">.</font><font color="#000000">split</font><font color="#000000">(</font><font color="#008800">':'</font><font color="#000000">)</font>
    <font color="#000000">idstr</font> <font color="#000000">=</font> <font color="#008800">"%s%s%s%s%s%s"</font> <font color="#000000">%</font> <font color="#000000">(</font><font color="#000000">yr</font><font color="#000000">,</font><font color="#000000">mon</font><font color="#000000">,</font><font color="#000000">day</font><font color="#000000">,</font><font color="#000000">h</font><font color="#000000">,</font><font color="#000000">m</font><font color="#000000">,</font><font color="#000000">s</font><font color="#000000">)</font>

    <font color="#EB5E00">return</font> <font color="#000000">(</font><font color="#000000">datestr</font><font color="#000000">,</font> <font color="#000000">timestr</font><font color="#000000">,</font> <font color="#000000">idstr</font><font color="#000000">)</font>

<font color="#EB5E00">def</font> <font color="#0000FF">makeDocfileHeader</font><font color="#000000">(</font><font color="#000000">filename</font><font color="#000000">,</font> <font color="#000000">batext</font><font color="#000000">=</font><font color="#000000">None</font><font color="#000000">)</font><font color="#000000">:</font>
    <font color="#008800">"create the comment line used at the top of SPIDER document files"</font>
    <font color="#000000">filename</font> <font color="#000000">=</font> <font color="#000000">os</font><font color="#000000">.</font><font color="#000000">path</font><font color="#000000">.</font><font color="#000000">basename</font><font color="#000000">(</font><font color="#000000">filename</font><font color="#000000">)</font>
    <font color="#000000">fn</font><font color="#000000">,</font> <font color="#000000">ext</font> <font color="#000000">=</font> <font color="#000000">os</font><font color="#000000">.</font><font color="#000000">path</font><font color="#000000">.</font><font color="#000000">splitext</font><font color="#000000">(</font><font color="#000000">filename</font><font color="#000000">)</font>
    <font color="#000000">ext</font> <font color="#000000">=</font> <font color="#000000">ext</font><font color="#000000">[</font><font color="#000000">1</font><font color="#000000">:</font><font color="#000000">]</font>
    <font color="#EB5E00">if</font> <font color="#000000">batext</font> <font color="#000000">==</font> <font color="#000000">None</font><font color="#000000">:</font>
        <font color="#000000">batext</font> <font color="#000000">=</font> <font color="#008800">'spl'</font>   <font color="#FF0000"># Spider Python Library</font>
    <font color="#000000">date</font><font color="#000000">,</font><font color="#000000">time</font><font color="#000000">,</font><font color="#000000">idstr</font> <font color="#000000">=</font> <font color="#000000">nowisthetime</font><font color="#000000">(</font><font color="#000000">)</font>
    <font color="#000000">h</font> <font color="#000000">=</font> <font color="#008800">" ;%s/%s   %s AT %s   %s\n"</font> <font color="#000000">%</font> <font color="#000000">(</font><font color="#000000">batext</font><font color="#000000">,</font><font color="#000000">ext</font><font color="#000000">,</font><font color="#000000">date</font><font color="#000000">,</font><font color="#000000">time</font><font color="#000000">,</font><font color="#000000">filename</font><font color="#000000">)</font>
    <font color="#EB5E00">return</font> <font color="#000000">h</font>

<font color="#EB5E00">def</font> <font color="#0000FF">fixHeaders</font><font color="#000000">(</font><font color="#000000">headers</font><font color="#000000">)</font><font color="#000000">:</font>
    <font color="#008800">"make all headers 11 characters in width; return doc string"</font>
    <font color="#000000">w</font> <font color="#000000">=</font> <font color="#000000">11</font>
    <font color="#000000">docstr</font> <font color="#000000">=</font> <font color="#008800">" ; /    "</font>
    <font color="#EB5E00">for</font> <font color="#000000">h</font> <font color="#EB5E00">in</font> <font color="#000000">headers</font><font color="#000000">:</font>
        <font color="#000000">d</font> <font color="#000000">=</font> <font color="#000000">len</font><font color="#000000">(</font><font color="#000000">h</font><font color="#000000">)</font>
        <font color="#EB5E00">if</font> <font color="#000000">d</font> <font color="#000000">&gt;</font> <font color="#000000">w</font><font color="#000000">:</font>
            <font color="#000000">h</font> <font color="#000000">=</font> <font color="#000000">h</font><font color="#000000">[</font><font color="#000000">:</font><font color="#000000">w</font><font color="#000000">]</font>
        <font color="#000000">docstr</font> <font color="#000000">+=</font> <font color="#000000">h</font><font color="#000000">.</font><font color="#000000">rjust</font><font color="#000000">(</font><font color="#000000">w</font><font color="#000000">+</font><font color="#000000">1</font><font color="#000000">)</font>
    <font color="#000000">docstr</font> <font color="#000000">+=</font> <font color="#008800">"\n"</font>
    <font color="#EB5E00">return</font> <font color="#000000">docstr</font>

<font color="#FF0000">###################################################################
</font><font color="#FF0000">#
</font><font color="#FF0000"># type-checking functions
</font>
<font color="#EB5E00">def</font> <font color="#0000FF">checkInteger</font><font color="#000000">(</font><font color="#000000">x</font><font color="#000000">)</font><font color="#000000">:</font>
    <font color="#008800">" returns int if input can be converted to an integer, else None"</font>
    <font color="#EB5E00">try</font><font color="#000000">:</font>
        <font color="#000000">i</font> <font color="#000000">=</font> <font color="#000000">int</font><font color="#000000">(</font><font color="#000000">x</font><font color="#000000">)</font>  <font color="#FF0000"># works for 5, 5.0, '5'</font>
        <font color="#EB5E00">return</font> <font color="#000000">i</font>
    <font color="#EB5E00">except</font><font color="#000000">:</font>
        <font color="#EB5E00">try</font><font color="#000000">:</font>
            <font color="#000000">i</font> <font color="#000000">=</font> <font color="#000000">int</font><font color="#000000">(</font><font color="#000000">float</font><font color="#000000">(</font><font color="#000000">x</font><font color="#000000">)</font><font color="#000000">)</font>  <font color="#FF0000"># works for '5.0'</font>
            <font color="#EB5E00">return</font> <font color="#000000">i</font>
        <font color="#EB5E00">except</font><font color="#000000">:</font>
            <font color="#EB5E00">return</font> <font color="#000000">None</font>
    <font color="#EB5E00">return</font> <font color="#000000">None</font>

<font color="#EB5E00">def</font> <font color="#0000FF">isListorTuple</font><font color="#000000">(</font><font color="#000000">x</font><font color="#000000">)</font><font color="#000000">:</font>
    <font color="#008800">"returns 1 if input is a list or a tuple"</font>
    <font color="#EB5E00">if</font> <font color="#000000">isinstance</font><font color="#000000">(</font><font color="#000000">x</font><font color="#000000">,</font> <font color="#000000">ListType</font><font color="#000000">)</font> <font color="#EB5E00">or</font> <font color="#000000">isinstance</font><font color="#000000">(</font><font color="#000000">x</font><font color="#000000">,</font> <font color="#000000">TupleType</font><font color="#000000">)</font> <font color="#000000">:</font> <font color="#EB5E00">return</font> <font color="#000000">1</font>
    <font color="#EB5E00">else</font><font color="#000000">:</font> <font color="#EB5E00">return</font> <font color="#000000">0</font>

<font color="#EB5E00">def</font> <font color="#0000FF">isDictionary</font><font color="#000000">(</font><font color="#000000">d</font><font color="#000000">)</font><font color="#000000">:</font>
    <font color="#008800">"returns 1 if input is a Python dictionary"</font>
    <font color="#EB5E00">if</font> <font color="#000000">isinstance</font><font color="#000000">(</font><font color="#000000">d</font><font color="#000000">,</font> <font color="#000000">DictType</font><font color="#000000">)</font><font color="#000000">:</font> <font color="#EB5E00">return</font> <font color="#000000">1</font>
    <font color="#EB5E00">else</font><font color="#000000">:</font> <font color="#EB5E00">return</font> <font color="#000000">0</font>

<font color="#EB5E00">def</font> <font color="#0000FF">isListofLists</font><font color="#000000">(</font><font color="#000000">d</font><font color="#000000">)</font><font color="#000000">:</font>
    <font color="#008800">"returns 1 if input is a list, and 1st item in input is also a list"</font>
    <font color="#008800">"actually works for tuples as well. Only checks 1st element "</font>
    <font color="#EB5E00">if</font> <font color="#EB5E00">not</font> <font color="#000000">isListorTuple</font><font color="#000000">(</font><font color="#000000">d</font><font color="#000000">)</font><font color="#000000">:</font>
        <font color="#EB5E00">return</font> <font color="#000000">0</font>
    <font color="#EB5E00">if</font> <font color="#000000">len</font><font color="#000000">(</font><font color="#000000">d</font><font color="#000000">)</font> <font color="#000000">&lt;</font> <font color="#000000">1</font><font color="#000000">:</font>
        <font color="#EB5E00">return</font> <font color="#000000">0</font>
    <font color="#EB5E00">if</font> <font color="#000000">isListorTuple</font><font color="#000000">(</font><font color="#000000">d</font><font color="#000000">[</font><font color="#000000">0</font><font color="#000000">]</font><font color="#000000">)</font><font color="#000000">:</font>
        <font color="#EB5E00">return</font> <font color="#000000">1</font>
    <font color="#EB5E00">else</font><font color="#000000">:</font>
        <font color="#EB5E00">return</font> <font color="#000000">0</font>

<font color="#EB5E00">def</font> <font color="#0000FF">getLastDocfileKey</font><font color="#000000">(</font><font color="#000000">docfile</font><font color="#000000">)</font><font color="#000000">:</font>
    <font color="#008800">"return the last key of a doc file"</font>
    <font color="#EB5E00">if</font> <font color="#EB5E00">not</font> <font color="#000000">os</font><font color="#000000">.</font><font color="#000000">path</font><font color="#000000">.</font><font color="#000000">exists</font><font color="#000000">(</font><font color="#000000">docfile</font><font color="#000000">)</font><font color="#000000">:</font>
        <font color="#EB5E00">return</font> <font color="#000000">None</font>
    <font color="#000000">cmd</font> <font color="#000000">=</font> <font color="#008800">'tail %s'</font> <font color="#000000">%</font> <font color="#000000">docfile</font>
    <font color="#000000">res</font> <font color="#000000">=</font> <font color="#000000">getoutput</font><font color="#000000">(</font><font color="#000000">cmd</font><font color="#000000">)</font>
    <font color="#000000">s</font> <font color="#000000">=</font> <font color="#000000">res</font><font color="#000000">.</font><font color="#000000">split</font><font color="#000000">(</font><font color="#008800">"\n"</font><font color="#000000">)</font>
    <font color="#000000">s</font><font color="#000000">.</font><font color="#000000">reverse</font><font color="#000000">(</font><font color="#000000">)</font>

    <font color="#EB5E00">for</font> <font color="#000000">line</font> <font color="#EB5E00">in</font> <font color="#000000">s</font><font color="#000000">:</font>
        <font color="#EB5E00">if</font> <font color="#000000">len</font><font color="#000000">(</font><font color="#000000">line</font><font color="#000000">)</font> <font color="#000000">&gt;</font> <font color="#000000">1</font> <font color="#EB5E00">and</font> <font color="#000000">line</font><font color="#000000">[</font><font color="#000000">1</font><font color="#000000">]</font> <font color="#000000">!=</font> <font color="#008800">";"</font><font color="#000000">:</font>
            <font color="#000000">ss</font> <font color="#000000">=</font> <font color="#000000">line</font><font color="#000000">.</font><font color="#000000">split</font><font color="#000000">(</font><font color="#000000">)</font>
            <font color="#EB5E00">try</font><font color="#000000">:</font>
                <font color="#000000">i</font> <font color="#000000">=</font> <font color="#000000">int</font><font color="#000000">(</font><font color="#000000">ss</font><font color="#000000">[</font><font color="#000000">0</font><font color="#000000">]</font><font color="#000000">)</font>
                <font color="#EB5E00">return</font> <font color="#000000">i</font>
            <font color="#EB5E00">except</font><font color="#000000">:</font>
                <font color="#EB5E00">pass</font>
    <font color="#EB5E00">return</font> <font color="#000000">None</font>
<font color="#FF0000"># --------------------------------------------------------------
</font><font color="#FF0000"># writedoc 
</font><font color="#FF0000">#    Data can be organized as columns or line. Call to writedoc should
</font><font color="#FF0000">#    use EITHER columns OR lines.
</font><font color="#FF0000">#    Data must be integer or float. (they can be in string format)
</font><font color="#FF0000">#    columns: a list of lists; each doc file column is a list
</font><font color="#FF0000">#    lines : a list of lists; each doc file line is a list (w/o key)
</font><font color="#FF0000">#    headers: a list of strings
</font><font color="#FF0000">#
</font><font color="#FF0000"># todo: check if columns have different lengths
</font><font color="#EB5E00">def</font> <font color="#0000FF">writedoc</font><font color="#000000">(</font><font color="#000000">filename</font><font color="#000000">,</font> <font color="#000000">columns</font><font color="#000000">=</font><font color="#000000">None</font><font color="#000000">,</font> <font color="#000000">lines</font><font color="#000000">=</font><font color="#000000">None</font><font color="#000000">,</font> <font color="#000000">headers</font><font color="#000000">=</font><font color="#000000">None</font><font color="#000000">,</font> <font color="#000000">keys</font><font color="#000000">=</font><font color="#000000">None</font><font color="#000000">,</font> <font color="#000000">mode</font><font color="#000000">=</font><font color="#008800">'w'</font><font color="#000000">)</font><font color="#000000">:</font>
    <font color="#008800">"write data to a file in SPIDER document file format"</font>
    <font color="#EB5E00">if</font> <font color="#EB5E00">not</font> <font color="#000000">isListofLists</font><font color="#000000">(</font><font color="#000000">columns</font><font color="#000000">)</font> <font color="#EB5E00">and</font> <font color="#EB5E00">not</font> <font color="#000000">isListofLists</font><font color="#000000">(</font><font color="#000000">lines</font><font color="#000000">)</font><font color="#000000">:</font>
        <font color="#EB5E00">if</font> <font color="#000000">isDictionary</font><font color="#000000">(</font><font color="#000000">columns</font><font color="#000000">)</font><font color="#000000">:</font>
            <font color="#EB5E00">return</font> <font color="#000000">writeSpiderDocFile</font><font color="#000000">(</font><font color="#000000">filename</font><font color="#000000">,</font> <font color="#000000">columns</font><font color="#000000">,</font> <font color="#000000">headers</font><font color="#000000">=</font><font color="#000000">headers</font><font color="#000000">,</font> <font color="#000000">mode</font><font color="#000000">=</font><font color="#000000">mode</font><font color="#000000">)</font>
        <font color="#EB5E00">else</font><font color="#000000">:</font>
            <font color="#EB5E00">print</font> <font color="#008800">"writedoc: columns or lines must be a list of lists"</font>
            <font color="#EB5E00">return</font>

    <font color="#008800">"filename must have data extension"</font>
    <font color="#EB5E00">try</font><font color="#000000">:</font>
        <font color="#000000">fp</font> <font color="#000000">=</font> <font color="#000000">open</font><font color="#000000">(</font><font color="#000000">filename</font><font color="#000000">,</font> <font color="#000000">mode</font><font color="#000000">)</font>
    <font color="#EB5E00">except</font><font color="#000000">:</font>
        <font color="#EB5E00">print</font> <font color="#008800">"Unable to open %s for writing."</font> <font color="#000000">%</font> <font color="#000000">filename</font>
        <font color="#EB5E00">return</font>

    <font color="#FF0000"># write Spider doc file header
</font>    <font color="#000000">lastkey</font> <font color="#000000">=</font> <font color="#000000">None</font>
    <font color="#000000">_APPEND</font> <font color="#000000">=</font> <font color="#000000">0</font>
    <font color="#EB5E00">if</font> <font color="#000000">mode</font> <font color="#000000">==</font> <font color="#008800">'w'</font><font color="#000000">:</font>
        <font color="#000000">hdr</font> <font color="#000000">=</font> <font color="#000000">makeDocfileHeader</font><font color="#000000">(</font><font color="#000000">os</font><font color="#000000">.</font><font color="#000000">path</font><font color="#000000">.</font><font color="#000000">basename</font><font color="#000000">(</font><font color="#000000">filename</font><font color="#000000">)</font><font color="#000000">)</font>
        <font color="#000000">fp</font><font color="#000000">.</font><font color="#000000">write</font><font color="#000000">(</font><font color="#000000">hdr</font><font color="#000000">)</font>
    <font color="#EB5E00">elif</font> <font color="#000000">mode</font> <font color="#000000">==</font> <font color="#008800">'a'</font><font color="#000000">:</font>
        <font color="#000000">_APPEND</font> <font color="#000000">=</font> <font color="#000000">1</font>
        <font color="#EB5E00">try</font><font color="#000000">:</font>
            <font color="#000000">lastkey</font> <font color="#000000">=</font> <font color="#000000">getLastDocfileKey</font><font color="#000000">(</font><font color="#000000">filename</font><font color="#000000">)</font>
        <font color="#EB5E00">except</font><font color="#000000">:</font>
            <font color="#EB5E00">pass</font>
    <font color="#FF0000"># write column headings
</font>    <font color="#EB5E00">if</font> <font color="#000000">headers</font> <font color="#000000">!=</font> <font color="#000000">None</font> <font color="#EB5E00">and</font> <font color="#000000">type</font><font color="#000000">(</font><font color="#000000">headers</font><font color="#000000">)</font> <font color="#000000">==</font> <font color="#000000">type</font><font color="#000000">(</font><font color="#000000">[</font><font color="#008800">"list"</font><font color="#000000">]</font><font color="#000000">)</font><font color="#000000">:</font>
        <font color="#000000">fp</font><font color="#000000">.</font><font color="#000000">write</font><font color="#000000">(</font><font color="#000000">fixHeaders</font><font color="#000000">(</font><font color="#000000">headers</font><font color="#000000">)</font><font color="#000000">)</font>

    <font color="#000000">datalines</font> <font color="#000000">=</font> <font color="#000000">[</font><font color="#000000">]</font>

    <font color="#FF0000"># write data columns
</font>    <font color="#EB5E00">if</font> <font color="#000000">columns</font> <font color="#000000">!=</font> <font color="#000000">None</font><font color="#000000">:</font>
        <font color="#000000">ncol</font> <font color="#000000">=</font> <font color="#000000">len</font><font color="#000000">(</font><font color="#000000">columns</font><font color="#000000">)</font>  <font color="#FF0000"># number of columns</font>
        <font color="#000000">n</font> <font color="#000000">=</font> <font color="#000000">len</font><font color="#000000">(</font><font color="#000000">columns</font><font color="#000000">[</font><font color="#000000">0</font><font color="#000000">]</font><font color="#000000">)</font>  <font color="#FF0000"># length of 1st column (assumes all have same length)</font>
        <font color="#EB5E00">if</font> <font color="#000000">keys</font> <font color="#000000">==</font> <font color="#000000">None</font><font color="#000000">:</font>
            <font color="#EB5E00">if</font> <font color="#000000">lastkey</font> <font color="#000000">==</font> <font color="#000000">None</font><font color="#000000">:</font>
                <font color="#000000">keys</font> <font color="#000000">=</font> <font color="#000000">range</font><font color="#000000">(</font><font color="#000000">1</font><font color="#000000">,</font><font color="#000000">n</font><font color="#000000">+</font><font color="#000000">1</font><font color="#000000">)</font>
            <font color="#EB5E00">else</font><font color="#000000">:</font>
                <font color="#000000">keys</font> <font color="#000000">=</font> <font color="#000000">range</font><font color="#000000">(</font><font color="#000000">lastkey</font><font color="#000000">+</font><font color="#000000">1</font><font color="#000000">,</font> <font color="#000000">lastkey</font><font color="#000000">+</font><font color="#000000">n</font><font color="#000000">+</font><font color="#000000">1</font><font color="#000000">)</font>

        <font color="#EB5E00">for</font> <font color="#000000">i</font> <font color="#EB5E00">in</font> <font color="#000000">range</font><font color="#000000">(</font><font color="#000000">n</font><font color="#000000">)</font><font color="#000000">:</font>
            <font color="#000000">dstr</font> <font color="#000000">=</font> <font color="#008800">"%5d %2d"</font> <font color="#000000">%</font> <font color="#000000">(</font><font color="#000000">int</font><font color="#000000">(</font><font color="#000000">keys</font><font color="#000000">[</font><font color="#000000">i</font><font color="#000000">]</font><font color="#000000">)</font><font color="#000000">,</font> <font color="#000000">int</font><font color="#000000">(</font><font color="#000000">ncol</font><font color="#000000">)</font><font color="#000000">)</font>
            <font color="#EB5E00">for</font> <font color="#000000">j</font> <font color="#EB5E00">in</font> <font color="#000000">range</font><font color="#000000">(</font><font color="#000000">ncol</font><font color="#000000">)</font><font color="#000000">:</font>
                <font color="#000000">dstr</font> <font color="#000000">+=</font> <font color="#008800">" %11g"</font> <font color="#000000">%</font> <font color="#000000">float</font><font color="#000000">(</font><font color="#000000">columns</font><font color="#000000">[</font><font color="#000000">j</font><font color="#000000">]</font><font color="#000000">[</font><font color="#000000">i</font><font color="#000000">]</font><font color="#000000">)</font>
            <font color="#000000">datalines</font><font color="#000000">.</font><font color="#000000">append</font><font color="#000000">(</font><font color="#000000">dstr</font><font color="#000000">+</font><font color="#008800">"\n"</font><font color="#000000">)</font>

    <font color="#FF0000"># write data lines
</font>    <font color="#EB5E00">elif</font> <font color="#000000">lines</font> <font color="#000000">!=</font> <font color="#000000">None</font><font color="#000000">:</font>
        <font color="#000000">n</font> <font color="#000000">=</font> <font color="#000000">len</font><font color="#000000">(</font><font color="#000000">lines</font><font color="#000000">)</font>       <font color="#FF0000"># number of lines</font>
        <font color="#EB5E00">if</font> <font color="#000000">keys</font> <font color="#000000">==</font> <font color="#000000">None</font><font color="#000000">:</font>
            <font color="#EB5E00">if</font> <font color="#000000">lastkey</font> <font color="#000000">==</font> <font color="#000000">None</font><font color="#000000">:</font>
                <font color="#000000">keys</font> <font color="#000000">=</font> <font color="#000000">range</font><font color="#000000">(</font><font color="#000000">1</font><font color="#000000">,</font><font color="#000000">n</font><font color="#000000">+</font><font color="#000000">1</font><font color="#000000">)</font>
            <font color="#EB5E00">else</font><font color="#000000">:</font>
                <font color="#000000">keys</font> <font color="#000000">=</font> <font color="#000000">range</font><font color="#000000">(</font><font color="#000000">lastkey</font><font color="#000000">+</font><font color="#000000">1</font><font color="#000000">,</font> <font color="#000000">lastkey</font><font color="#000000">+</font><font color="#000000">n</font><font color="#000000">+</font><font color="#000000">1</font><font color="#000000">)</font>

        <font color="#EB5E00">for</font> <font color="#000000">i</font> <font color="#EB5E00">in</font> <font color="#000000">range</font><font color="#000000">(</font><font color="#000000">n</font><font color="#000000">)</font><font color="#000000">:</font>
            <font color="#000000">line</font> <font color="#000000">=</font> <font color="#000000">lines</font><font color="#000000">[</font><font color="#000000">i</font><font color="#000000">]</font>
            <font color="#000000">ncol</font> <font color="#000000">=</font> <font color="#000000">len</font><font color="#000000">(</font><font color="#000000">line</font><font color="#000000">)</font> <font color="#FF0000"># number of columns</font>
            <font color="#000000">dstr</font> <font color="#000000">=</font> <font color="#008800">"%5d %2d"</font> <font color="#000000">%</font> <font color="#000000">(</font><font color="#000000">int</font><font color="#000000">(</font><font color="#000000">keys</font><font color="#000000">[</font><font color="#000000">i</font><font color="#000000">]</font><font color="#000000">)</font><font color="#000000">,</font> <font color="#000000">ncol</font><font color="#000000">)</font>
            <font color="#EB5E00">for</font> <font color="#000000">item</font> <font color="#EB5E00">in</font> <font color="#000000">line</font><font color="#000000">:</font>
                <font color="#000000">dstr</font> <font color="#000000">+=</font> <font color="#008800">" %11g"</font> <font color="#000000">%</font> <font color="#000000">float</font><font color="#000000">(</font><font color="#000000">item</font><font color="#000000">)</font>
            <font color="#000000">datalines</font><font color="#000000">.</font><font color="#000000">append</font><font color="#000000">(</font><font color="#000000">dstr</font><font color="#000000">+</font><font color="#008800">"\n"</font><font color="#000000">)</font>

    <font color="#000000">fp</font><font color="#000000">.</font><font color="#000000">writelines</font><font color="#000000">(</font><font color="#000000">datalines</font><font color="#000000">)</font>
    <font color="#000000">fp</font><font color="#000000">.</font><font color="#000000">close</font><font color="#000000">(</font><font color="#000000">)</font>

    <font color="#EB5E00">if</font> <font color="#EB5E00">not</font> <font color="#000000">_APPEND</font><font color="#000000">:</font> <font color="#FF0000"># i.e. it's a new doc file</font>
        <font color="#000000">writeSpireoutFile</font><font color="#000000">(</font><font color="#000000">filename</font><font color="#000000">)</font>

<font color="#FF0000">#included for compatibiity:
</font><font color="#FF0000"># data must be in dictionary form: D[key] = [list of column values]
</font><font color="#EB5E00">def</font> <font color="#0000FF">writeSpiderDocFile</font><font color="#000000">(</font><font color="#000000">filename</font><font color="#000000">,</font> <font color="#000000">data</font><font color="#000000">,</font> <font color="#000000">headers</font><font color="#000000">=</font><font color="#000000">None</font><font color="#000000">,</font> <font color="#000000">append</font><font color="#000000">=</font><font color="#000000">0</font><font color="#000000">,</font> <font color="#000000">mode</font><font color="#000000">=</font><font color="#008800">'w'</font><font color="#000000">)</font><font color="#000000">:</font>
    <font color="#008800">"write data (in dictionary form) to a file in SPIDER document file format"</font>
    <font color="#EB5E00">if</font> <font color="#000000">append</font> <font color="#000000">&gt;</font> <font color="#000000">0</font><font color="#000000">:</font> <font color="#000000">mode</font> <font color="#000000">=</font> <font color="#008800">'a'</font>
    <font color="#EB5E00">if</font> <font color="#000000">mode</font> <font color="#000000">==</font> <font color="#008800">'a'</font><font color="#000000">:</font> <font color="#000000">_APPEND</font> <font color="#000000">=</font> <font color="#000000">1</font>
    <font color="#EB5E00">else</font><font color="#000000">:</font> <font color="#000000">_APPEND</font> <font color="#000000">=</font> <font color="#000000">0</font>

    <font color="#EB5E00">if</font> <font color="#EB5E00">not</font> <font color="#000000">isDictionary</font><font color="#000000">(</font><font color="#000000">data</font><font color="#000000">)</font><font color="#000000">:</font>
        <font color="#FF0000"># if it's not a dictionary, see if it's a list of lists
</font>        <font color="#EB5E00">if</font> <font color="#000000">isListofLists</font><font color="#000000">(</font><font color="#000000">data</font><font color="#000000">)</font><font color="#000000">:</font>
            <font color="#EB5E00">return</font> <font color="#000000">writedoc</font><font color="#000000">(</font><font color="#000000">filename</font><font color="#000000">,</font> <font color="#000000">columns</font><font color="#000000">=</font><font color="#000000">data</font><font color="#000000">,</font> <font color="#000000">headers</font><font color="#000000">=</font><font color="#000000">headers</font><font color="#000000">,</font> <font color="#000000">mode</font><font color="#000000">=</font><font color="#000000">mode</font><font color="#000000">)</font>
        <font color="#EB5E00">else</font><font color="#000000">:</font>
            <font color="#EB5E00">return</font> <font color="#000000">0</font>
    <font color="#EB5E00">try</font><font color="#000000">:</font>
        <font color="#000000">fp</font> <font color="#000000">=</font> <font color="#000000">open</font><font color="#000000">(</font><font color="#000000">filename</font><font color="#000000">,</font> <font color="#000000">mode</font><font color="#000000">)</font>
    <font color="#EB5E00">except</font><font color="#000000">:</font>
      <font color="#EB5E00">print</font> <font color="#008800">"unable to open %s for writing"</font> <font color="#000000">%</font> <font color="#000000">filename</font>
      <font color="#EB5E00">return</font> <font color="#000000">0</font>
    <font color="#FF0000"># write Spider doc file header
</font>    <font color="#000000">hdr</font> <font color="#000000">=</font> <font color="#000000">makeDocfileHeader</font><font color="#000000">(</font><font color="#000000">os</font><font color="#000000">.</font><font color="#000000">path</font><font color="#000000">.</font><font color="#000000">basename</font><font color="#000000">(</font><font color="#000000">filename</font><font color="#000000">)</font><font color="#000000">)</font>
    <font color="#000000">fp</font><font color="#000000">.</font><font color="#000000">write</font><font color="#000000">(</font><font color="#000000">hdr</font><font color="#000000">)</font>
    <font color="#FF0000"># and any column headings
</font>    <font color="#EB5E00">if</font> <font color="#000000">headers</font> <font color="#000000">!=</font> <font color="#000000">None</font> <font color="#EB5E00">and</font> <font color="#000000">type</font><font color="#000000">(</font><font color="#000000">headers</font><font color="#000000">)</font> <font color="#000000">==</font> <font color="#000000">type</font><font color="#000000">(</font><font color="#000000">[</font><font color="#008800">"list"</font><font color="#000000">]</font><font color="#000000">)</font><font color="#000000">:</font>
        <font color="#000000">fp</font><font color="#000000">.</font><font color="#000000">write</font><font color="#000000">(</font><font color="#000000">fixHeaders</font><font color="#000000">(</font><font color="#000000">headers</font><font color="#000000">)</font><font color="#000000">)</font>

    <font color="#FF0000"># write data
</font>    <font color="#000000">keys</font> <font color="#000000">=</font> <font color="#000000">data</font><font color="#000000">.</font><font color="#000000">keys</font><font color="#000000">(</font><font color="#000000">)</font>
    <font color="#000000">keys</font><font color="#000000">.</font><font color="#000000">sort</font><font color="#000000">(</font><font color="#000000">)</font>
    <font color="#EB5E00">if</font> <font color="#000000">len</font><font color="#000000">(</font><font color="#000000">keys</font><font color="#000000">)</font> <font color="#000000">&gt;</font> <font color="#000000">0</font><font color="#000000">:</font>
        <font color="#000000">firstkey</font> <font color="#000000">=</font> <font color="#000000">keys</font><font color="#000000">[</font><font color="#000000">0</font><font color="#000000">]</font>
        <font color="#EB5E00">if</font> <font color="#000000">firstkey</font> <font color="#EB5E00">in</font> <font color="#000000">data</font><font color="#000000">:</font>
            <font color="#000000">v1</font> <font color="#000000">=</font> <font color="#000000">data</font><font color="#000000">[</font><font color="#000000">firstkey</font><font color="#000000">]</font>
        <font color="#EB5E00">else</font><font color="#000000">:</font>
            <font color="#EB5E00">print</font> <font color="#008800">"writeSpiderDocFile: key not found in data"</font>
    <font color="#EB5E00">else</font><font color="#000000">:</font>
        <font color="#EB5E00">print</font> <font color="#008800">"writeSpiderDocFile: empty data dictionary"</font>
        <font color="#EB5E00">return</font> <font color="#000000">0</font>

    <font color="#EB5E00">if</font> <font color="#000000">isinstance</font><font color="#000000">(</font><font color="#000000">v1</font><font color="#000000">,</font> <font color="#000000">ListType</font><font color="#000000">)</font><font color="#000000">:</font>
        <font color="#EB5E00">for</font> <font color="#000000">key</font> <font color="#EB5E00">in</font> <font color="#000000">keys</font><font color="#000000">:</font>
            <font color="#000000">values</font> <font color="#000000">=</font> <font color="#000000">data</font><font color="#000000">[</font><font color="#000000">key</font><font color="#000000">]</font>
            <font color="#000000">n</font> <font color="#000000">=</font> <font color="#000000">len</font><font color="#000000">(</font><font color="#000000">values</font><font color="#000000">)</font>
            <font color="#000000">h</font> <font color="#000000">=</font> <font color="#008800">"%5d %2d "</font> <font color="#000000">%</font> <font color="#000000">(</font><font color="#000000">int</font><font color="#000000">(</font><font color="#000000">key</font><font color="#000000">)</font><font color="#000000">,</font><font color="#000000">int</font><font color="#000000">(</font><font color="#000000">n</font><font color="#000000">)</font><font color="#000000">)</font>
            <font color="#EB5E00">for</font> <font color="#000000">value</font> <font color="#EB5E00">in</font> <font color="#000000">values</font><font color="#000000">:</font>
                <font color="#000000">h</font> <font color="#000000">+=</font> <font color="#008800">" %11g "</font> <font color="#000000">%</font> <font color="#000000">(</font><font color="#000000">float</font><font color="#000000">(</font><font color="#000000">value</font><font color="#000000">)</font><font color="#000000">)</font>
            <font color="#000000">fp</font><font color="#000000">.</font><font color="#000000">write</font><font color="#000000">(</font><font color="#000000">h</font><font color="#000000">+</font><font color="#008800">"\n"</font><font color="#000000">)</font>
    <font color="#EB5E00">else</font><font color="#000000">:</font>
        <font color="#FF0000"># it's supposed to be a list! But if it's not..
</font>        <font color="#EB5E00">for</font> <font color="#000000">key</font> <font color="#EB5E00">in</font> <font color="#000000">keys</font><font color="#000000">:</font>
            <font color="#000000">value</font> <font color="#000000">=</font> <font color="#000000">data</font><font color="#000000">[</font><font color="#000000">key</font><font color="#000000">]</font>
            <font color="#EB5E00">try</font><font color="#000000">:</font>
                <font color="#000000">f</font> <font color="#000000">=</font> <font color="#000000">float</font><font color="#000000">(</font><font color="#000000">value</font><font color="#000000">)</font>
            <font color="#EB5E00">except</font><font color="#000000">:</font>
                <font color="#EB5E00">print</font> <font color="#008800">"writedoc: unable to convert %s"</font> <font color="#000000">%</font> <font color="#000000">str</font><font color="#000000">(</font><font color="#000000">value</font><font color="#000000">)</font>
                <font color="#EB5E00">print</font> <font color="#008800">"writedoc: Dictionary elements must be lists!"</font>
                <font color="#EB5E00">return</font> <font color="#000000">0</font>
            <font color="#000000">h</font> <font color="#000000">=</font> <font color="#008800">"%5d %2d %11g\n"</font> <font color="#000000">%</font> <font color="#000000">(</font><font color="#000000">int</font><font color="#000000">(</font><font color="#000000">key</font><font color="#000000">)</font><font color="#000000">,</font> <font color="#000000">1</font><font color="#000000">,</font> <font color="#000000">f</font><font color="#000000">)</font>
            <font color="#000000">fp</font><font color="#000000">.</font><font color="#000000">write</font><font color="#000000">(</font><font color="#000000">h</font><font color="#000000">)</font>

    <font color="#000000">fp</font><font color="#000000">.</font><font color="#000000">close</font><font color="#000000">(</font><font color="#000000">)</font>
    <font color="#EB5E00">if</font> <font color="#EB5E00">not</font> <font color="#000000">_APPEND</font><font color="#000000">:</font> <font color="#FF0000"># i.e. it's a new doc file</font>
        <font color="#000000">writeSpireoutFile</font><font color="#000000">(</font><font color="#000000">filename</font><font color="#000000">)</font>
    <font color="#EB5E00">return</font> <font color="#000000">1</font>

<font color="#EB5E00">def</font> <font color="#0000FF">writeSpireoutFile</font><font color="#000000">(</font><font color="#000000">filename</font><font color="#000000">)</font><font color="#000000">:</font>
    <font color="#FF0000"># this section added Aug 2006, for Spire compatibility
</font>    <font color="#EB5E00">if</font> <font color="#000000">WRITE_SPIREOUT</font> <font color="#EB5E00">in</font> <font color="#000000">os</font><font color="#000000">.</font><font color="#000000">environ</font><font color="#000000">:</font>
        <font color="#000000">spireout</font> <font color="#000000">=</font> <font color="#000000">os</font><font color="#000000">.</font><font color="#000000">environ</font><font color="#000000">[</font><font color="#000000">WRITE_SPIREOUT</font><font color="#000000">]</font>
        <font color="#EB5E00">if</font> <font color="#000000">os</font><font color="#000000">.</font><font color="#000000">path</font><font color="#000000">.</font><font color="#000000">exists</font><font color="#000000">(</font><font color="#000000">spireout</font><font color="#000000">)</font><font color="#000000">:</font>
            <font color="#000000">fp</font> <font color="#000000">=</font> <font color="#000000">open</font><font color="#000000">(</font><font color="#000000">spireout</font><font color="#000000">,</font> <font color="#000000">mode</font><font color="#000000">=</font><font color="#008800">'a'</font><font color="#000000">)</font>
        <font color="#EB5E00">else</font><font color="#000000">:</font>
            <font color="#000000">fp</font> <font color="#000000">=</font> <font color="#000000">open</font><font color="#000000">(</font><font color="#000000">spireout</font><font color="#000000">,</font> <font color="#000000">mode</font><font color="#000000">=</font><font color="#008800">'w'</font><font color="#000000">)</font>
        <font color="#000000">date</font><font color="#000000">,</font> <font color="#000000">time</font><font color="#000000">,</font> <font color="#000000">id</font> <font color="#000000">=</font> <font color="#000000">nowisthetime</font><font color="#000000">(</font><font color="#000000">)</font>
        <font color="#000000">fn</font> <font color="#000000">=</font> <font color="#000000">os</font><font color="#000000">.</font><font color="#000000">path</font><font color="#000000">.</font><font color="#000000">basename</font><font color="#000000">(</font><font color="#000000">filename</font><font color="#000000">)</font>
        <font color="#000000">s</font> <font color="#000000">=</font> <font color="#008800">"  %s AT %s    OPENED NEW DOC FILE: %s\n"</font> <font color="#000000">%</font> <font color="#000000">(</font><font color="#000000">date</font><font color="#000000">,</font> <font color="#000000">time</font><font color="#000000">,</font> <font color="#000000">fn</font><font color="#000000">)</font>
        <font color="#000000">fp</font><font color="#000000">.</font><font color="#000000">write</font><font color="#000000">(</font><font color="#000000">s</font><font color="#000000">)</font>
        <font color="#000000">fp</font><font color="#000000">.</font><font color="#000000">close</font><font color="#000000">(</font><font color="#000000">)</font>

<font color="#FF0000">###################################################################
</font><font color="#FF0000"># convenience functions
</font><font color="#FF0000">#
</font><font color="#EB5E00">def</font> <font color="#0000FF">list2int</font><font color="#000000">(</font><font color="#000000">a</font><font color="#000000">)</font><font color="#000000">:</font>
    <font color="#008800">" converts a list of strings to integers"</font>
    <font color="#EB5E00">return</font> <font color="#000000">map</font><font color="#000000">(</font><font color="#000000">int</font><font color="#000000">,</font> <font color="#000000">map</font><font color="#000000">(</font><font color="#000000">float</font><font color="#000000">,</font><font color="#000000">a</font><font color="#000000">)</font><font color="#000000">)</font>

<font color="#EB5E00">def</font> <font color="#0000FF">list2float</font><font color="#000000">(</font><font color="#000000">a</font><font color="#000000">)</font><font color="#000000">:</font>
    <font color="#008800">" converts a list of strings to floats"</font>
    <font color="#EB5E00">return</font> <font color="#000000">map</font><font color="#000000">(</font><font color="#000000">float</font><font color="#000000">,</font><font color="#000000">a</font><font color="#000000">)</font>

<font color="#FF0000"># given ("mic****", 89) returns "mic0089"
</font><font color="#FF0000"># Substitutes the first set of asterisks it finds (i.e. leftmost).
</font><font color="#FF0000"># If number of *'s too small for number, filename is extended.
</font><font color="#FF0000"># asterisks can be replaced by another char
</font><font color="#EB5E00">def</font> <font color="#0000FF">makeFilename</font><font color="#000000">(</font><font color="#000000">filename</font><font color="#000000">,</font> <font color="#000000">n</font><font color="#000000">,</font> <font color="#000000">char</font><font color="#000000">=</font><font color="#008800">'*'</font><font color="#000000">)</font><font color="#000000">:</font>
    <font color="#008800">"substitutes asterisks for number: ('mic****', 89) returns 'mic0089'"</font>
    <font color="#EB5E00">try</font><font color="#000000">:</font>
        <font color="#000000">n</font> <font color="#000000">=</font> <font color="#000000">int</font><font color="#000000">(</font><font color="#000000">float</font><font color="#000000">(</font><font color="#000000">n</font><font color="#000000">)</font><font color="#000000">)</font>
    <font color="#EB5E00">except</font><font color="#000000">:</font>
        <font color="#EB5E00">print</font> <font color="#008800">"makeFilename: unable to convert %s to integer"</font> <font color="#000000">%</font> <font color="#000000">str</font><font color="#000000">(</font><font color="#000000">n</font><font color="#000000">)</font>
    <font color="#000000">number</font> <font color="#000000">=</font> <font color="#000000">str</font><font color="#000000">(</font><font color="#000000">n</font><font color="#000000">)</font>

    <font color="#000000">re_findchar</font> <font color="#000000">=</font> <font color="#000000">re</font><font color="#000000">.</font><font color="#000000">compile</font><font color="#000000">(</font><font color="#008800">'[%s]+'</font> <font color="#000000">%</font> <font color="#000000">char</font><font color="#000000">)</font>

    <font color="#000000">a</font> <font color="#000000">=</font> <font color="#000000">re_findchar</font><font color="#000000">.</font><font color="#000000">search</font><font color="#000000">(</font><font color="#000000">filename</font><font color="#000000">)</font>
    <font color="#EB5E00">if</font> <font color="#EB5E00">not</font> <font color="#000000">a</font><font color="#000000">:</font>
        <font color="#EB5E00">print</font> <font color="#008800">"makeFilename: no '%s' found in %s"</font> <font color="#000000">%</font> <font color="#000000">(</font><font color="#000000">char</font><font color="#000000">,</font> <font color="#000000">filename</font><font color="#000000">)</font>
        <font color="#EB5E00">return</font> <font color="#008800">""</font>

    <font color="#000000">(</font><font color="#000000">start</font><font color="#000000">,</font><font color="#000000">end</font><font color="#000000">)</font> <font color="#000000">=</font>  <font color="#000000">a</font><font color="#000000">.</font><font color="#000000">span</font><font color="#000000">(</font><font color="#000000">)</font>
    <font color="#000000">sp</font> <font color="#000000">=</font> <font color="#000000">(</font><font color="#000000">end</font> <font color="#000000">-</font> <font color="#000000">start</font><font color="#000000">)</font>
    <font color="#000000">num</font> <font color="#000000">=</font> <font color="#000000">number</font><font color="#000000">.</font><font color="#000000">zfill</font><font color="#000000">(</font><font color="#000000">sp</font><font color="#000000">)</font>  <font color="#FF0000"># pad the numeric string with zeroes out to req. length</font>
    <font color="#000000">f</font> <font color="#000000">=</font> <font color="#000000">filename</font><font color="#000000">[</font><font color="#000000">:</font><font color="#000000">start</font><font color="#000000">]</font> <font color="#000000">+</font> <font color="#000000">num</font> <font color="#000000">+</font> <font color="#000000">filename</font><font color="#000000">[</font><font color="#000000">end</font><font color="#000000">:</font><font color="#000000">]</font>
    <font color="#EB5E00">return</font> <font color="#000000">f</font>

<font color="#000000">re_asterisk</font> <font color="#000000">=</font> <font color="#000000">re</font><font color="#000000">.</font><font color="#000000">compile</font><font color="#000000">(</font><font color="#008800">'[*]+'</font><font color="#000000">)</font>

<font color="#FF0000"># old version of makeFilename included for compatibility
</font><font color="#EB5E00">def</font> <font color="#0000FF">makeSpiderFilename</font><font color="#000000">(</font><font color="#000000">filename</font><font color="#000000">,</font> <font color="#000000">n</font><font color="#000000">)</font><font color="#000000">:</font>
    <font color="#008800">"substitutes asterisks for number: ('mic****', 89) returns 'mic0089'"</font>
    <font color="#EB5E00">try</font><font color="#000000">:</font>
        <font color="#000000">n</font> <font color="#000000">=</font> <font color="#000000">int</font><font color="#000000">(</font><font color="#000000">float</font><font color="#000000">(</font><font color="#000000">n</font><font color="#000000">)</font><font color="#000000">)</font>
    <font color="#EB5E00">except</font><font color="#000000">:</font>
        <font color="#EB5E00">print</font> <font color="#008800">"makeSpiderFilename: unable to convert %s to integer"</font> <font color="#000000">%</font> <font color="#000000">str</font><font color="#000000">(</font><font color="#000000">n</font><font color="#000000">)</font>
    <font color="#000000">number</font> <font color="#000000">=</font> <font color="#000000">str</font><font color="#000000">(</font><font color="#000000">n</font><font color="#000000">)</font>

    <font color="#000000">a</font> <font color="#000000">=</font> <font color="#000000">re_asterisk</font><font color="#000000">.</font><font color="#000000">search</font><font color="#000000">(</font><font color="#000000">filename</font><font color="#000000">)</font>
    <font color="#EB5E00">if</font> <font color="#EB5E00">not</font> <font color="#000000">a</font><font color="#000000">:</font>
        <font color="#FF0000">#print "makeSpiderFilename: no asterisks in %s" % filename
</font>        <font color="#EB5E00">return</font> <font color="#000000">filename</font>

    <font color="#000000">(</font><font color="#000000">start</font><font color="#000000">,</font><font color="#000000">end</font><font color="#000000">)</font> <font color="#000000">=</font>  <font color="#000000">a</font><font color="#000000">.</font><font color="#000000">span</font><font color="#000000">(</font><font color="#000000">)</font>
    <font color="#000000">sp</font> <font color="#000000">=</font> <font color="#000000">(</font><font color="#000000">end</font> <font color="#000000">-</font> <font color="#000000">start</font><font color="#000000">)</font>
    <font color="#000000">num</font> <font color="#000000">=</font> <font color="#000000">number</font><font color="#000000">.</font><font color="#000000">zfill</font><font color="#000000">(</font><font color="#000000">sp</font><font color="#000000">)</font>  <font color="#FF0000"># pad the numeric string with zeroes out to req. length</font>
    <font color="#000000">f</font> <font color="#000000">=</font> <font color="#000000">filename</font><font color="#000000">[</font><font color="#000000">:</font><font color="#000000">start</font><font color="#000000">]</font> <font color="#000000">+</font> <font color="#000000">num</font> <font color="#000000">+</font> <font color="#000000">filename</font><font color="#000000">[</font><font color="#000000">end</font><font color="#000000">:</font><font color="#000000">]</font>
    <font color="#EB5E00">return</font> <font color="#000000">f</font>


<font color="#FF0000">###################################################################
</font><font color="#FF0000"># File number routines:
</font><font color="#FF0000">#   filenumber(filename) returns an integer
</font><font color="#FF0000">#   getfilenumber(filename) returns string with leading zeroes
</font><font color="#FF0000">#   name2template(filename) given 'mic021.dat', returns 'mic***.dat'
</font><font color="#FF0000">#   template2filename(template, n) given (pic***.dat, 3) returns pic003.dat
</font><font color="#FF0000">#   numberlist2string(nlist) converts [1,2,3,4,6,8] -&gt; '1-4,6,8'
</font><font color="#FF0000">#   range2list(nrange) given string '1-4', outputs list [1,2,3,4]
</font>
<font color="#FF0000">#re_nums = re.compile('\d+\D?')  # ints followed by one non-int char
</font>
<font color="#EB5E00">def</font> <font color="#0000FF">filenumber</font><font color="#000000">(</font><font color="#000000">file</font><font color="#000000">)</font><font color="#000000">:</font>
    <font color="#008800">"returns file number (integer nearest the file extension)"</font>
    <font color="#EB5E00">if</font> <font color="#000000">len</font><font color="#000000">(</font><font color="#000000">file</font><font color="#000000">)</font> <font color="#000000">==</font> <font color="#000000">0</font><font color="#000000">:</font> <font color="#EB5E00">return</font> <font color="#000000">None</font>
    <font color="#000000">n</font> <font color="#000000">=</font> <font color="#000000">getfilenumber</font><font color="#000000">(</font><font color="#000000">file</font><font color="#000000">)</font>
    <font color="#EB5E00">if</font> <font color="#000000">n</font><font color="#000000">:</font>
        <font color="#EB5E00">return</font> <font color="#000000">int</font><font color="#000000">(</font><font color="#000000">n</font><font color="#000000">)</font>
    <font color="#EB5E00">else</font><font color="#000000">:</font>
        <font color="#EB5E00">return</font> <font color="#000000">None</font>

<font color="#EB5E00">def</font> <font color="#0000FF">getfilenumber</font><font color="#000000">(</font><font color="#000000">filename</font><font color="#000000">)</font><font color="#000000">:</font>
    <font color="#008800">"returns file number as a string with leading zeroes "</font>
    <font color="#000000">filename</font> <font color="#000000">=</font> <font color="#000000">os</font><font color="#000000">.</font><font color="#000000">path</font><font color="#000000">.</font><font color="#000000">basename</font><font color="#000000">(</font><font color="#000000">filename</font><font color="#000000">)</font>
    <font color="#000000">fname</font><font color="#000000">,</font><font color="#000000">ext</font> <font color="#000000">=</font> <font color="#000000">os</font><font color="#000000">.</font><font color="#000000">path</font><font color="#000000">.</font><font color="#000000">splitext</font><font color="#000000">(</font><font color="#000000">filename</font><font color="#000000">)</font>

    <font color="#000000">numstr</font> <font color="#000000">=</font> <font color="#008800">""</font>
    <font color="#000000">f</font> <font color="#000000">=</font> <font color="#000000">list</font><font color="#000000">(</font><font color="#000000">fname</font><font color="#000000">)</font>
    <font color="#000000">f</font><font color="#000000">.</font><font color="#000000">reverse</font><font color="#000000">(</font><font color="#000000">)</font>
    <font color="#000000">done</font> <font color="#000000">=</font> <font color="#000000">0</font>
    <font color="#EB5E00">for</font> <font color="#000000">ch</font> <font color="#EB5E00">in</font> <font color="#000000">f</font><font color="#000000">:</font>
        <font color="#EB5E00">if</font> <font color="#EB5E00">not</font> <font color="#000000">done</font><font color="#000000">:</font>
            <font color="#EB5E00">try</font><font color="#000000">:</font>
                <font color="#000000">int</font><font color="#000000">(</font><font color="#000000">ch</font><font color="#000000">)</font>
                <font color="#000000">numstr</font> <font color="#000000">=</font> <font color="#000000">ch</font> <font color="#000000">+</font> <font color="#000000">numstr</font>
            <font color="#EB5E00">except</font><font color="#000000">:</font>
                <font color="#EB5E00">if</font> <font color="#000000">numstr</font> <font color="#000000">!=</font> <font color="#008800">""</font><font color="#000000">:</font>
                    <font color="#000000">done</font> <font color="#000000">=</font> <font color="#000000">1</font>
    <font color="#EB5E00">return</font> <font color="#000000">numstr</font>

<font color="#EB5E00">def</font> <font color="#0000FF">name2template</font><font color="#000000">(</font><font color="#000000">filename</font><font color="#000000">,</font> <font color="#000000">all</font><font color="#000000">=</font><font color="#000000">0</font><font color="#000000">)</font><font color="#000000">:</font>
    <font color="#008800">" given 'mic021.dat' --&gt; returns mic***.dat "</font>
    <font color="#008800">" by default, only replaces number nearest extension. all !=0 replaces all"</font>
    <font color="#EB5E00">if</font> <font color="#000000">len</font><font color="#000000">(</font><font color="#000000">filename</font><font color="#000000">)</font> <font color="#000000">==</font> <font color="#000000">0</font><font color="#000000">:</font> <font color="#EB5E00">return</font> <font color="#008800">""</font>
    <font color="#000000">path</font><font color="#000000">,</font> <font color="#000000">basename</font> <font color="#000000">=</font> <font color="#000000">os</font><font color="#000000">.</font><font color="#000000">path</font><font color="#000000">.</font><font color="#000000">split</font><font color="#000000">(</font><font color="#000000">filename</font><font color="#000000">)</font>
    <font color="#000000">fname</font><font color="#000000">,</font><font color="#000000">ext</font> <font color="#000000">=</font> <font color="#000000">os</font><font color="#000000">.</font><font color="#000000">path</font><font color="#000000">.</font><font color="#000000">splitext</font><font color="#000000">(</font><font color="#000000">basename</font><font color="#000000">)</font>

    <font color="#000000">newfn</font> <font color="#000000">=</font> <font color="#008800">""</font>
    <font color="#000000">f</font> <font color="#000000">=</font> <font color="#000000">list</font><font color="#000000">(</font><font color="#000000">fname</font><font color="#000000">)</font>
    <font color="#000000">f</font><font color="#000000">.</font><font color="#000000">reverse</font><font color="#000000">(</font><font color="#000000">)</font>
    <font color="#EB5E00">if</font> <font color="#000000">all</font><font color="#000000">:</font>
        <font color="#EB5E00">for</font> <font color="#000000">ch</font> <font color="#EB5E00">in</font> <font color="#000000">f</font><font color="#000000">:</font>
            <font color="#EB5E00">try</font><font color="#000000">:</font>
                <font color="#000000">int</font><font color="#000000">(</font><font color="#000000">ch</font><font color="#000000">)</font>
                <font color="#000000">newch</font> <font color="#000000">=</font> <font color="#008800">'*'</font>
            <font color="#EB5E00">except</font><font color="#000000">:</font>
                <font color="#000000">newch</font> <font color="#000000">=</font> <font color="#000000">ch</font>
            <font color="#000000">newfn</font> <font color="#000000">=</font> <font color="#000000">newch</font> <font color="#000000">+</font> <font color="#000000">newfn</font>
    <font color="#EB5E00">else</font><font color="#000000">:</font>
        <font color="#000000">found</font> <font color="#000000">=</font> <font color="#000000">0</font>
        <font color="#EB5E00">for</font> <font color="#000000">ch</font> <font color="#EB5E00">in</font> <font color="#000000">f</font><font color="#000000">:</font>
            <font color="#EB5E00">if</font> <font color="#EB5E00">not</font> <font color="#000000">found</font><font color="#000000">:</font>
                <font color="#EB5E00">try</font><font color="#000000">:</font>
                    <font color="#000000">int</font><font color="#000000">(</font><font color="#000000">ch</font><font color="#000000">)</font>
                    <font color="#000000">newch</font> <font color="#000000">=</font> <font color="#008800">'*'</font>
                <font color="#EB5E00">except</font><font color="#000000">:</font>
                    <font color="#000000">newch</font> <font color="#000000">=</font> <font color="#000000">ch</font>
                    <font color="#EB5E00">if</font> <font color="#000000">newfn</font> <font color="#EB5E00">and</font> <font color="#000000">newfn</font><font color="#000000">[</font><font color="#000000">0</font><font color="#000000">]</font> <font color="#000000">==</font> <font color="#008800">'*'</font><font color="#000000">:</font>
                        <font color="#000000">found</font> <font color="#000000">=</font> <font color="#000000">1</font>
            <font color="#EB5E00">else</font><font color="#000000">:</font>
                <font color="#000000">newch</font> <font color="#000000">=</font> <font color="#000000">ch</font>
            <font color="#000000">newfn</font> <font color="#000000">=</font> <font color="#000000">newch</font> <font color="#000000">+</font> <font color="#000000">newfn</font>
    <font color="#000000">fname</font> <font color="#000000">=</font> <font color="#000000">os</font><font color="#000000">.</font><font color="#000000">path</font><font color="#000000">.</font><font color="#000000">join</font><font color="#000000">(</font><font color="#000000">path</font><font color="#000000">,</font><font color="#000000">newfn</font><font color="#000000">)</font> <font color="#000000">+</font> <font color="#000000">ext</font>
    <font color="#EB5E00">return</font> <font color="#000000">fname</font>

<font color="#FF0000"># template should have asterisks, num can be int or a numbered filename.
</font><font color="#FF0000"># Like makeSpiderFilename, but it can accept a filename instead of a number.
</font><font color="#EB5E00">def</font> <font color="#0000FF">template2filename</font><font color="#000000">(</font><font color="#000000">template</font><font color="#000000">,</font> <font color="#000000">n</font><font color="#000000">=</font><font color="#000000">0</font><font color="#000000">)</font><font color="#000000">:</font>  <font color="#FF0000">#numfile=None, n=None):</font>
    <font color="#008800">"replaces asterisks with number: (pic***.dat, doc003.dat) returns pic003.dat"</font>
    <font color="#EB5E00">if</font> <font color="#000000">type</font><font color="#000000">(</font><font color="#000000">n</font><font color="#000000">)</font> <font color="#000000">==</font> <font color="#000000">type</font><font color="#000000">(</font><font color="#000000">1</font><font color="#000000">)</font><font color="#000000">:</font>
        <font color="#EB5E00">pass</font>
    <font color="#EB5E00">elif</font> <font color="#000000">type</font><font color="#000000">(</font><font color="#000000">n</font><font color="#000000">)</font> <font color="#000000">==</font> <font color="#000000">type</font><font color="#000000">(</font><font color="#008800">"string"</font><font color="#000000">)</font><font color="#000000">:</font>
        <font color="#000000">n</font> <font color="#000000">=</font> <font color="#000000">filenumber</font><font color="#000000">(</font><font color="#000000">n</font><font color="#000000">)</font>
    <font color="#EB5E00">else</font><font color="#000000">:</font>
        <font color="#EB5E00">print</font> <font color="#008800">"template2filename: unable to parse input"</font>
        <font color="#EB5E00">return</font> <font color="#008800">""</font>
    <font color="#000000">nstars</font> <font color="#000000">=</font> <font color="#000000">template</font><font color="#000000">.</font><font color="#000000">count</font><font color="#000000">(</font><font color="#008800">"*"</font><font color="#000000">)</font>
    <font color="#EB5E00">if</font> <font color="#000000">nstars</font> <font color="#000000">==</font> <font color="#000000">0</font><font color="#000000">:</font>
        <font color="#EB5E00">return</font> <font color="#000000">template</font>
    <font color="#EB5E00">if</font> <font color="#000000">len</font><font color="#000000">(</font><font color="#000000">str</font><font color="#000000">(</font><font color="#000000">n</font><font color="#000000">)</font><font color="#000000">)</font> <font color="#000000">&gt;</font> <font color="#000000">nstars</font><font color="#000000">:</font>
        <font color="#EB5E00">print</font> <font color="#008800">"template2filename: **** Warning number larger than template"</font>
    <font color="#000000">numstr</font> <font color="#000000">=</font> <font color="#000000">str</font><font color="#000000">(</font><font color="#000000">n</font><font color="#000000">)</font><font color="#000000">.</font><font color="#000000">zfill</font><font color="#000000">(</font><font color="#000000">nstars</font><font color="#000000">)</font>
    <font color="#000000">sts</font> <font color="#000000">=</font> <font color="#008800">"*"</font> <font color="#000000">*</font> <font color="#000000">nstars</font>
    <font color="#000000">filename</font> <font color="#000000">=</font> <font color="#000000">template</font><font color="#000000">.</font><font color="#000000">replace</font><font color="#000000">(</font><font color="#000000">sts</font><font color="#000000">,</font><font color="#000000">numstr</font><font color="#000000">)</font>
    <font color="#EB5E00">return</font> <font color="#000000">filename</font>

<font color="#FF0000"># list2range: hyphenates runs of consecutive intgers.
</font><font color="#FF0000">#     input: list [1,2,3,6,7,8,9,10,11,17]
</font><font color="#FF0000">#     output: list with strings ['1-3', '6-11', '17']
</font><font color="#EB5E00">def</font> <font color="#0000FF">list2range</font><font color="#000000">(</font><font color="#000000">f</font><font color="#000000">)</font><font color="#000000">:</font>
    <font color="#008800">" input is a list of integers "</font>
    <font color="#000000">fn</font> <font color="#000000">=</font> <font color="#000000">[</font><font color="#000000">]</font>
    <font color="#EB5E00">for</font> <font color="#000000">item</font> <font color="#EB5E00">in</font> <font color="#000000">f</font><font color="#000000">:</font>
        <font color="#EB5E00">try</font><font color="#000000">:</font>
            <font color="#000000">fn</font><font color="#000000">.</font><font color="#000000">append</font><font color="#000000">(</font><font color="#000000">int</font><font color="#000000">(</font><font color="#000000">item</font><font color="#000000">)</font><font color="#000000">)</font>
        <font color="#EB5E00">except</font><font color="#000000">:</font>
            <font color="#EB5E00">print</font> <font color="#008800">"list2range: unable to convert %s to integer"</font> <font color="#000000">%</font> <font color="#000000">str</font><font color="#000000">(</font><font color="#000000">item</font><font color="#000000">)</font>
            <font color="#EB5E00">return</font> <font color="#000000">[</font><font color="#000000">]</font>
    <font color="#EB5E00">if</font> <font color="#000000">len</font><font color="#000000">(</font><font color="#000000">fn</font><font color="#000000">)</font> <font color="#000000">&lt;</font> <font color="#000000">1</font><font color="#000000">:</font> <font color="#EB5E00">return</font> <font color="#000000">[</font><font color="#000000">]</font>
    <font color="#000000">fn</font><font color="#000000">.</font><font color="#000000">sort</font><font color="#000000">(</font><font color="#000000">)</font>
    <font color="#000000">N</font> <font color="#000000">=</font> <font color="#000000">[</font><font color="#000000">]</font>
    <font color="#000000">p</font> <font color="#000000">=</font> <font color="#000000">fn</font><font color="#000000">[</font><font color="#000000">0</font><font color="#000000">]</font>
    <font color="#000000">start</font> <font color="#000000">=</font> <font color="#000000">p</font>
    <font color="#000000">n</font> <font color="#000000">=</font> <font color="#000000">p</font>
    <font color="#000000">fn</font> <font color="#000000">=</font> <font color="#000000">fn</font><font color="#000000">[</font><font color="#000000">1</font><font color="#000000">:</font><font color="#000000">]</font>

    <font color="#EB5E00">while</font> <font color="#000000">len</font><font color="#000000">(</font><font color="#000000">fn</font><font color="#000000">)</font> <font color="#000000">&gt;</font> <font color="#000000">0</font><font color="#000000">:</font>
        <font color="#000000">n</font> <font color="#000000">=</font> <font color="#000000">fn</font><font color="#000000">[</font><font color="#000000">0</font><font color="#000000">]</font>
        <font color="#EB5E00">if</font> <font color="#000000">n</font> <font color="#000000">==</font> <font color="#000000">p</font><font color="#000000">+</font><font color="#000000">1</font><font color="#000000">:</font>
            <font color="#000000">p</font> <font color="#000000">=</font> <font color="#000000">n</font>
        <font color="#EB5E00">elif</font> <font color="#000000">n</font> <font color="#000000">==</font> <font color="#000000">p</font><font color="#000000">:</font>
            <font color="#EB5E00">print</font> <font color="#008800">"list2range: Warning, %s occurs more than once"</font> <font color="#000000">%</font> <font color="#000000">str</font><font color="#000000">(</font><font color="#000000">n</font><font color="#000000">)</font>
            <font color="#000000">p</font> <font color="#000000">=</font> <font color="#000000">n</font>
        <font color="#EB5E00">else</font><font color="#000000">:</font>
            <font color="#EB5E00">if</font> <font color="#000000">start</font> <font color="#000000">!=</font> <font color="#000000">p</font><font color="#000000">:</font>
                <font color="#EB5E00">if</font> <font color="#000000">p</font> <font color="#000000">==</font> <font color="#000000">start</font><font color="#000000">+</font><font color="#000000">1</font><font color="#000000">:</font> <font color="#FF0000"># don't create two-item ranges (eg, '1-2')</font>
                    <font color="#000000">N</font><font color="#000000">.</font><font color="#000000">append</font><font color="#000000">(</font><font color="#000000">str</font><font color="#000000">(</font><font color="#000000">start</font><font color="#000000">)</font><font color="#000000">)</font> <font color="#000000">;</font> <font color="#000000">N</font><font color="#000000">.</font><font color="#000000">append</font><font color="#000000">(</font><font color="#000000">str</font><font color="#000000">(</font><font color="#000000">p</font><font color="#000000">)</font><font color="#000000">)</font>
                <font color="#EB5E00">else</font><font color="#000000">:</font>
                    <font color="#000000">next</font> <font color="#000000">=</font> <font color="#008800">"%s-%s"</font> <font color="#000000">%</font> <font color="#000000">(</font><font color="#000000">str</font><font color="#000000">(</font><font color="#000000">start</font><font color="#000000">)</font><font color="#000000">,</font><font color="#000000">str</font><font color="#000000">(</font><font color="#000000">p</font><font color="#000000">)</font><font color="#000000">)</font>
                    <font color="#000000">N</font><font color="#000000">.</font><font color="#000000">append</font><font color="#000000">(</font><font color="#000000">next</font><font color="#000000">)</font>
            <font color="#EB5E00">else</font><font color="#000000">:</font>
                <font color="#000000">N</font><font color="#000000">.</font><font color="#000000">append</font><font color="#000000">(</font><font color="#000000">str</font><font color="#000000">(</font><font color="#000000">start</font><font color="#000000">)</font><font color="#000000">)</font>
            <font color="#000000">start</font> <font color="#000000">=</font> <font color="#000000">n</font>
            <font color="#000000">p</font> <font color="#000000">=</font> <font color="#000000">n</font>
        <font color="#000000">fn</font> <font color="#000000">=</font> <font color="#000000">fn</font><font color="#000000">[</font><font color="#000000">1</font><font color="#000000">:</font><font color="#000000">]</font>

    <font color="#EB5E00">if</font> <font color="#000000">start</font> <font color="#000000">!=</font> <font color="#000000">n</font><font color="#000000">:</font>
        <font color="#EB5E00">if</font> <font color="#000000">n</font> <font color="#000000">==</font> <font color="#000000">start</font><font color="#000000">+</font><font color="#000000">1</font><font color="#000000">:</font>
            <font color="#000000">N</font><font color="#000000">.</font><font color="#000000">append</font><font color="#000000">(</font><font color="#000000">str</font><font color="#000000">(</font><font color="#000000">start</font><font color="#000000">)</font><font color="#000000">)</font> <font color="#000000">;</font> <font color="#000000">N</font><font color="#000000">.</font><font color="#000000">append</font><font color="#000000">(</font><font color="#000000">str</font><font color="#000000">(</font><font color="#000000">n</font><font color="#000000">)</font><font color="#000000">)</font>
        <font color="#EB5E00">else</font><font color="#000000">:</font>
            <font color="#000000">next</font> <font color="#000000">=</font> <font color="#008800">"%s-%s"</font> <font color="#000000">%</font> <font color="#000000">(</font><font color="#000000">str</font><font color="#000000">(</font><font color="#000000">start</font><font color="#000000">)</font><font color="#000000">,</font><font color="#000000">str</font><font color="#000000">(</font><font color="#000000">n</font><font color="#000000">)</font><font color="#000000">)</font>
            <font color="#000000">N</font><font color="#000000">.</font><font color="#000000">append</font><font color="#000000">(</font><font color="#000000">next</font><font color="#000000">)</font>
    <font color="#EB5E00">else</font><font color="#000000">:</font>
        <font color="#000000">N</font><font color="#000000">.</font><font color="#000000">append</font><font color="#000000">(</font><font color="#000000">str</font><font color="#000000">(</font><font color="#000000">start</font><font color="#000000">)</font><font color="#000000">)</font>

    <font color="#EB5E00">return</font> <font color="#000000">N</font>

<font color="#FF0000"># input: list of strings (output from list2range)
</font><font color="#FF0000"># output: string of concatenated items
</font><font color="#EB5E00">def</font> <font color="#0000FF">range2string</font><font color="#000000">(</font><font color="#000000">n</font><font color="#000000">)</font><font color="#000000">:</font>
    <font color="#008800">" converts ['1-4','7'] to '1-4,7' "</font>
    <font color="#EB5E00">if</font> <font color="#000000">n</font> <font color="#000000">==</font> <font color="#000000">None</font> <font color="#EB5E00">or</font> <font color="#000000">len</font><font color="#000000">(</font><font color="#000000">n</font><font color="#000000">)</font> <font color="#000000">==</font> <font color="#000000">0</font><font color="#000000">:</font>
        <font color="#EB5E00">return</font> <font color="#008800">""</font>
    <font color="#000000">s</font> <font color="#000000">=</font> <font color="#008800">""</font>
    <font color="#EB5E00">for</font> <font color="#000000">item</font> <font color="#EB5E00">in</font> <font color="#000000">n</font><font color="#000000">:</font>
        <font color="#000000">s</font> <font color="#000000">+=</font> <font color="#000000">item</font> <font color="#000000">+</font> <font color="#008800">','</font>
    <font color="#000000">s</font> <font color="#000000">=</font> <font color="#000000">s</font><font color="#000000">[</font><font color="#000000">:</font><font color="#000000">-</font><font color="#000000">1</font><font color="#000000">]</font> <font color="#FF0000"># remove trailing comma</font>
    <font color="#EB5E00">return</font> <font color="#000000">s</font>

<font color="#EB5E00">def</font> <font color="#0000FF">numberlist2string</font><font color="#000000">(</font><font color="#000000">numberlist</font><font color="#000000">)</font><font color="#000000">:</font>
    <font color="#008800">" a list of integers is converted to a string, "</font>
    <font color="#008800">" hyphenating consecutive numbers. [1,2,3,4] -&gt; '1-4' "</font>
    <font color="#000000">d</font> <font color="#000000">=</font> <font color="#000000">list2range</font><font color="#000000">(</font><font color="#000000">numberlist</font><font color="#000000">)</font>
    <font color="#EB5E00">return</font> <font color="#000000">range2string</font><font color="#000000">(</font><font color="#000000">d</font><font color="#000000">)</font>

<font color="#EB5E00">def</font> <font color="#0000FF">range2list</font><font color="#000000">(</font><font color="#000000">numberstring</font><font color="#000000">)</font><font color="#000000">:</font>
    <font color="#008800">"input string: '1-4' -&gt; output list: [1,2,3,4] "</font>
    <font color="#EB5E00">if</font> <font color="#000000">numberstring</font> <font color="#000000">==</font> <font color="#008800">""</font> <font color="#EB5E00">or</font> <font color="#000000">None</font><font color="#000000">:</font>
        <font color="#EB5E00">return</font> <font color="#000000">[</font><font color="#000000">]</font>
    <font color="#000000">L</font> <font color="#000000">=</font> <font color="#000000">numberstring</font><font color="#000000">.</font><font color="#000000">split</font><font color="#000000">(</font><font color="#008800">','</font><font color="#000000">)</font>
    <font color="#000000">K</font> <font color="#000000">=</font> <font color="#000000">[</font><font color="#000000">]</font>
    <font color="#EB5E00">for</font> <font color="#000000">item</font> <font color="#EB5E00">in</font> <font color="#000000">L</font><font color="#000000">:</font>
        <font color="#EB5E00">if</font> <font color="#000000">item</font><font color="#000000">.</font><font color="#000000">find</font><font color="#000000">(</font><font color="#008800">'-'</font><font color="#000000">)</font> <font color="#000000">&gt;</font> <font color="#000000">-</font><font color="#000000">1</font><font color="#000000">:</font>
            <font color="#000000">xlist</font> <font color="#000000">=</font> <font color="#000000">item</font><font color="#000000">.</font><font color="#000000">split</font><font color="#000000">(</font><font color="#008800">'-'</font><font color="#000000">)</font>
            <font color="#000000">start</font> <font color="#000000">=</font> <font color="#000000">int</font><font color="#000000">(</font><font color="#000000">xlist</font><font color="#000000">[</font><font color="#000000">0</font><font color="#000000">]</font><font color="#000000">)</font>
            <font color="#000000">end</font> <font color="#000000">=</font> <font color="#000000">int</font><font color="#000000">(</font><font color="#000000">xlist</font><font color="#000000">[</font><font color="#000000">-</font><font color="#000000">1</font><font color="#000000">]</font><font color="#000000">)</font>
            <font color="#EB5E00">for</font> <font color="#000000">i</font> <font color="#EB5E00">in</font> <font color="#000000">range</font><font color="#000000">(</font><font color="#000000">start</font><font color="#000000">,</font><font color="#000000">end</font><font color="#000000">+</font><font color="#000000">1</font><font color="#000000">)</font><font color="#000000">:</font>
                <font color="#000000">K</font><font color="#000000">.</font><font color="#000000">append</font><font color="#000000">(</font><font color="#000000">i</font><font color="#000000">)</font>
        <font color="#EB5E00">else</font><font color="#000000">:</font>
            <font color="#000000">K</font><font color="#000000">.</font><font color="#000000">append</font><font color="#000000">(</font><font color="#000000">int</font><font color="#000000">(</font><font color="#000000">item</font><font color="#000000">)</font><font color="#000000">)</font>
    <font color="#EB5E00">return</font> <font color="#000000">K</font>

<font color="#FF0000">###################################################################
</font><font color="#FF0000">#
</font><font color="#FF0000"># Checking file types
</font><font color="#FF0000">#
</font><font color="#FF0000">#     istextfile()       boolean
</font><font color="#FF0000">#     isSpiderDocFile()  boolean
</font><font color="#FF0000">#     isSpiderImage()    boolean
</font><font color="#FF0000">#     isSpiderBin()      returns "image","volume","Fourier"  or 0
</font>
<font color="#FF0000"># ------ text file functions -------------
</font>
<font color="#000000">noNumbers</font> <font color="#000000">=</font> <font color="#000000">re</font><font color="#000000">.</font><font color="#000000">compile</font><font color="#000000">(</font><font color="#008800">"[^\d^\s^\.^\+^\-Ee]"</font><font color="#000000">)</font>
<font color="#000000">text_characters</font> <font color="#000000">=</font> <font color="#008800">""</font><font color="#000000">.</font><font color="#000000">join</font><font color="#000000">(</font><font color="#000000">map</font><font color="#000000">(</font><font color="#000000">chr</font><font color="#000000">,</font> <font color="#000000">range</font><font color="#000000">(</font><font color="#000000">32</font><font color="#000000">,</font> <font color="#000000">127</font><font color="#000000">)</font><font color="#000000">)</font> <font color="#000000">+</font> <font color="#000000">list</font><font color="#000000">(</font><font color="#008800">"\n\r\t\b"</font><font color="#000000">)</font><font color="#000000">)</font>
<font color="#EB5E00">from</font> <font color="#000000">string</font> <font color="#EB5E00">import</font> <font color="#000000">maketrans</font>
<font color="#000000">_null_trans</font> <font color="#000000">=</font> <font color="#000000">maketrans</font><font color="#000000">(</font><font color="#008800">""</font><font color="#000000">,</font> <font color="#008800">""</font><font color="#000000">)</font>

<font color="#FF0000"># Applications importing this file should call istextfile, not istext,
</font><font color="#FF0000"># which is used internally.
</font><font color="#FF0000"># istextfile returns 1 for text, 0 for binary, 0 for error (not found?)
</font><font color="#FF0000"># pdf test added, cos they can get either answer.
</font><font color="#EB5E00">def</font> <font color="#0000FF">istextfile</font><font color="#000000">(</font><font color="#000000">filename</font><font color="#000000">,</font> <font color="#000000">blocksize</font> <font color="#000000">=</font> <font color="#000000">512</font><font color="#000000">)</font><font color="#000000">:</font>
    <font color="#008800">"returns 1 if input is a text file (pdf's and zero-length files are binary)"</font>
    <font color="#EB5E00">if</font> <font color="#000000">os</font><font color="#000000">.</font><font color="#000000">path</font><font color="#000000">.</font><font color="#000000">isdir</font><font color="#000000">(</font><font color="#000000">filename</font><font color="#000000">)</font><font color="#000000">:</font>
        <font color="#EB5E00">return</font> <font color="#000000">0</font>
    <font color="#000000">name</font><font color="#000000">,</font><font color="#000000">ext</font> <font color="#000000">=</font> <font color="#000000">os</font><font color="#000000">.</font><font color="#000000">path</font><font color="#000000">.</font><font color="#000000">splitext</font><font color="#000000">(</font><font color="#000000">filename</font><font color="#000000">)</font>
    <font color="#EB5E00">if</font> <font color="#000000">ext</font><font color="#000000">.</font><font color="#000000">lower</font><font color="#000000">(</font><font color="#000000">)</font> <font color="#000000">==</font> <font color="#008800">".pdf"</font><font color="#000000">:</font>
        <font color="#EB5E00">return</font> <font color="#000000">0</font>
    <font color="#EB5E00">try</font><font color="#000000">:</font>
        <font color="#000000">res</font> <font color="#000000">=</font> <font color="#000000">istext</font><font color="#000000">(</font><font color="#000000">open</font><font color="#000000">(</font><font color="#000000">filename</font><font color="#000000">)</font><font color="#000000">.</font><font color="#000000">read</font><font color="#000000">(</font><font color="#000000">blocksize</font><font color="#000000">)</font><font color="#000000">)</font>
        <font color="#EB5E00">return</font> <font color="#000000">res</font>
    <font color="#EB5E00">except</font><font color="#000000">:</font>
        <font color="#EB5E00">return</font> <font color="#000000">0</font>

<font color="#EB5E00">def</font> <font color="#0000FF">istext</font><font color="#000000">(</font><font color="#000000">s</font><font color="#000000">)</font><font color="#000000">:</font>
    <font color="#008800">"returns 1 if input is a text file (pdf's and zero-length files are binary)"</font>
    <font color="#EB5E00">if</font> <font color="#008800">"\0"</font> <font color="#EB5E00">in</font> <font color="#000000">s</font><font color="#000000">:</font>
        <font color="#EB5E00">return</font> <font color="#000000">0</font>

    <font color="#EB5E00">if</font> <font color="#EB5E00">not</font> <font color="#000000">s</font><font color="#000000">:</font>  <font color="#FF0000"># Empty files </font>
        <font color="#EB5E00">return</font> <font color="#000000">1</font>

    <font color="#FF0000"># Get the non-text characters (maps a character to itself then
</font>    <font color="#FF0000"># use the 'remove' option to get rid of the text characters.)
</font>    <font color="#000000">t</font> <font color="#000000">=</font> <font color="#000000">s</font><font color="#000000">.</font><font color="#000000">translate</font><font color="#000000">(</font><font color="#000000">_null_trans</font><font color="#000000">,</font> <font color="#000000">text_characters</font><font color="#000000">)</font>

    <font color="#FF0000"># If more than 30% non-text characters, then
</font>    <font color="#FF0000"># this is considered a binary file
</font>    <font color="#000000">ratio</font> <font color="#000000">=</font> <font color="#000000">float</font><font color="#000000">(</font><font color="#000000">len</font><font color="#000000">(</font><font color="#000000">t</font><font color="#000000">)</font><font color="#000000">)</font> <font color="#000000">/</font> <font color="#000000">float</font><font color="#000000">(</font><font color="#000000">len</font><font color="#000000">(</font><font color="#000000">s</font><font color="#000000">)</font><font color="#000000">)</font>
    <font color="#EB5E00">if</font> <font color="#000000">ratio</font> <font color="#000000">&gt;</font> <font color="#000000">0.30</font><font color="#000000">:</font>
        <font color="#EB5E00">return</font> <font color="#000000">0</font>
    <font color="#EB5E00">return</font> <font color="#000000">1</font>

<font color="#FF0000"># Quits as soon as it gets a good data line, i.e.,
</font><font color="#FF0000"># int1 int2 [floats], where no. floats = int2
</font><font color="#EB5E00">def</font> <font color="#0000FF">isSpiderDocfile</font><font color="#000000">(</font><font color="#000000">file</font><font color="#000000">)</font><font color="#000000">:</font>
    <font color="#008800">"returns 1 if input is a SPIDER document file"</font>
    <font color="#EB5E00">try</font><font color="#000000">:</font>
        <font color="#000000">fp</font> <font color="#000000">=</font> <font color="#000000">open</font><font color="#000000">(</font><font color="#000000">file</font><font color="#000000">,</font> <font color="#008800">'r'</font><font color="#000000">)</font>
    <font color="#EB5E00">except</font><font color="#000000">:</font>
        <font color="#EB5E00">print</font> <font color="#008800">'unable to open %s'</font> <font color="#000000">%</font> <font color="#000000">(</font><font color="#000000">file</font><font color="#000000">)</font>
        <font color="#EB5E00">return</font> <font color="#000000">0</font>

    <font color="#000000">comments</font> <font color="#000000">=</font> <font color="#000000">0</font>
    <font color="#000000">isDoc</font> <font color="#000000">=</font> <font color="#000000">0</font>
    <font color="#000000">blank</font> <font color="#000000">=</font> <font color="#000000">0</font>
    <font color="#EB5E00">while</font> <font color="#000000">1</font><font color="#000000">:</font>
        <font color="#000000">s</font> <font color="#000000">=</font> <font color="#000000">fp</font><font color="#000000">.</font><font color="#000000">readline</font><font color="#000000">(</font><font color="#000000">)</font>
        <font color="#EB5E00">if</font> <font color="#000000">s</font> <font color="#000000">==</font> <font color="#008800">""</font><font color="#000000">:</font>  <font color="#FF0000"># only EOF should return blank</font>
            <font color="#EB5E00">break</font>

        <font color="#EB5E00">if</font> <font color="#000000">len</font><font color="#000000">(</font><font color="#000000">s</font><font color="#000000">)</font> <font color="#000000">&gt;</font> <font color="#000000">2</font> <font color="#EB5E00">and</font> <font color="#000000">s</font><font color="#000000">[</font><font color="#000000">0</font><font color="#000000">]</font> <font color="#000000">==</font> <font color="#008800">" "</font> <font color="#EB5E00">and</font> <font color="#000000">s</font><font color="#000000">[</font><font color="#000000">1</font><font color="#000000">]</font> <font color="#000000">==</font> <font color="#008800">';'</font><font color="#000000">:</font>   <font color="#FF0000"># Spider comment line</font>
            <font color="#EB5E00">continue</font>

        <font color="#EB5E00">if</font> <font color="#000000">noNumbers</font><font color="#000000">.</font><font color="#000000">match</font><font color="#000000">(</font><font color="#000000">s</font><font color="#000000">)</font><font color="#000000">:</font>  <font color="#FF0000"># if find any nondigits, +, _ etc</font>
            <font color="#000000">isDoc</font> <font color="#000000">=</font> <font color="#000000">0</font>
            <font color="#EB5E00">break</font>

        <font color="#000000">ss</font> <font color="#000000">=</font> <font color="#000000">s</font><font color="#000000">.</font><font color="#000000">split</font><font color="#000000">(</font><font color="#000000">)</font>
        <font color="#FF0000"># test for new format: nums divided by blanks, 1st value is an int,
</font>        <font color="#EB5E00">try</font><font color="#000000">:</font>
            <font color="#000000">i</font> <font color="#000000">=</font> <font color="#000000">int</font><font color="#000000">(</font><font color="#000000">ss</font><font color="#000000">[</font><font color="#000000">0</font><font color="#000000">]</font><font color="#000000">)</font>
            <font color="#FF0000"># and there are N data columns, where N = s[1]
</font>            <font color="#000000">n</font> <font color="#000000">=</font> <font color="#000000">int</font><font color="#000000">(</font><font color="#000000">ss</font><font color="#000000">[</font><font color="#000000">1</font><font color="#000000">]</font><font color="#000000">)</font>
            <font color="#EB5E00">if</font> <font color="#000000">len</font><font color="#000000">(</font><font color="#000000">ss</font><font color="#000000">[</font><font color="#000000">2</font><font color="#000000">:</font><font color="#000000">]</font><font color="#000000">)</font> <font color="#000000">&gt;=</font> <font color="#000000">n</font><font color="#000000">:</font>
                <font color="#EB5E00">try</font><font color="#000000">:</font>
                    <font color="#000000">float</font><font color="#000000">(</font><font color="#000000">ss</font><font color="#000000">[</font><font color="#000000">2</font><font color="#000000">]</font><font color="#000000">)</font>  <font color="#FF0000"># we'll just test one</font>
                    <font color="#000000">isDoc</font> <font color="#000000">=</font> <font color="#000000">1</font>
                <font color="#EB5E00">except</font><font color="#000000">:</font>
                    <font color="#000000">isDoc</font> <font color="#000000">=</font> <font color="#000000">0</font>
                <font color="#EB5E00">break</font>         <font color="#FF0000"># then it's new (SPIDER 11.0 Feb 2004)</font>
        <font color="#EB5E00">except</font><font color="#000000">:</font>
            <font color="#EB5E00">pass</font>

        <font color="#FF0000"># see if it's the older fixed column format
</font>        <font color="#EB5E00">if</font> <font color="#000000">len</font><font color="#000000">(</font><font color="#000000">s</font><font color="#000000">)</font> <font color="#000000">&lt;</font> <font color="#000000">13</font><font color="#000000">:</font>
            <font color="#000000">isDoc</font> <font color="#000000">=</font> <font color="#000000">0</font>
            <font color="#EB5E00">break</font>
        <font color="#EB5E00">try</font><font color="#000000">:</font>
            <font color="#000000">key</font> <font color="#000000">=</font> <font color="#000000">int</font><font color="#000000">(</font><font color="#000000">s</font><font color="#000000">[</font><font color="#000000">0</font><font color="#000000">:</font><font color="#000000">6</font><font color="#000000">]</font><font color="#000000">)</font>   <font color="#FF0000"># 1st 6 chars are key</font>
            <font color="#000000">n</font> <font color="#000000">=</font> <font color="#000000">int</font><font color="#000000">(</font><font color="#000000">s</font><font color="#000000">[</font><font color="#000000">6</font><font color="#000000">]</font><font color="#000000">)</font>       <font color="#FF0000"># 7th char is N</font>
            <font color="#000000">f</font> <font color="#000000">=</font> <font color="#000000">float</font><font color="#000000">(</font><font color="#000000">s</font><font color="#000000">[</font><font color="#000000">7</font><font color="#000000">:</font><font color="#000000">13</font><font color="#000000">]</font><font color="#000000">)</font>   <font color="#FF0000"># see if there's 1 good data value</font>
            <font color="#000000">isDoc</font> <font color="#000000">=</font> <font color="#000000">1</font>
            <font color="#EB5E00">break</font>
        <font color="#EB5E00">except</font><font color="#000000">:</font>
            <font color="#000000">isDoc</font> <font color="#000000">=</font> <font color="#000000">0</font>
            <font color="#EB5E00">break</font>
    <font color="#000000">fp</font><font color="#000000">.</font><font color="#000000">close</font><font color="#000000">(</font><font color="#000000">)</font>
    <font color="#EB5E00">return</font> <font color="#000000">isDoc</font>

<font color="#EB5E00">def</font> <font color="#0000FF">stripComment</font><font color="#000000">(</font><font color="#000000">line</font><font color="#000000">,</font> <font color="#000000">strip</font><font color="#000000">=</font><font color="#000000">1</font><font color="#000000">)</font><font color="#000000">:</font>
    <font color="#008800">"removes all text after and including the 1st semicolon in a string"</font>
    <font color="#000000">n</font> <font color="#000000">=</font> <font color="#000000">line</font><font color="#000000">.</font><font color="#000000">find</font><font color="#000000">(</font><font color="#008800">";"</font><font color="#000000">)</font>
    <font color="#EB5E00">if</font> <font color="#000000">n</font> <font color="#000000">&gt;</font> <font color="#000000">-</font><font color="#000000">1</font><font color="#000000">:</font>
        <font color="#000000">line</font> <font color="#000000">=</font> <font color="#000000">line</font><font color="#000000">[</font><font color="#000000">:</font><font color="#000000">n</font><font color="#000000">]</font><font color="#000000">.</font><font color="#000000">rstrip</font><font color="#000000">(</font><font color="#000000">)</font>

    <font color="#EB5E00">if</font> <font color="#000000">strip</font><font color="#000000">:</font>
        <font color="#000000">line</font> <font color="#000000">=</font> <font color="#000000">line</font><font color="#000000">.</font><font color="#000000">strip</font><font color="#000000">(</font><font color="#000000">)</font>
    <font color="#EB5E00">return</font> <font color="#000000">line</font>

<font color="#000000">re_hdr</font> <font color="#000000">=</font> <font color="#000000">re</font><font color="#000000">.</font><font color="#000000">compile</font><font color="#000000">(</font><font color="#008800">'END +BATCH +HEADER'</font><font color="#000000">)</font>
<font color="#000000">re_reg</font> <font color="#000000">=</font> <font color="#000000">re</font><font color="#000000">.</font><font color="#000000">compile</font><font color="#000000">(</font><font color="#008800">'[xX][0-9][0-9] *='</font><font color="#000000">)</font>      <font color="#FF0000"># "x11 =" patterns</font>
<font color="#000000">re_nam</font> <font color="#000000">=</font> <font color="#000000">re</font><font color="#000000">.</font><font color="#000000">compile</font><font color="#000000">(</font><font color="#008800">'\[[ a-zA-Z0-9_-]+\] *='</font><font color="#000000">)</font> <font color="#FF0000"># "[symbol] =" patterns</font>
<font color="#000000">re_sym</font> <font color="#000000">=</font> <font color="#000000">re</font><font color="#000000">.</font><font color="#000000">compile</font><font color="#000000">(</font><font color="#008800">'\?[ \w]+\?'</font><font color="#000000">)</font>   <font color="#FF0000"># ?text? patterns</font>
<font color="#FF0000"># top line of procedures
</font><font color="#000000">re_reglist</font> <font color="#000000">=</font> <font color="#000000">re</font><font color="#000000">.</font><font color="#000000">compile</font><font color="#000000">(</font><font color="#008800">'([xX][0-9][0-9])(, *[xX][0-9][0-9])*'</font><font color="#000000">)</font> <font color="#FF0000"># x11,x12,x13</font>
<font color="#000000">re_namlist</font> <font color="#000000">=</font> <font color="#000000">re</font><font color="#000000">.</font><font color="#000000">compile</font><font color="#000000">(</font><font color="#008800">'(\[[ a-zA-Z0-9_-]+\])(, *\[[ a-zA-Z0-9_-]+\])*'</font><font color="#000000">)</font>
<font color="#000000">re_nam1</font> <font color="#000000">=</font> <font color="#000000">re</font><font color="#000000">.</font><font color="#000000">compile</font><font color="#000000">(</font><font color="#008800">'(\[[ a-zA-Z0-9_-]+\])'</font><font color="#000000">)</font>  <font color="#FF0000"># named reg in proc hdr</font>

<font color="#FF0000"># This is not really dependable - there are just too many variants to
</font><font color="#FF0000"># catch them all. Plus it may return with false positives.
</font><font color="#EB5E00">def</font> <font color="#0000FF">isSpiderBatchfile</font><font color="#000000">(</font><font color="#000000">file</font><font color="#000000">)</font><font color="#000000">:</font>
    <font color="#008800">"returns 1 if input is a SPIDER batch file"</font>
    <font color="#008800">""" only checks first few lines of text.
        Returns 1 if finds any of the following:
            ; --- End batch header ---
            "FR G/L" pattern followed by [symbol] on next line
            "x11=" register assignment pattern
            "[symbol]=" named register assignment
        Returns 2 if it thinks its a procedure, with the first line:
            [x11,x12]
            ([ang-step],[ang-limit],[radius])
            again, there are too many variants to catch them all
    """</font>
    <font color="#FF0000">#B = fileReadLines(file)        takes too long for huge text files
</font>    <font color="#FF0000">#if B == None or len(B) == 0:
</font>    <font color="#FF0000">#   return 0
</font>
    <font color="#000000">max</font> <font color="#000000">=</font> <font color="#000000">40</font>
    <font color="#000000">B</font> <font color="#000000">=</font><font color="#000000">[</font><font color="#000000">]</font>
    <font color="#000000">fp</font> <font color="#000000">=</font> <font color="#000000">open</font><font color="#000000">(</font><font color="#000000">file</font><font color="#000000">,</font><font color="#008800">'r'</font><font color="#000000">)</font>
    <font color="#EB5E00">for</font> <font color="#000000">i</font> <font color="#EB5E00">in</font> <font color="#000000">range</font><font color="#000000">(</font><font color="#000000">max</font><font color="#000000">)</font><font color="#000000">:</font>
        <font color="#EB5E00">try</font><font color="#000000">:</font>
            <font color="#000000">B</font><font color="#000000">.</font><font color="#000000">append</font><font color="#000000">(</font><font color="#000000">fp</font><font color="#000000">.</font><font color="#000000">readline</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">)</font>
        <font color="#EB5E00">except</font><font color="#000000">:</font>
            <font color="#EB5E00">pass</font>
    <font color="#000000">fp</font><font color="#000000">.</font><font color="#000000">close</font><font color="#000000">(</font><font color="#000000">)</font>

    <font color="#000000">nlines</font> <font color="#000000">=</font> <font color="#000000">len</font><font color="#000000">(</font><font color="#000000">B</font><font color="#000000">)</font>
    <font color="#EB5E00">if</font> <font color="#000000">nlines</font> <font color="#000000">&lt;</font> <font color="#000000">40</font><font color="#000000">:</font>
        <font color="#000000">max</font> <font color="#000000">=</font> <font color="#000000">nlines</font>

    <font color="#EB5E00">for</font> <font color="#000000">i</font> <font color="#EB5E00">in</font> <font color="#000000">range</font><font color="#000000">(</font><font color="#000000">max</font><font color="#000000">)</font><font color="#000000">:</font>
        <font color="#000000">line</font> <font color="#000000">=</font> <font color="#000000">B</font><font color="#000000">[</font><font color="#000000">i</font><font color="#000000">]</font>
        <font color="#EB5E00">if</font> <font color="#EB5E00">not</font> <font color="#000000">line</font><font color="#000000">:</font>
            <font color="#EB5E00">return</font> <font color="#000000">0</font>
        <font color="#EB5E00">if</font> <font color="#000000">line</font><font color="#000000">.</font><font color="#000000">find</font><font color="#000000">(</font><font color="#008800">"RESULTS FILE FLUSHED"</font><font color="#000000">)</font> <font color="#000000">&gt;</font> <font color="#000000">-</font><font color="#000000">1</font><font color="#000000">:</font>
            <font color="#EB5E00">return</font> <font color="#000000">0</font>
        <font color="#000000">line</font> <font color="#000000">=</font> <font color="#000000">line</font><font color="#000000">.</font><font color="#000000">strip</font><font color="#000000">(</font><font color="#000000">)</font>
        <font color="#000000">line</font> <font color="#000000">=</font> <font color="#000000">line</font><font color="#000000">.</font><font color="#000000">upper</font><font color="#000000">(</font><font color="#000000">)</font>
        <font color="#EB5E00">if</font> <font color="#000000">len</font><font color="#000000">(</font><font color="#000000">line</font><font color="#000000">)</font> <font color="#000000">&lt;</font> <font color="#000000">2</font><font color="#000000">:</font> <font color="#EB5E00">continue</font>

        <font color="#FF0000"># test if 1st line is a procedure call
</font>        <font color="#EB5E00">if</font> <font color="#000000">(</font><font color="#000000">line</font><font color="#000000">[</font><font color="#000000">0</font><font color="#000000">]</font><font color="#000000">==</font><font color="#008800">'['</font> <font color="#EB5E00">and</font> <font color="#000000">line</font><font color="#000000">[</font><font color="#000000">-</font><font color="#000000">1</font><font color="#000000">]</font><font color="#000000">==</font><font color="#008800">"]"</font><font color="#000000">)</font> <font color="#EB5E00">or</font> <font color="#000000">(</font><font color="#000000">line</font><font color="#000000">[</font><font color="#000000">0</font><font color="#000000">]</font><font color="#000000">==</font><font color="#008800">'('</font> <font color="#EB5E00">and</font> <font color="#000000">line</font><font color="#000000">[</font><font color="#000000">-</font><font color="#000000">1</font><font color="#000000">]</font><font color="#000000">==</font><font color="#008800">")"</font><font color="#000000">)</font><font color="#000000">:</font>
            <font color="#EB5E00">if</font> <font color="#000000">re_reglist</font><font color="#000000">.</font><font color="#000000">match</font><font color="#000000">(</font><font color="#000000">line</font><font color="#000000">[</font><font color="#000000">1</font><font color="#000000">:</font><font color="#000000">-</font><font color="#000000">1</font><font color="#000000">]</font><font color="#000000">)</font><font color="#000000">:</font>
                <font color="#EB5E00">return</font> <font color="#000000">2</font>
            <font color="#EB5E00">if</font> <font color="#000000">re_namlist</font><font color="#000000">.</font><font color="#000000">match</font><font color="#000000">(</font><font color="#000000">line</font><font color="#000000">[</font><font color="#000000">1</font><font color="#000000">:</font><font color="#000000">-</font><font color="#000000">1</font><font color="#000000">]</font><font color="#000000">)</font><font color="#000000">:</font>
                <font color="#EB5E00">return</font> <font color="#000000">2</font>

        <font color="#000000">cmd</font> <font color="#000000">=</font> <font color="#008800">""</font>
        <font color="#EB5E00">if</font> <font color="#000000">len</font><font color="#000000">(</font><font color="#000000">line</font><font color="#000000">)</font> <font color="#000000">&gt;</font> <font color="#000000">3</font><font color="#000000">:</font>
            <font color="#000000">cmd</font> <font color="#000000">=</font> <font color="#000000">line</font><font color="#000000">[</font><font color="#000000">0</font><font color="#000000">:</font><font color="#000000">4</font><font color="#000000">]</font>

        <font color="#EB5E00">if</font> <font color="#000000">len</font><font color="#000000">(</font><font color="#000000">line</font><font color="#000000">)</font> <font color="#000000">==</font> <font color="#000000">0</font><font color="#000000">:</font>
            <font color="#EB5E00">continue</font>
        <font color="#EB5E00">elif</font> <font color="#000000">re_hdr</font><font color="#000000">.</font><font color="#000000">search</font><font color="#000000">(</font><font color="#000000">line</font><font color="#000000">)</font><font color="#000000">:</font>
            <font color="#FF0000">#print "hdr: " + line
</font>            <font color="#EB5E00">return</font> <font color="#000000">1</font>
        <font color="#FF0000"># comment check must come after header check
</font>        <font color="#EB5E00">elif</font> <font color="#000000">line</font><font color="#000000">[</font><font color="#000000">0</font><font color="#000000">]</font> <font color="#000000">==</font> <font color="#008800">";"</font><font color="#000000">:</font>
            <font color="#EB5E00">if</font> <font color="#000000">line</font><font color="#000000">.</font><font color="#000000">find</font><font color="#000000">(</font><font color="#008800">'SPIDER'</font><font color="#000000">)</font> <font color="#000000">&gt;</font> <font color="#000000">-</font><font color="#000000">1</font><font color="#000000">:</font>  <font color="#FF0000"># a comment with the word 'spider'?</font>
                <font color="#EB5E00">return</font> <font color="#000000">1</font>
            <font color="#EB5E00">else</font><font color="#000000">:</font>
                <font color="#EB5E00">continue</font>
        <font color="#EB5E00">elif</font> <font color="#000000">re_reg</font><font color="#000000">.</font><font color="#000000">match</font><font color="#000000">(</font><font color="#000000">line</font><font color="#000000">)</font><font color="#000000">:</font>
            <font color="#FF0000">#print "reg: " + line
</font>            <font color="#EB5E00">return</font> <font color="#000000">1</font>
        <font color="#EB5E00">elif</font> <font color="#000000">re_nam</font><font color="#000000">.</font><font color="#000000">match</font><font color="#000000">(</font><font color="#000000">line</font><font color="#000000">)</font><font color="#000000">:</font>
            <font color="#FF0000">#print "nam: " + line
</font>            <font color="#EB5E00">return</font> <font color="#000000">1</font>
        <font color="#EB5E00">elif</font> <font color="#000000">re_sym</font><font color="#000000">.</font><font color="#000000">match</font><font color="#000000">(</font><font color="#000000">line</font><font color="#000000">)</font><font color="#000000">:</font>
            <font color="#FF0000">#print "sym: " + line
</font>            <font color="#EB5E00">return</font> <font color="#000000">1</font>
        <font color="#EB5E00">elif</font> <font color="#000000">cmd</font> <font color="#000000">==</font> <font color="#008800">"FR G"</font> <font color="#EB5E00">or</font> <font color="#000000">cmd</font> <font color="#000000">==</font> <font color="#008800">"FR L"</font><font color="#000000">:</font>
            <font color="#FF0000">#print "FR: " + line
</font>            <font color="#EB5E00">return</font> <font color="#000000">1</font>
        <font color="#EB5E00">elif</font> <font color="#000000">line</font> <font color="#000000">==</font> <font color="#008800">"FR"</font><font color="#000000">:</font>
            <font color="#000000">nextline</font> <font color="#000000">=</font> <font color="#000000">B</font><font color="#000000">[</font><font color="#000000">i</font><font color="#000000">+</font><font color="#000000">1</font><font color="#000000">]</font><font color="#000000">.</font><font color="#000000">strip</font><font color="#000000">(</font><font color="#000000">)</font>
            <font color="#EB5E00">if</font> <font color="#000000">re_sym</font><font color="#000000">.</font><font color="#000000">match</font><font color="#000000">(</font><font color="#000000">nextline</font><font color="#000000">)</font><font color="#000000">:</font>
                <font color="#EB5E00">return</font> <font color="#000000">2</font>

    <font color="#EB5E00">return</font> <font color="#000000">0</font>

<font color="#EB5E00">def</font> <font color="#0000FF">isSpiderProcedurefile</font><font color="#000000">(</font><font color="#000000">file</font><font color="#000000">)</font><font color="#000000">:</font>
    <font color="#008800">"returns 1 if input is a SPIDER procedure file"</font>
    <font color="#EB5E00">if</font> <font color="#000000">isSpiderBatchfile</font><font color="#000000">(</font><font color="#000000">file</font><font color="#000000">)</font> <font color="#000000">==</font> <font color="#000000">2</font><font color="#000000">:</font>
        <font color="#EB5E00">return</font> <font color="#000000">1</font>
    <font color="#EB5E00">else</font><font color="#000000">:</font>
        <font color="#EB5E00">return</font> <font color="#000000">0</font>

<font color="#FF0000"># ------ binary file functions -------------
</font>
<font color="#EB5E00">def</font> <font color="#0000FF">isInt</font><font color="#000000">(</font><font color="#000000">f</font><font color="#000000">)</font><font color="#000000">:</font>
    <font color="#008800">"returns 1 if input is an integer"</font>
    <font color="#EB5E00">try</font><font color="#000000">:</font>
        <font color="#000000">i</font> <font color="#000000">=</font> <font color="#000000">int</font><font color="#000000">(</font><font color="#000000">f</font><font color="#000000">)</font>
        <font color="#EB5E00">if</font> <font color="#000000">f</font><font color="#000000">-</font><font color="#000000">i</font> <font color="#000000">==</font> <font color="#000000">0</font><font color="#000000">:</font> <font color="#EB5E00">return</font> <font color="#000000">1</font>
        <font color="#EB5E00">else</font><font color="#000000">:</font>        <font color="#EB5E00">return</font> <font color="#000000">0</font>
    <font color="#EB5E00">except</font><font color="#000000">:</font>
        <font color="#EB5E00">return</font> <font color="#000000">0</font>

<font color="#000000">iforms</font> <font color="#000000">=</font> <font color="#000000">[</font><font color="#000000">1</font><font color="#000000">,</font><font color="#000000">3</font><font color="#000000">,</font><font color="#000000">-</font><font color="#000000">11</font><font color="#000000">,</font><font color="#000000">-</font><font color="#000000">12</font><font color="#000000">,</font><font color="#000000">-</font><font color="#000000">21</font><font color="#000000">,</font><font color="#000000">-</font><font color="#000000">22</font><font color="#000000">]</font>

<font color="#FF0000"># returns header tuple, if t is a valid Spider header,
</font><font color="#FF0000"># otherwise returns 0
</font><font color="#EB5E00">def</font> <font color="#0000FF">isSpiderHeader</font><font color="#000000">(</font><font color="#000000">t</font><font color="#000000">)</font><font color="#000000">:</font>
    <font color="#008800">"returns tuple of values from a valid SPIDER header, else 0"</font>
    <font color="#000000">h</font> <font color="#000000">=</font> <font color="#000000">(</font><font color="#000000">99</font><font color="#000000">,</font><font color="#000000">)</font> <font color="#000000">+</font> <font color="#000000">t</font>   <font color="#FF0000"># add 1 value so can use spider header index start=1</font>
    <font color="#FF0000"># header values 1,2,5,12,13,22,23 should be integers
</font>    <font color="#EB5E00">for</font> <font color="#000000">i</font> <font color="#EB5E00">in</font> <font color="#000000">[</font><font color="#000000">1</font><font color="#000000">,</font><font color="#000000">2</font><font color="#000000">,</font><font color="#000000">5</font><font color="#000000">,</font><font color="#000000">12</font><font color="#000000">,</font><font color="#000000">13</font><font color="#000000">,</font><font color="#000000">22</font><font color="#000000">,</font><font color="#000000">23</font><font color="#000000">]</font><font color="#000000">:</font>
        <font color="#EB5E00">if</font> <font color="#EB5E00">not</font> <font color="#000000">isInt</font><font color="#000000">(</font><font color="#000000">h</font><font color="#000000">[</font><font color="#000000">i</font><font color="#000000">]</font><font color="#000000">)</font><font color="#000000">:</font> <font color="#EB5E00">return</font> <font color="#000000">0</font>
    <font color="#FF0000"># check iform
</font>    <font color="#000000">iform</font> <font color="#000000">=</font> <font color="#000000">int</font><font color="#000000">(</font><font color="#000000">h</font><font color="#000000">[</font><font color="#000000">5</font><font color="#000000">]</font><font color="#000000">)</font>
    <font color="#EB5E00">if</font> <font color="#EB5E00">not</font> <font color="#000000">iform</font> <font color="#EB5E00">in</font> <font color="#000000">iforms</font><font color="#000000">:</font> <font color="#EB5E00">return</font> <font color="#000000">0</font>
    <font color="#FF0000"># check other header values
</font>    <font color="#000000">labrec</font> <font color="#000000">=</font> <font color="#000000">int</font><font color="#000000">(</font><font color="#000000">h</font><font color="#000000">[</font><font color="#000000">13</font><font color="#000000">]</font><font color="#000000">)</font>   <font color="#FF0000"># no. records in file header</font>
    <font color="#000000">labbyt</font> <font color="#000000">=</font> <font color="#000000">int</font><font color="#000000">(</font><font color="#000000">h</font><font color="#000000">[</font><font color="#000000">22</font><font color="#000000">]</font><font color="#000000">)</font>   <font color="#FF0000"># total no. of bytes in header</font>
    <font color="#000000">lenbyt</font> <font color="#000000">=</font> <font color="#000000">int</font><font color="#000000">(</font><font color="#000000">h</font><font color="#000000">[</font><font color="#000000">23</font><font color="#000000">]</font><font color="#000000">)</font>   <font color="#FF0000"># record length in bytes</font>
    <font color="#FF0000">#print "labrec = %d, labbyt = %d, lenbyt = %d" % (labrec,labbyt,lenbyt)
</font>    <font color="#EB5E00">if</font> <font color="#000000">labbyt</font> <font color="#000000">!=</font> <font color="#000000">(</font><font color="#000000">labrec</font> <font color="#000000">*</font> <font color="#000000">lenbyt</font><font color="#000000">)</font><font color="#000000">:</font> <font color="#EB5E00">return</font> <font color="#000000">0</font>
    <font color="#FF0000"># looks like a valid header
</font>    <font color="#EB5E00">return</font> <font color="#000000">h</font>

<font color="#FF0000"># returns "image","volume","Fourier"  or 0
</font><font color="#EB5E00">def</font> <font color="#0000FF">isSpiderBin</font><font color="#000000">(</font><font color="#000000">filename</font><font color="#000000">)</font><font color="#000000">:</font>
    <font color="#008800">"returns nonzero value if input is a SPIDER binary file"</font>
    <font color="#EB5E00">if</font> <font color="#EB5E00">not</font> <font color="#000000">os</font><font color="#000000">.</font><font color="#000000">path</font><font color="#000000">.</font><font color="#000000">exists</font><font color="#000000">(</font><font color="#000000">filename</font><font color="#000000">)</font><font color="#000000">:</font>
        <font color="#EB5E00">return</font> <font color="#000000">0</font>
    <font color="#000000">minsize</font> <font color="#000000">=</font>  <font color="#000000">27</font> <font color="#000000">*</font> <font color="#000000">4</font>  <font color="#FF0000"># 27 floating points</font>
    <font color="#EB5E00">if</font> <font color="#000000">os</font><font color="#000000">.</font><font color="#000000">path</font><font color="#000000">.</font><font color="#000000">getsize</font><font color="#000000">(</font><font color="#000000">filename</font><font color="#000000">)</font> <font color="#000000">&lt;</font> <font color="#000000">minsize</font><font color="#000000">:</font>
        <font color="#EB5E00">return</font> <font color="#000000">0</font>
    <font color="#EB5E00">try</font><font color="#000000">:</font>
        <font color="#000000">fp</font> <font color="#000000">=</font> <font color="#000000">open</font><font color="#000000">(</font><font color="#000000">filename</font><font color="#000000">,</font><font color="#008800">'rb'</font><font color="#000000">)</font>
        <font color="#000000">f</font> <font color="#000000">=</font> <font color="#000000">fp</font><font color="#000000">.</font><font color="#000000">read</font><font color="#000000">(</font><font color="#000000">minsize</font><font color="#000000">)</font>   <font color="#FF0000"># read 27 * 4 bytes</font>
        <font color="#000000">fp</font><font color="#000000">.</font><font color="#000000">close</font><font color="#000000">(</font><font color="#000000">)</font>
    <font color="#EB5E00">except</font><font color="#000000">:</font>
        <font color="#EB5E00">return</font> <font color="#000000">0</font>
    <font color="#000000">bigendian</font> <font color="#000000">=</font> <font color="#000000">1</font>
    <font color="#000000">t</font> <font color="#000000">=</font> <font color="#000000">struct</font><font color="#000000">.</font><font color="#000000">unpack</font><font color="#000000">(</font><font color="#008800">'&gt;27f'</font><font color="#000000">,</font><font color="#000000">f</font><font color="#000000">)</font>    <font color="#FF0000"># try big-endian first</font>
    <font color="#000000">hdr</font> <font color="#000000">=</font> <font color="#000000">isSpiderHeader</font><font color="#000000">(</font><font color="#000000">t</font><font color="#000000">)</font>
    <font color="#EB5E00">if</font> <font color="#000000">hdr</font> <font color="#000000">==</font> <font color="#000000">0</font><font color="#000000">:</font>
        <font color="#000000">bigendian</font> <font color="#000000">=</font> <font color="#000000">0</font>
        <font color="#000000">t</font> <font color="#000000">=</font> <font color="#000000">struct</font><font color="#000000">.</font><font color="#000000">unpack</font><font color="#000000">(</font><font color="#008800">'&lt;27f'</font><font color="#000000">,</font><font color="#000000">f</font><font color="#000000">)</font>  <font color="#FF0000"># little-endian</font>
        <font color="#000000">hdr</font> <font color="#000000">=</font> <font color="#000000">isSpiderHeader</font><font color="#000000">(</font><font color="#000000">t</font><font color="#000000">)</font>
    <font color="#EB5E00">if</font> <font color="#000000">hdr</font> <font color="#000000">==</font> <font color="#000000">0</font><font color="#000000">:</font>
        <font color="#EB5E00">return</font> <font color="#000000">0</font>

    <font color="#000000">iform</font> <font color="#000000">=</font> <font color="#000000">int</font><font color="#000000">(</font><font color="#000000">hdr</font><font color="#000000">[</font><font color="#000000">5</font><font color="#000000">]</font><font color="#000000">)</font>
    <font color="#EB5E00">if</font> <font color="#000000">iform</font> <font color="#000000">==</font> <font color="#000000">1</font><font color="#000000">:</font>
        <font color="#000000">istack</font> <font color="#000000">=</font> <font color="#000000">hdr</font><font color="#000000">[</font><font color="#000000">24</font><font color="#000000">]</font>
        <font color="#EB5E00">if</font> <font color="#000000">istack</font> <font color="#000000">==</font> <font color="#000000">0</font><font color="#000000">:</font>
            <font color="#EB5E00">return</font> <font color="#008800">"image"</font>
        <font color="#EB5E00">else</font><font color="#000000">:</font>
            <font color="#EB5E00">return</font> <font color="#008800">"stack"</font>
    <font color="#EB5E00">elif</font> <font color="#000000">iform</font> <font color="#000000">==</font> <font color="#000000">3</font><font color="#000000">:</font>
        <font color="#EB5E00">return</font> <font color="#008800">"volume"</font>
    <font color="#EB5E00">elif</font> <font color="#000000">iform</font> <font color="#EB5E00">in</font> <font color="#000000">[</font><font color="#000000">-</font><font color="#000000">11</font><font color="#000000">,</font><font color="#000000">-</font><font color="#000000">12</font><font color="#000000">,</font><font color="#000000">-</font><font color="#000000">21</font><font color="#000000">,</font><font color="#000000">-</font><font color="#000000">22</font><font color="#000000">]</font><font color="#000000">:</font>
        <font color="#EB5E00">return</font> <font color="#008800">"Fourier"</font>
    <font color="#EB5E00">else</font><font color="#000000">:</font>
        <font color="#EB5E00">return</font> <font color="#000000">0</font>

<font color="#EB5E00">def</font> <font color="#0000FF">isSpiderImage</font><font color="#000000">(</font><font color="#000000">file</font><font color="#000000">)</font><font color="#000000">:</font>
    <font color="#008800">"returns 1 if input is a SPIDER 2D image"</font>
    <font color="#EB5E00">if</font> <font color="#000000">isSpiderBin</font><font color="#000000">(</font><font color="#000000">file</font><font color="#000000">)</font> <font color="#000000">==</font> <font color="#008800">"image"</font><font color="#000000">:</font> <font color="#EB5E00">return</font> <font color="#000000">1</font>
    <font color="#EB5E00">else</font><font color="#000000">:</font> <font color="#EB5E00">return</font> <font color="#000000">0</font>

<font color="#EB5E00">def</font> <font color="#0000FF">isSpiderVolume</font><font color="#000000">(</font><font color="#000000">file</font><font color="#000000">)</font><font color="#000000">:</font>
    <font color="#008800">"returns 1 if input is a SPIDER 3D volume"</font>
    <font color="#EB5E00">if</font> <font color="#000000">isSpiderBin</font><font color="#000000">(</font><font color="#000000">file</font><font color="#000000">)</font> <font color="#000000">==</font> <font color="#008800">"volume"</font><font color="#000000">:</font> <font color="#EB5E00">return</font> <font color="#000000">1</font>
    <font color="#EB5E00">else</font><font color="#000000">:</font> <font color="#EB5E00">return</font> <font color="#000000">0</font>

<font color="#EB5E00">def</font> <font color="#0000FF">isSpiderStack</font><font color="#000000">(</font><font color="#000000">file</font><font color="#000000">)</font><font color="#000000">:</font>
    <font color="#008800">"returns 1 if input is a SPIDER stack file"</font>
    <font color="#EB5E00">if</font> <font color="#000000">isSpiderBin</font><font color="#000000">(</font><font color="#000000">file</font><font color="#000000">)</font> <font color="#000000">==</font> <font color="#008800">"stack"</font><font color="#000000">:</font> <font color="#EB5E00">return</font> <font color="#000000">1</font>
    <font color="#EB5E00">else</font><font color="#000000">:</font> <font color="#EB5E00">return</font> <font color="#000000">0</font>

<font color="#FF0000">###################################################################
</font><font color="#FF0000">#
</font><font color="#FF0000"># Utilities for finding and testing SPIDER
</font>
<font color="#EB5E00">def</font> <font color="#0000FF">testSpider</font><font color="#000000">(</font><font color="#000000">spider</font><font color="#000000">)</font><font color="#000000">:</font>
    <font color="#008800">"returns 1 if input is a working path to SPIDER"</font>
    <font color="#000000">file</font> <font color="#000000">=</font> <font color="#008800">'test6637'</font>
    <font color="#000000">ext</font> <font color="#000000">=</font> <font color="#008800">".bat"</font>
    <font color="#000000">filename</font> <font color="#000000">=</font> <font color="#000000">file</font> <font color="#000000">+</font> <font color="#000000">ext</font>
    <font color="#000000">fp</font> <font color="#000000">=</font> <font color="#000000">open</font><font color="#000000">(</font><font color="#000000">filename</font><font color="#000000">,</font> <font color="#008800">'w'</font><font color="#000000">)</font>
    <font color="#000000">fp</font><font color="#000000">.</font><font color="#000000">write</font><font color="#000000">(</font><font color="#008800">"en d\n"</font><font color="#000000">)</font>
    <font color="#000000">fp</font><font color="#000000">.</font><font color="#000000">close</font><font color="#000000">(</font><font color="#000000">)</font>
    <font color="#000000">spicmd</font> <font color="#000000">=</font> <font color="#008800">"%s bat/dat @%s"</font> <font color="#000000">%</font> <font color="#000000">(</font><font color="#000000">spider</font><font color="#000000">,</font> <font color="#000000">file</font><font color="#000000">)</font>

    <font color="#000000">success</font> <font color="#000000">=</font> <font color="#000000">0</font>
    <font color="#000000">output</font> <font color="#000000">=</font> <font color="#000000">getoutput</font><font color="#000000">(</font><font color="#000000">spicmd</font><font color="#000000">)</font>
    <font color="#EB5E00">if</font> <font color="#000000">output</font><font color="#000000">.</font><font color="#000000">find</font><font color="#000000">(</font><font color="#008800">'Results file'</font><font color="#000000">)</font> <font color="#000000">&gt;</font> <font color="#000000">0</font><font color="#000000">:</font>
        <font color="#000000">success</font> <font color="#000000">=</font> <font color="#000000">1</font>
        <font color="#000000">log</font> <font color="#000000">=</font> <font color="#008800">"LOG"</font> <font color="#000000">+</font> <font color="#000000">ext</font>
        <font color="#EB5E00">if</font> <font color="#000000">os</font><font color="#000000">.</font><font color="#000000">path</font><font color="#000000">.</font><font color="#000000">exists</font><font color="#000000">(</font><font color="#000000">log</font><font color="#000000">)</font><font color="#000000">:</font>
            <font color="#000000">os</font><font color="#000000">.</font><font color="#000000">remove</font><font color="#000000">(</font><font color="#000000">log</font><font color="#000000">)</font>
    <font color="#000000">os</font><font color="#000000">.</font><font color="#000000">remove</font><font color="#000000">(</font><font color="#000000">filename</font><font color="#000000">)</font>
    <font color="#EB5E00">return</font> <font color="#000000">success</font>

<font color="#EB5E00">def</font> <font color="#0000FF">programExists</font><font color="#000000">(</font><font color="#000000">prog</font><font color="#000000">)</font><font color="#000000">:</font>
    <font color="#008800">"a wrapper for os.path.exists that won't crash"</font>
    <font color="#EB5E00">try</font><font color="#000000">:</font>
        <font color="#EB5E00">if</font> <font color="#000000">os</font><font color="#000000">.</font><font color="#000000">path</font><font color="#000000">.</font><font color="#000000">exists</font><font color="#000000">(</font><font color="#000000">prog</font><font color="#000000">)</font><font color="#000000">:</font> <font color="#EB5E00">return</font> <font color="#000000">1</font>
        <font color="#EB5E00">else</font><font color="#000000">:</font> <font color="#EB5E00">return</font> <font color="#000000">0</font>
    <font color="#EB5E00">except</font><font color="#000000">:</font>
        <font color="#EB5E00">return</font> <font color="#000000">0</font>

<font color="#EB5E00">def</font> <font color="#0000FF">findProgram</font><font color="#000000">(</font><font color="#000000">prog</font><font color="#000000">)</font><font color="#000000">:</font>
    <font color="#008800">"Use the Unix 'which' command to find a program"</font>
    <font color="#EB5E00">if</font> <font color="#000000">os</font><font color="#000000">.</font><font color="#000000">name</font> <font color="#000000">!=</font> <font color="#008800">'posix'</font><font color="#000000">:</font>
        <font color="#EB5E00">print</font> <font color="#008800">'not a posix system: no "which" command?'</font>

    <font color="#000000">cmd</font> <font color="#000000">=</font> <font color="#008800">'which %s'</font> <font color="#000000">%</font> <font color="#000000">prog</font>
    <font color="#000000">out</font> <font color="#000000">=</font> <font color="#000000">getoutput</font><font color="#000000">(</font><font color="#000000">cmd</font><font color="#000000">)</font>
    <font color="#FF0000"># output from 'which' command may contain newlines and spaces
</font>    <font color="#EB5E00">if</font> <font color="#000000">out</font><font color="#000000">.</font><font color="#000000">find</font><font color="#000000">(</font><font color="#000000">os</font><font color="#000000">.</font><font color="#000000">linesep</font><font color="#000000">)</font> <font color="#000000">&gt;</font> <font color="#000000">-</font><font color="#000000">1</font><font color="#000000">:</font>
        <font color="#000000">lines</font> <font color="#000000">=</font> <font color="#000000">out</font><font color="#000000">.</font><font color="#000000">split</font><font color="#000000">(</font><font color="#000000">os</font><font color="#000000">.</font><font color="#000000">linesep</font><font color="#000000">)</font>
        <font color="#EB5E00">for</font> <font color="#000000">line</font> <font color="#EB5E00">in</font> <font color="#000000">lines</font><font color="#000000">:</font>
            <font color="#EB5E00">if</font> <font color="#000000">line</font><font color="#000000">.</font><font color="#000000">find</font><font color="#000000">(</font><font color="#008800">" "</font><font color="#000000">)</font> <font color="#000000">&gt;</font> <font color="#000000">-</font><font color="#000000">1</font><font color="#000000">:</font>
                <font color="#000000">d</font> <font color="#000000">=</font> <font color="#000000">line</font><font color="#000000">.</font><font color="#000000">split</font><font color="#000000">(</font><font color="#000000">)</font>
                <font color="#EB5E00">for</font> <font color="#000000">item</font> <font color="#EB5E00">in</font> <font color="#000000">d</font><font color="#000000">:</font>
                    <font color="#EB5E00">if</font> <font color="#000000">programExists</font><font color="#000000">(</font><font color="#000000">item</font><font color="#000000">)</font><font color="#000000">:</font>
                        <font color="#EB5E00">return</font> <font color="#000000">item</font>
            <font color="#EB5E00">else</font><font color="#000000">:</font>
                <font color="#EB5E00">if</font> <font color="#000000">programExists</font><font color="#000000">(</font><font color="#000000">line</font><font color="#000000">)</font><font color="#000000">:</font>
                    <font color="#EB5E00">return</font> <font color="#000000">line</font>
    <font color="#EB5E00">elif</font> <font color="#000000">out</font><font color="#000000">.</font><font color="#000000">find</font><font color="#000000">(</font><font color="#008800">" "</font><font color="#000000">)</font> <font color="#000000">&gt;</font> <font color="#000000">-</font><font color="#000000">1</font><font color="#000000">:</font>
        <font color="#000000">d</font> <font color="#000000">=</font> <font color="#000000">out</font><font color="#000000">.</font><font color="#000000">split</font><font color="#000000">(</font><font color="#000000">)</font>
        <font color="#EB5E00">print</font> <font color="#000000">d</font>
        <font color="#EB5E00">for</font> <font color="#000000">item</font> <font color="#EB5E00">in</font> <font color="#000000">d</font><font color="#000000">:</font>
            <font color="#EB5E00">if</font> <font color="#000000">programExists</font><font color="#000000">(</font><font color="#000000">item</font><font color="#000000">)</font><font color="#000000">:</font>
                <font color="#EB5E00">return</font> <font color="#000000">item</font>
    <font color="#EB5E00">else</font><font color="#000000">:</font>
        <font color="#EB5E00">if</font> <font color="#000000">programExists</font><font color="#000000">(</font><font color="#000000">out</font><font color="#000000">)</font><font color="#000000">:</font>
            <font color="#EB5E00">return</font> <font color="#000000">out</font>
    <font color="#FF0000"># failure
</font>    <font color="#EB5E00">return</font> <font color="#008800">""</font>

<font color="#EB5E00">def</font> <font color="#0000FF">findSpider</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">:</font>
    <font color="#008800">"returns path to SPIDER, or else an empty string"</font>
    <font color="#000000">spider</font> <font color="#000000">=</font> <font color="#000000">findProgram</font><font color="#000000">(</font><font color="#008800">'spider'</font><font color="#000000">)</font>
    <font color="#EB5E00">if</font> <font color="#000000">spider</font> <font color="#000000">!=</font> <font color="#008800">""</font> <font color="#EB5E00">and</font> <font color="#000000">testSpider</font><font color="#000000">(</font><font color="#000000">spider</font><font color="#000000">)</font><font color="#000000">:</font>
        <font color="#EB5E00">return</font> <font color="#000000">spider</font>
    <font color="#EB5E00">else</font><font color="#000000">:</font>
        <font color="#EB5E00">return</font> <font color="#008800">""</font>

<font color="#EB5E00">def</font> <font color="#0000FF">runSpider</font><font color="#000000">(</font><font color="#000000">spider</font><font color="#000000">,</font> <font color="#000000">batch</font><font color="#000000">,</font> <font color="#000000">dataext</font><font color="#000000">)</font><font color="#000000">:</font>
    <font color="#000000">bat</font><font color="#000000">,</font> <font color="#000000">batext</font> <font color="#000000">=</font> <font color="#000000">os</font><font color="#000000">.</font><font color="#000000">path</font><font color="#000000">.</font><font color="#000000">splitext</font><font color="#000000">(</font><font color="#000000">batch</font><font color="#000000">)</font>
    <font color="#000000">batext</font> <font color="#000000">=</font> <font color="#000000">batext</font><font color="#000000">[</font><font color="#000000">1</font><font color="#000000">:</font><font color="#000000">]</font>
    <font color="#EB5E00">if</font> <font color="#000000">dataext</font><font color="#000000">[</font><font color="#000000">0</font><font color="#000000">]</font> <font color="#000000">==</font> <font color="#008800">'.'</font><font color="#000000">:</font>
        <font color="#000000">dataext</font> <font color="#000000">=</font> <font color="#000000">dataext</font><font color="#000000">[</font><font color="#000000">1</font><font color="#000000">:</font><font color="#000000">]</font>
    <font color="#000000">cmd</font> <font color="#000000">=</font> <font color="#008800">"%s %s/%s @%s"</font> <font color="#000000">%</font> <font color="#000000">(</font><font color="#000000">spider</font><font color="#000000">,</font> <font color="#000000">batext</font><font color="#000000">,</font> <font color="#000000">dataext</font><font color="#000000">,</font> <font color="#000000">bat</font><font color="#000000">)</font>
    <font color="#000000">out</font> <font color="#000000">=</font> <font color="#000000">getoutput</font><font color="#000000">(</font><font color="#000000">cmd</font><font color="#000000">)</font>
    <font color="#EB5E00">return</font> <font color="#000000">out</font>

<font color="#FF0000">###################################################################
</font><font color="#FF0000">#
</font><font color="#FF0000"># Reading and writing the SPIDER header
</font><font color="#FF0000">#
</font><font color="#000000">SpiderHeaderDict</font> <font color="#000000">=</font> <font color="#000000">{</font> <font color="#000000">1</font> <font color="#000000">:</font> <font color="#008800">'nslice '</font><font color="#000000">,</font> <font color="#000000">2</font> <font color="#000000">:</font> <font color="#008800">'nrow '</font><font color="#000000">,</font> <font color="#000000">3</font> <font color="#000000">:</font> <font color="#008800">'irec '</font><font color="#000000">,</font> <font color="#000000">4</font> <font color="#000000">:</font> <font color="#008800">'nhistrec '</font><font color="#000000">,</font>
                     <font color="#000000">5</font> <font color="#000000">:</font> <font color="#008800">'iform '</font><font color="#000000">,</font> <font color="#000000">6</font> <font color="#000000">:</font> <font color="#008800">'imami '</font><font color="#000000">,</font> <font color="#000000">7</font> <font color="#000000">:</font> <font color="#008800">'fmax '</font><font color="#000000">,</font> <font color="#000000">8</font> <font color="#000000">:</font> <font color="#008800">'fmin '</font><font color="#000000">,</font>
                     <font color="#000000">9</font> <font color="#000000">:</font> <font color="#008800">'av '</font><font color="#000000">,</font> <font color="#000000">10</font> <font color="#000000">:</font> <font color="#008800">'sig '</font><font color="#000000">,</font> <font color="#000000">11</font> <font color="#000000">:</font> <font color="#008800">'ihist '</font><font color="#000000">,</font> <font color="#000000">12</font> <font color="#000000">:</font> <font color="#008800">'nsam '</font><font color="#000000">,</font>
                     <font color="#000000">13</font> <font color="#000000">:</font> <font color="#008800">'labrec '</font><font color="#000000">,</font> <font color="#000000">14</font> <font color="#000000">:</font> <font color="#008800">'iangle '</font><font color="#000000">,</font> <font color="#000000">15</font> <font color="#000000">:</font> <font color="#008800">'phi '</font><font color="#000000">,</font> <font color="#000000">16</font> <font color="#000000">:</font> <font color="#008800">'theta '</font><font color="#000000">,</font>
                     <font color="#000000">17</font> <font color="#000000">:</font> <font color="#008800">'gamma '</font><font color="#000000">,</font><font color="#000000">18</font> <font color="#000000">:</font> <font color="#008800">'xoff '</font><font color="#000000">,</font><font color="#000000">19</font> <font color="#000000">:</font> <font color="#008800">'yoff '</font><font color="#000000">,</font><font color="#000000">20</font> <font color="#000000">:</font> <font color="#008800">'zoff '</font><font color="#000000">,</font>
                     <font color="#000000">21</font> <font color="#000000">:</font> <font color="#008800">'scale '</font><font color="#000000">,</font> <font color="#000000">22</font> <font color="#000000">:</font> <font color="#008800">'labbyt '</font><font color="#000000">,</font> <font color="#000000">23</font> <font color="#000000">:</font> <font color="#008800">'lenbyt '</font><font color="#000000">,</font> <font color="#000000">24</font> <font color="#000000">:</font> <font color="#008800">'istack '</font><font color="#000000">,</font>
                     <font color="#000000">25</font> <font color="#000000">:</font> <font color="#008800">'NOTUSED '</font><font color="#000000">,</font> <font color="#000000">26</font> <font color="#000000">:</font> <font color="#008800">'maxim '</font><font color="#000000">,</font> <font color="#000000">27</font> <font color="#000000">:</font> <font color="#008800">'imgnum '</font><font color="#000000">,</font> <font color="#000000">28</font> <font color="#000000">:</font> <font color="#008800">'lastindx '</font><font color="#000000">,</font>
                     <font color="#000000">29</font> <font color="#000000">:</font> <font color="#008800">'unused '</font><font color="#000000">,</font> <font color="#000000">30</font> <font color="#000000">:</font> <font color="#008800">'unused '</font><font color="#000000">,</font> <font color="#000000">31</font> <font color="#000000">:</font> <font color="#008800">'Kangle '</font><font color="#000000">,</font> <font color="#000000">32</font> <font color="#000000">:</font> <font color="#008800">'phi1 '</font><font color="#000000">,</font>
                     <font color="#000000">33</font> <font color="#000000">:</font> <font color="#008800">'theta1 '</font><font color="#000000">,</font> <font color="#000000">34</font> <font color="#000000">:</font> <font color="#008800">'psi1 '</font><font color="#000000">,</font> <font color="#000000">35</font> <font color="#000000">:</font> <font color="#008800">'phi2 '</font><font color="#000000">,</font> <font color="#000000">36</font> <font color="#000000">:</font> <font color="#008800">'theta2 '</font><font color="#000000">,</font>
                     <font color="#000000">37</font> <font color="#000000">:</font> <font color="#008800">'psi2 '</font><font color="#000000">}</font>

<font color="#FF0000"># item[0] (bigendian flag) is not part of the Spider header. It is added
</font><font color="#FF0000"># so that SPIDER indices (starting with 1) may be used.
</font><font color="#FF0000"># hdr is the array returned by getSpiderHeader.
</font><font color="#EB5E00">class</font> <font color="#000000">SpiderHeaderClass</font><font color="#000000">:</font>
    <font color="#EB5E00">def</font> <font color="#0000FF">__init__</font><font color="#000000">(</font><font color="#000000">self</font><font color="#000000">,</font> <font color="#000000">hdr</font><font color="#000000">)</font><font color="#000000">:</font>
        <font color="#000000">self</font><font color="#000000">.</font><font color="#000000">header</font> <font color="#000000">=</font> <font color="#000000">hdr</font>
        <font color="#000000">self</font><font color="#000000">.</font><font color="#000000">hdrlen</font> <font color="#000000">=</font> <font color="#000000">len</font><font color="#000000">(</font><font color="#000000">hdr</font><font color="#000000">)</font>
        <font color="#000000">self</font><font color="#000000">.</font><font color="#000000">bigendian</font> <font color="#000000">=</font> <font color="#000000">hdr</font><font color="#000000">[</font><font color="#000000">0</font><font color="#000000">]</font>

        <font color="#EB5E00">for</font> <font color="#000000">i</font> <font color="#EB5E00">in</font> <font color="#000000">range</font><font color="#000000">(</font><font color="#000000">1</font><font color="#000000">,</font> <font color="#000000">self</font><font color="#000000">.</font><font color="#000000">hdrlen</font><font color="#000000">)</font><font color="#000000">:</font>
            <font color="#EB5E00">if</font> <font color="#000000">i</font> <font color="#EB5E00">in</font> <font color="#000000">SpiderHeaderDict</font><font color="#000000">:</font>
                <font color="#000000">name</font> <font color="#000000">=</font> <font color="#000000">SpiderHeaderDict</font><font color="#000000">[</font><font color="#000000">i</font><font color="#000000">]</font>
                <font color="#EB5E00">if</font> <font color="#000000">name</font> <font color="#EB5E00">in</font> <font color="#000000">[</font><font color="#008800">'NOTUSED'</font><font color="#000000">,</font> <font color="#008800">'unused'</font><font color="#000000">]</font><font color="#000000">:</font>
                   <font color="#EB5E00">continue</font>
                <font color="#000000">val</font> <font color="#000000">=</font> <font color="#000000">hdr</font><font color="#000000">[</font><font color="#000000">i</font><font color="#000000">]</font>
                <font color="#000000">s</font> <font color="#000000">=</font> <font color="#008800">"self.%s = %f"</font> <font color="#000000">%</font> <font color="#000000">(</font><font color="#000000">name</font><font color="#000000">,</font> <font color="#000000">val</font><font color="#000000">)</font>
                <font color="#EB5E00">exec</font><font color="#000000">(</font><font color="#000000">s</font><font color="#000000">)</font>

        <font color="#EB5E00">if</font> <font color="#000000">self</font><font color="#000000">.</font><font color="#000000">hdrlen</font> <font color="#000000">&gt;</font> <font color="#000000">9</font><font color="#000000">:</font>
            <font color="#000000">self</font><font color="#000000">.</font><font color="#000000">avg</font> <font color="#000000">=</font> <font color="#000000">hdr</font><font color="#000000">[</font><font color="#000000">9</font><font color="#000000">]</font>  <font color="#FF0000"># alternate access format</font>
        <font color="#EB5E00">if</font> <font color="#000000">self</font><font color="#000000">.</font><font color="#000000">hdrlen</font> <font color="#000000">&gt;</font> <font color="#000000">31</font><font color="#000000">:</font>
            <font color="#000000">self</font><font color="#000000">.</font><font color="#000000">kangle</font>  <font color="#000000">=</font> <font color="#000000">hdr</font><font color="#000000">[</font><font color="#000000">31</font><font color="#000000">]</font>

<font color="#FF0000"># Create a SPIDER header for binary files
</font><font color="#EB5E00">def</font> <font color="#0000FF">makeSpiderHeader</font><font color="#000000">(</font><font color="#000000">dims</font><font color="#000000">)</font><font color="#000000">:</font>
    <font color="#008800">" dims must be (nsam, nrow), or (nsam, nrow, nslice) "</font>
    <font color="#EB5E00">if</font> <font color="#000000">len</font><font color="#000000">(</font><font color="#000000">dims</font><font color="#000000">)</font> <font color="#000000">==</font> <font color="#000000">2</font><font color="#000000">:</font>
        <font color="#000000">nsam</font><font color="#000000">,</font> <font color="#000000">nrow</font> <font color="#000000">=</font> <font color="#000000">dims</font><font color="#000000">[</font><font color="#000000">0</font><font color="#000000">]</font><font color="#000000">,</font> <font color="#000000">dims</font><font color="#000000">[</font><font color="#000000">1</font><font color="#000000">]</font>
        <font color="#000000">nslice</font> <font color="#000000">=</font> <font color="#000000">1.0</font>
        <font color="#000000">iform</font> <font color="#000000">=</font> <font color="#000000">1.0</font>
        <font color="#000000">isVolume</font> <font color="#000000">=</font> <font color="#000000">0</font>
    <font color="#EB5E00">elif</font> <font color="#000000">len</font><font color="#000000">(</font><font color="#000000">dims</font><font color="#000000">)</font> <font color="#000000">==</font> <font color="#000000">3</font><font color="#000000">:</font>
        <font color="#000000">nsam</font><font color="#000000">,</font> <font color="#000000">nrow</font><font color="#000000">,</font> <font color="#000000">nslice</font> <font color="#000000">=</font> <font color="#000000">dims</font><font color="#000000">[</font><font color="#000000">0</font><font color="#000000">]</font><font color="#000000">,</font> <font color="#000000">dims</font><font color="#000000">[</font><font color="#000000">1</font><font color="#000000">]</font><font color="#000000">,</font> <font color="#000000">dims</font><font color="#000000">[</font><font color="#000000">2</font><font color="#000000">]</font>
        <font color="#000000">iform</font> <font color="#000000">=</font> <font color="#000000">3.0</font>
        <font color="#000000">isVolume</font> <font color="#000000">=</font> <font color="#000000">1</font>
    <font color="#EB5E00">else</font><font color="#000000">:</font>
        <font color="#EB5E00">return</font> <font color="#000000">[</font><font color="#000000">]</font>

    <font color="#000000">lenbyt</font> <font color="#000000">=</font> <font color="#000000">nsam</font> <font color="#000000">*</font> <font color="#000000">4</font>  <font color="#FF0000"># There are labrec records in the header</font>
    <font color="#000000">labrec</font> <font color="#000000">=</font> <font color="#000000">1024</font> <font color="#000000">/</font> <font color="#000000">lenbyt</font>
    <font color="#EB5E00">if</font> <font color="#000000">1024</font><font color="#000000">%</font><font color="#000000">lenbyt</font> <font color="#000000">!=</font> <font color="#000000">0</font><font color="#000000">:</font> <font color="#000000">labrec</font> <font color="#000000">+=</font> <font color="#000000">1</font>
    <font color="#000000">labbyt</font> <font color="#000000">=</font> <font color="#000000">labrec</font> <font color="#000000">*</font> <font color="#000000">lenbyt</font>
    <font color="#000000">hdr</font> <font color="#000000">=</font> <font color="#000000">[</font><font color="#000000">]</font>
    <font color="#000000">nvalues</font> <font color="#000000">=</font> <font color="#000000">labbyt</font> <font color="#000000">/</font> <font color="#000000">4</font>
    <font color="#EB5E00">for</font> <font color="#000000">i</font> <font color="#EB5E00">in</font> <font color="#000000">range</font><font color="#000000">(</font><font color="#000000">nvalues</font><font color="#000000">)</font><font color="#000000">:</font>
        <font color="#000000">hdr</font><font color="#000000">.</font><font color="#000000">append</font><font color="#000000">(</font><font color="#000000">0.0</font><font color="#000000">)</font>

    <font color="#EB5E00">if</font> <font color="#000000">len</font><font color="#000000">(</font><font color="#000000">hdr</font><font color="#000000">)</font> <font color="#000000">&lt;</font> <font color="#000000">23</font><font color="#000000">:</font>
        <font color="#EB5E00">return</font> <font color="#000000">[</font><font color="#000000">]</font>

    <font color="#FF0000"># NB these are Fortran indices
</font>    <font color="#000000">hdr</font><font color="#000000">[</font><font color="#000000">1</font><font color="#000000">]</font>  <font color="#000000">=</font> <font color="#000000">float</font><font color="#000000">(</font><font color="#000000">nslice</font><font color="#000000">)</font> <font color="#FF0000"># nslice (=1 for an image) </font>
    <font color="#000000">hdr</font><font color="#000000">[</font><font color="#000000">2</font><font color="#000000">]</font>  <font color="#000000">=</font> <font color="#000000">float</font><font color="#000000">(</font><font color="#000000">nrow</font><font color="#000000">)</font>   <font color="#FF0000"># number of rows per slice</font>
    <font color="#000000">hdr</font><font color="#000000">[</font><font color="#000000">5</font><font color="#000000">]</font>  <font color="#000000">=</font> <font color="#000000">iform</font>         <font color="#FF0000"># iform for 2D image</font>
    <font color="#000000">hdr</font><font color="#000000">[</font><font color="#000000">12</font><font color="#000000">]</font> <font color="#000000">=</font> <font color="#000000">float</font><font color="#000000">(</font><font color="#000000">nsam</font><font color="#000000">)</font>   <font color="#FF0000"># number of pixels per line</font>
    <font color="#000000">hdr</font><font color="#000000">[</font><font color="#000000">13</font><font color="#000000">]</font> <font color="#000000">=</font> <font color="#000000">float</font><font color="#000000">(</font><font color="#000000">labrec</font><font color="#000000">)</font> <font color="#FF0000"># number of records in file header</font>
    <font color="#000000">hdr</font><font color="#000000">[</font><font color="#000000">22</font><font color="#000000">]</font> <font color="#000000">=</font> <font color="#000000">float</font><font color="#000000">(</font><font color="#000000">labbyt</font><font color="#000000">)</font> <font color="#FF0000"># total number of bytes in header</font>
    <font color="#000000">hdr</font><font color="#000000">[</font><font color="#000000">23</font><font color="#000000">]</font> <font color="#000000">=</font> <font color="#000000">float</font><font color="#000000">(</font><font color="#000000">lenbyt</font><font color="#000000">)</font> <font color="#FF0000"># record length in bytes</font>

    <font color="#FF0000"># adjust for Fortran indexing
</font>    <font color="#000000">hdr</font> <font color="#000000">=</font> <font color="#000000">hdr</font><font color="#000000">[</font><font color="#000000">1</font><font color="#000000">:</font><font color="#000000">]</font>
    <font color="#000000">hdr</font><font color="#000000">.</font><font color="#000000">append</font><font color="#000000">(</font><font color="#000000">0.0</font><font color="#000000">)</font>
    <font color="#FF0000"># pack binary data into a string
</font>    <font color="#000000">hdrstr</font> <font color="#000000">=</font> <font color="#000000">[</font><font color="#000000">]</font>
    <font color="#EB5E00">for</font> <font color="#000000">v</font> <font color="#EB5E00">in</font> <font color="#000000">hdr</font><font color="#000000">:</font>
        <font color="#000000">hdrstr</font><font color="#000000">.</font><font color="#000000">append</font><font color="#000000">(</font><font color="#000000">struct</font><font color="#000000">.</font><font color="#000000">pack</font><font color="#000000">(</font><font color="#008800">'f'</font><font color="#000000">,</font><font color="#000000">v</font><font color="#000000">)</font><font color="#000000">)</font>
    <font color="#EB5E00">return</font> <font color="#000000">hdrstr</font>

<font color="#EB5E00">def</font> <font color="#0000FF">getSpiderHeader</font><font color="#000000">(</font><font color="#000000">filename</font><font color="#000000">,</font> <font color="#000000">n</font><font color="#000000">=</font><font color="#000000">27</font><font color="#000000">)</font><font color="#000000">:</font>
    <font color="#008800">" returns first n numbers, with Spider indices (starting at 1)"</font>
    <font color="#008800">" if n = 'all', returns entire header "</font>
    <font color="#EB5E00">if</font> <font color="#EB5E00">not</font> <font color="#000000">os</font><font color="#000000">.</font><font color="#000000">path</font><font color="#000000">.</font><font color="#000000">exists</font><font color="#000000">(</font><font color="#000000">filename</font><font color="#000000">)</font><font color="#000000">:</font>
        <font color="#EB5E00">return</font> <font color="#000000">0</font>
    <font color="#000000">getall</font> <font color="#000000">=</font> <font color="#000000">0</font>
    <font color="#EB5E00">if</font> <font color="#EB5E00">not</font> <font color="#000000">isInt</font><font color="#000000">(</font><font color="#000000">n</font><font color="#000000">)</font><font color="#000000">:</font>
        <font color="#000000">n</font> <font color="#000000">=</font> <font color="#000000">27</font>
        <font color="#000000">getall</font> <font color="#000000">=</font> <font color="#000000">1</font>
    <font color="#000000">nwords</font> <font color="#000000">=</font> <font color="#000000">n</font> <font color="#000000">*</font> <font color="#000000">4</font>  <font color="#FF0000"># no. floating point words </font>

    <font color="#EB5E00">if</font> <font color="#000000">os</font><font color="#000000">.</font><font color="#000000">path</font><font color="#000000">.</font><font color="#000000">getsize</font><font color="#000000">(</font><font color="#000000">filename</font><font color="#000000">)</font> <font color="#000000">&lt;</font> <font color="#000000">nwords</font><font color="#000000">:</font>
        <font color="#EB5E00">return</font> <font color="#000000">0</font>
    <font color="#EB5E00">try</font><font color="#000000">:</font>
        <font color="#000000">fp</font> <font color="#000000">=</font> <font color="#000000">open</font><font color="#000000">(</font><font color="#000000">filename</font><font color="#000000">,</font><font color="#008800">'rb'</font><font color="#000000">)</font>
        <font color="#000000">f</font> <font color="#000000">=</font> <font color="#000000">fp</font><font color="#000000">.</font><font color="#000000">read</font><font color="#000000">(</font><font color="#000000">nwords</font><font color="#000000">)</font>   <font color="#FF0000"># read 27 * 4 bytes</font>
        <font color="#000000">fp</font><font color="#000000">.</font><font color="#000000">close</font><font color="#000000">(</font><font color="#000000">)</font>
    <font color="#EB5E00">except</font><font color="#000000">:</font>
        <font color="#EB5E00">return</font> <font color="#000000">0</font>
    <font color="#000000">bigendian</font> <font color="#000000">=</font> <font color="#000000">1</font>
    <font color="#000000">bigformat</font> <font color="#000000">=</font> <font color="#008800">'&gt;%df'</font> <font color="#000000">%</font> <font color="#000000">n</font>
    <font color="#000000">t</font> <font color="#000000">=</font> <font color="#000000">struct</font><font color="#000000">.</font><font color="#000000">unpack</font><font color="#000000">(</font><font color="#000000">bigformat</font><font color="#000000">,</font><font color="#000000">f</font><font color="#000000">)</font>    <font color="#FF0000"># try big-endian first</font>
    <font color="#000000">hdr</font> <font color="#000000">=</font> <font color="#000000">isSpiderHeader</font><font color="#000000">(</font><font color="#000000">t</font><font color="#000000">)</font>
    <font color="#EB5E00">if</font> <font color="#000000">hdr</font> <font color="#000000">==</font> <font color="#000000">0</font><font color="#000000">:</font>
        <font color="#000000">bigendian</font> <font color="#000000">=</font> <font color="#000000">0</font>
        <font color="#000000">littleformat</font> <font color="#000000">=</font> <font color="#008800">"&lt;%df"</font> <font color="#000000">%</font> <font color="#000000">n</font>
        <font color="#000000">t</font> <font color="#000000">=</font> <font color="#000000">struct</font><font color="#000000">.</font><font color="#000000">unpack</font><font color="#000000">(</font><font color="#000000">littleformat</font><font color="#000000">,</font><font color="#000000">f</font><font color="#000000">)</font>  <font color="#FF0000"># little-endian</font>
        <font color="#000000">hdr</font> <font color="#000000">=</font> <font color="#000000">isSpiderHeader</font><font color="#000000">(</font><font color="#000000">t</font><font color="#000000">)</font>

    <font color="#EB5E00">if</font> <font color="#000000">hdr</font> <font color="#000000">==</font> <font color="#000000">0</font><font color="#000000">:</font>
        <font color="#EB5E00">return</font> <font color="#000000">0</font>
    <font color="#EB5E00">else</font><font color="#000000">:</font>
        <font color="#FF0000"># check if user requested the entire header
</font>        <font color="#EB5E00">if</font> <font color="#000000">getall</font><font color="#000000">:</font>
            <font color="#000000">labbyt</font> <font color="#000000">=</font> <font color="#000000">int</font><font color="#000000">(</font><font color="#000000">hdr</font><font color="#000000">[</font><font color="#000000">22</font><font color="#000000">]</font><font color="#000000">)</font>   <font color="#FF0000"># total no. of bytes in header</font>
            <font color="#000000">hdr</font> <font color="#000000">=</font> <font color="#000000">getSpiderHeader</font><font color="#000000">(</font><font color="#000000">filename</font><font color="#000000">,</font> <font color="#000000">n</font><font color="#000000">=</font><font color="#000000">labbyt</font><font color="#000000">)</font>
        <font color="#000000">hdr</font> <font color="#000000">=</font> <font color="#000000">list</font><font color="#000000">(</font><font color="#000000">hdr</font><font color="#000000">)</font>
        <font color="#000000">hdr</font><font color="#000000">[</font><font color="#000000">0</font><font color="#000000">]</font> <font color="#000000">=</font> <font color="#000000">bigendian</font>
        <font color="#EB5E00">return</font> <font color="#000000">hdr</font>


<font color="#FF0000"># returns [type,  (dimensions), and if there are any,(stats) ]
</font><font color="#FF0000"># where type = "image","volume","Fourier","stack" (but only for image stacks)
</font><font color="#FF0000"># or returns 0
</font><font color="#EB5E00">def</font> <font color="#0000FF">spiderInfo</font><font color="#000000">(</font><font color="#000000">filename</font><font color="#000000">)</font><font color="#000000">:</font>
    <font color="#EB5E00">if</font> <font color="#EB5E00">not</font> <font color="#000000">os</font><font color="#000000">.</font><font color="#000000">path</font><font color="#000000">.</font><font color="#000000">exists</font><font color="#000000">(</font><font color="#000000">filename</font><font color="#000000">)</font><font color="#000000">:</font>
        <font color="#EB5E00">return</font> <font color="#000000">0</font>

    <font color="#000000">type</font> <font color="#000000">=</font> <font color="#000000">isSpiderBin</font><font color="#000000">(</font><font color="#000000">filename</font><font color="#000000">)</font>
    <font color="#EB5E00">if</font> <font color="#000000">type</font> <font color="#000000">==</font> <font color="#000000">0</font><font color="#000000">:</font>
        <font color="#EB5E00">return</font> <font color="#000000">0</font>
    <font color="#000000">hdr</font> <font color="#000000">=</font> <font color="#000000">getSpiderHeader</font><font color="#000000">(</font><font color="#000000">filename</font><font color="#000000">)</font>  <font color="#FF0000"># header with Spider indices (starting at 1)</font>
    <font color="#000000">info</font> <font color="#000000">=</font> <font color="#000000">getSpiderInfo</font><font color="#000000">(</font><font color="#000000">hdr</font><font color="#000000">)</font>
    <font color="#EB5E00">return</font> <font color="#000000">[</font><font color="#000000">type</font><font color="#000000">]</font> <font color="#000000">+</font> <font color="#000000">info</font>

<font color="#FF0000"># return [ (dimensions), (stats) ]  
</font><font color="#EB5E00">def</font> <font color="#0000FF">getSpiderInfo</font><font color="#000000">(</font><font color="#000000">h</font><font color="#000000">)</font><font color="#000000">:</font>
    <font color="#008800">" assumes its a valid header "</font>
    <font color="#FF0000">#h = (99,) + t   
</font>    <font color="#000000">nsam</font> <font color="#000000">=</font> <font color="#000000">int</font><font color="#000000">(</font><font color="#000000">h</font><font color="#000000">[</font><font color="#000000">12</font><font color="#000000">]</font><font color="#000000">)</font>
    <font color="#000000">nrow</font> <font color="#000000">=</font> <font color="#000000">int</font><font color="#000000">(</font><font color="#000000">h</font><font color="#000000">[</font><font color="#000000">2</font><font color="#000000">]</font><font color="#000000">)</font>
    <font color="#000000">nslice</font> <font color="#000000">=</font> <font color="#000000">int</font><font color="#000000">(</font><font color="#000000">h</font><font color="#000000">[</font><font color="#000000">1</font><font color="#000000">]</font><font color="#000000">)</font>
    <font color="#000000">iform</font> <font color="#000000">=</font> <font color="#000000">int</font><font color="#000000">(</font><font color="#000000">h</font><font color="#000000">[</font><font color="#000000">5</font><font color="#000000">]</font><font color="#000000">)</font>

    <font color="#000000">dim2D</font> <font color="#000000">=</font> <font color="#000000">[</font><font color="#000000">1</font><font color="#000000">,</font> <font color="#000000">-</font><font color="#000000">11</font><font color="#000000">,</font> <font color="#000000">-</font><font color="#000000">12</font><font color="#000000">]</font>
    <font color="#000000">dim3D</font> <font color="#000000">=</font> <font color="#000000">[</font><font color="#000000">3</font><font color="#000000">,</font> <font color="#000000">-</font><font color="#000000">21</font><font color="#000000">,</font> <font color="#000000">-</font><font color="#000000">22</font><font color="#000000">]</font>
    <font color="#EB5E00">if</font> <font color="#000000">iform</font> <font color="#EB5E00">in</font> <font color="#000000">dim3D</font><font color="#000000">:</font>
        <font color="#000000">dims</font> <font color="#000000">=</font> <font color="#000000">(</font><font color="#000000">nsam</font><font color="#000000">,</font> <font color="#000000">nrow</font><font color="#000000">,</font> <font color="#000000">nslice</font><font color="#000000">)</font>
    <font color="#EB5E00">else</font><font color="#000000">:</font>
        <font color="#000000">dims</font> <font color="#000000">=</font> <font color="#000000">(</font><font color="#000000">nsam</font><font color="#000000">,</font> <font color="#000000">nrow</font><font color="#000000">)</font>

    <font color="#000000">imami</font> <font color="#000000">=</font> <font color="#000000">int</font><font color="#000000">(</font><font color="#000000">h</font><font color="#000000">[</font><font color="#000000">6</font><font color="#000000">]</font><font color="#000000">)</font>
    <font color="#EB5E00">if</font> <font color="#000000">imami</font> <font color="#000000">!=</font> <font color="#000000">0</font><font color="#000000">:</font>
        <font color="#000000">max</font> <font color="#000000">=</font> <font color="#000000">float</font><font color="#000000">(</font><font color="#000000">h</font><font color="#000000">[</font><font color="#000000">7</font><font color="#000000">]</font><font color="#000000">)</font>
        <font color="#000000">min</font> <font color="#000000">=</font> <font color="#000000">float</font><font color="#000000">(</font><font color="#000000">h</font><font color="#000000">[</font><font color="#000000">8</font><font color="#000000">]</font><font color="#000000">)</font>
        <font color="#000000">avg</font> <font color="#000000">=</font> <font color="#000000">float</font><font color="#000000">(</font><font color="#000000">h</font><font color="#000000">[</font><font color="#000000">9</font><font color="#000000">]</font><font color="#000000">)</font>
        <font color="#000000">std</font> <font color="#000000">=</font> <font color="#000000">float</font><font color="#000000">(</font><font color="#000000">h</font><font color="#000000">[</font><font color="#000000">10</font><font color="#000000">]</font><font color="#000000">)</font>
        <font color="#000000">stats</font> <font color="#000000">=</font> <font color="#000000">(</font><font color="#000000">max</font><font color="#000000">,</font> <font color="#000000">min</font><font color="#000000">,</font> <font color="#000000">avg</font><font color="#000000">,</font> <font color="#000000">std</font><font color="#000000">)</font>
        <font color="#EB5E00">return</font> <font color="#000000">[</font><font color="#000000">dims</font><font color="#000000">,</font> <font color="#000000">stats</font><font color="#000000">]</font>
    <font color="#EB5E00">else</font><font color="#000000">:</font>
        <font color="#EB5E00">return</font> <font color="#000000">[</font><font color="#000000">dims</font><font color="#000000">]</font><font color="#000000"></font></font></pre></body></html>