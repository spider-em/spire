; randangles: generate random Eulerian angles 

; To generate random points on the surface of the sphere, generate two
;  random numbers, z between -R and R (R = radius), and p between 0 and
;  2 pi, each with a uniform distribution. 
;     latitude (theta) = arcsin(z/R)
;     longitude (phi) = p
;
; NB, SPIDER operation PJ 3Q expects order: psi, theta, phi

; [psi]: 0..360    (in-plane rotation)
; [theta]: 0..90   
; [phi]: 0..360  
; [z]: -R..R , where R = radius, = 57.29578 (units of distance are degrees)

[np] = 12    ; number of particles

[max_shift] = 2  ; maximum amount of shift

[use_psi] = 1  ; if 1, psi varies (0..360); if 0, all psi set to 0

; ----- output files -----

FR G
[angles]angles    ; output list of randomly generated angles

; ------------- END BATCH HEADER ------------------------

DE
[angles]

SD /        PSI          THETA        PHI        X SHIFT      Y SHIFT
[angles]

x66 = 57.29578  ; units of distance are degrees, circumference = 360 units

DO LB1 x11 = 1,[np]

[psi] = 0
IF ([use_psi].GT.0) THEN
   [psi] = RAN([use_psi])
   [psi] = [psi] * 360     ; psi 0..360
ENDIF

[z] = RAN(x99)
[z] = [z] * x66         ; z : 0..R
[theta] = ASI([z]/x66)  ; theta = arcsin(z/R)
[theta] = 90 - [theta]  ; In SPIDER, zero degrees are at N. pole, not equator

[phi] = RAN(x99)
[phi] = [phi] * 360    ; phi 0..360

; generate the shifts
[xs] = RAN(x99) * 2 * [max_shift]
[xs] = [xs] - [max_shift]
[ys] = RAN(x99) * 2 * [max_shift]
[ys] = [ys] - [max_shift]

SD x11,[psi],[theta],[phi],[xs],[ys]
[angles]

LB1

EN D